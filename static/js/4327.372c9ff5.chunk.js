"use strict";(self.webpackChunkuums_front_end=self.webpackChunkuums_front_end||[]).push([[4327],{97613:function(e,t,n){n.d(t,{Z:function(){return b}});var i=n(15671),r=n(43144),o=n(60136),a=n(29388),s=n(27366),l=n(84314),u=n(85015),c=n(11582),v=n(46784),d=n(92026),p=n(49861),h=(n(63780),n(93169),n(25243),n(69912)),f=n(66576),y=n(7882),g=n(64575),_=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).position=null,r.elevationInfo=null,r.feature=null,r}return(0,r.Z)(n,[{key:"equals",value:function(e){return(0,d._W)(this.position,e.position)&&(0,d._W)(this.elevationInfo,e.elevationInfo)&&(0,l.kk)(this.feature,e.feature)}}]),n}((0,v.eC)((0,c.J)(u.Z)));(0,s._)([(0,p.Cb)({type:y.Z}),(0,f.B)()],_.prototype,"position",void 0),(0,s._)([(0,p.Cb)({type:g.ZP}),(0,f.B)()],_.prototype,"elevationInfo",void 0),(0,s._)([(0,p.Cb)(l.rX)],_.prototype,"feature",void 0);var b=_=(0,s._)([(0,h.j)("esri.analysis.LineOfSightAnalysisObserver")],_)},33985:function(e,t,n){n.d(t,{Z:function(){return _}});var i=n(15671),r=n(43144),o=n(60136),a=n(29388),s=n(27366),l=n(84314),u=n(11582),c=n(46784),v=n(92026),d=n(49861),p=(n(63780),n(93169),n(25243),n(69912)),h=n(66576),f=n(7882),y=n(64575),g=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).position=null,r.elevationInfo=null,r.feature=null,r}return(0,r.Z)(n,[{key:"equals",value:function(e){return(0,v._W)(this.position,e.position)&&(0,v._W)(this.elevationInfo,e.elevationInfo)&&(0,l.kk)(this.feature,e.feature)}}]),n}((0,c.eC)(u.j));(0,s._)([(0,d.Cb)({type:f.Z}),(0,h.B)()],g.prototype,"position",void 0),(0,s._)([(0,d.Cb)({type:y.ZP}),(0,h.B)()],g.prototype,"elevationInfo",void 0),(0,s._)([(0,d.Cb)(l.rX)],g.prototype,"feature",void 0);var _=g=(0,s._)([(0,p.j)("esri.analysis.LineOfSightAnalysisTarget")],g)},84314:function(e,t,n){n.d(t,{kk:function(){return r},pD:function(){return o},rX:function(){return a}});var i=n(92026);function r(e,t){return o(e)===o(t)}function o(e){if((0,i.Wi)(e))return null;var t,n=null!=e.layer?e.layer.id:"";return null==(t=null!=e.objectId?e.objectId:null!=e.layer&&"objectIdField"in e.layer&&null!=e.layer.objectIdField&&null!=e.attributes?e.attributes[e.layer.objectIdField]:e.uid)?null:"o-".concat(n,"-").concat(t)}var a={json:{write:{writer:function(e,t){var n;(0,i.Wi)(e)||null==(null===(n=e.layer)||void 0===n?void 0:n.objectIdField)||null==e.attributes||(t.feature={layerId:e.layer.id,objectId:e.attributes[e.layer.objectIdField]})},target:{"feature.layerId":{type:[Number,String]},"feature.objectId":{type:[Number,String]}}},origins:{"web-scene":{read:function(e){if(null!=e.layerId&&null!=e.objectId)return{uid:null,layer:{id:e.layerId,objectIdField:"ObjectId"},attributes:{ObjectId:e.objectId}}}}}}}},98074:function(e,t,n){n.d(t,{p:function(){return p}});var i=n(15671),r=n(43144),o=n(60136),a=n(29388),s=n(27366),l=n(42537),u=n(92026),c=n(67426),v=n(49861),d=(n(63780),n(93169),n(25243),n(69912)),p=function(e){var t=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments)).parent=null,e._userInteractive=!1,e._interactiveViewModelCount=0,e}return(0,r.Z)(n,[{key:"interactive",get:function(){return this._interactiveViewModelCount>0||this._userInteractive},set:function(e){this._userInteractive=e}},{key:"updating",get:function(){return!1}},{key:"visible",get:function(){return!(0,u.pC)(this.parent)||this.parent.visible&&!this.parent.suspended},set:function(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")}},{key:"forceInteractiveForViewModel",value:function(){var e=this;return this._interactiveViewModelCount++,(0,l.kB)((function(){return e._interactiveViewModelCount--}))}}]),n}((0,c.v)(e));return(0,s._)([(0,v.Cb)({readOnly:!0})],t.prototype,"type",void 0),(0,s._)([(0,v.Cb)({constructOnly:!0})],t.prototype,"analysis",void 0),(0,s._)([(0,v.Cb)({constructOnly:!0})],t.prototype,"parent",void 0),(0,s._)([(0,v.Cb)({constructOnly:!0})],t.prototype,"view",void 0),(0,s._)([(0,v.Cb)({type:Boolean})],t.prototype,"interactive",null),(0,s._)([(0,v.Cb)()],t.prototype,"_userInteractive",void 0),(0,s._)([(0,v.Cb)({readOnly:!0})],t.prototype,"updating",null),(0,s._)([(0,v.Cb)()],t.prototype,"visible",null),(0,s._)([(0,v.Cb)()],t.prototype,"_interactiveViewModelCount",void 0),t=(0,s._)([(0,d.j)("esri.views.3d.analysis.AnalysisView3D")],t)}},94327:function(e,t,n){n.r(t),n.d(t,{default:function(){return qe}});var i=n(15671),r=n(43144),o=n(60136),a=n(29388),s=n(27366),l=n(85015),u=n(80987),c=n(91505),v=n(92026),d=n(49861),p=n(63780),h=(n(93169),n(25243),n(69912)),f=n(71353),y=n(98074),g=n(51995),_=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).innerWidth=2,r.outerWidth=8,r.visibleInnerColor=new g.Z([3,252,111,1]),r.visibleOuterColor=new g.Z([3,252,111,.15]),r.occludedInnerColor=new g.Z([252,3,69,1]),r.occludedOuterColor=new g.Z([252,3,69,.1]),r.undefinedInnerColor=new g.Z([255,255,255,1]),r.undefinedOuterColor=new g.Z([127,127,127,.2]),r}return(0,r.Z)(n)}(l.Z);(0,s._)([(0,d.Cb)({type:Number})],_.prototype,"innerWidth",void 0),(0,s._)([(0,d.Cb)({type:Number})],_.prototype,"outerWidth",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],_.prototype,"visibleInnerColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],_.prototype,"visibleOuterColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],_.prototype,"occludedInnerColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],_.prototype,"occludedOuterColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],_.prototype,"undefinedInnerColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],_.prototype,"undefinedOuterColor",void 0),_=(0,s._)([(0,h.j)("esri.views.3d.analysis.LineOfSight.LineOfSightConfiguration")],_);var b=n(74165),C=n(15861),m=n(37762),w=(n(59486),n(84314)),Z=n(100),k=n(42537),O=n(84652),I=n(32718),T=n(66978),S=n(94172),L=n(11186),V=n(61826),P=n(79803),R=n(65156),A=n(40885),E=n(74509),M=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).target=null,r.intersectedGraphic=null,r.intersectedLocation=null,r.elevationAlignedTargetLocation=null,r.visible=void 0,r}return(0,r.Z)(n)}(l.Z);(0,s._)([(0,d.Cb)()],M.prototype,"target",void 0),(0,s._)([(0,d.Cb)()],M.prototype,"intersectedGraphic",void 0),(0,s._)([(0,d.Cb)()],M.prototype,"intersectedLocation",void 0),(0,s._)([(0,d.Cb)()],M.prototype,"elevationAlignedTargetLocation",void 0),(0,s._)([(0,d.Cb)({type:Boolean})],M.prototype,"visible",void 0),M=(0,s._)([(0,h.j)("esri.views.3d.analysis.LineOfSightAnalysisResult")],M);var D=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).elevationAlignedTargetLocation=null,r.inputPoints={isValid:!1,observer:(0,f.c)(),observerSurfaceNormal:null,observerFeatureId:null,target:(0,f.c)(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:(0,f.c)(),targetAdjusted:(0,f.c)()},r.computationResult={start:(0,f.c)(),end:(0,f.c)(),intersection:(0,f.c)(),isValid:!1,isTargetVisible:!1},r.result=null,r}return(0,r.Z)(n,[{key:"notifyResultChanged",value:function(){this.notifyChange("computationResult")}},{key:"notifyInputPointsChanged",value:function(){this.notifyChange("inputPoints")}}]),n}(l.Z);(0,s._)([(0,d.Cb)()],D.prototype,"target",void 0),(0,s._)([(0,d.Cb)()],D.prototype,"elevationAlignedTargetLocation",void 0),(0,s._)([(0,d.Cb)()],D.prototype,"inputPoints",void 0),(0,s._)([(0,d.Cb)()],D.prototype,"computationResult",void 0),(0,s._)([(0,d.Cb)()],D.prototype,"result",void 0),D=(0,s._)([(0,h.j)("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],D);var j,z=n(17842),W=n(51378),F=n(65618),H=j=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){return(0,i.Z)(this,n),t.call(this,e)}return(0,r.Z)(n,[{key:"clone",value:function(){return new j({type:this.type,id:(0,O.d9)(this.id),point:(0,O.d9)(this.point),normal:(0,O.d9)(this.normal),ray:(0,O.d9)(this.ray),graphic:this.graphic})}},{key:"equals",value:function(e){return this.type===e.type&&this.id===e.id&&(0,v._W)(this.point,e.point)&&(0,p.fS)(this.normal,e.normal)&&(0,A.fS)(this.ray,e.ray)&&this.graphic===e.graphic}}]),n}(l.Z);(0,s._)([(0,d.Cb)()],H.prototype,"type",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],H.prototype,"id",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],H.prototype,"point",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],H.prototype,"normal",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],H.prototype,"graphic",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],H.prototype,"ray",void 0),H=j=(0,s._)([(0,h.j)("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],H);var G=n(85312),N=n(81703),x=n(43449),B=n(88153),U=n(54463),Y=n(43431),q=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e))._terrainIntersectionOptionsLayerUids=new Set(["terrain"]),r}return(0,r.Z)(n,[{key:"initialize",value:function(){this.intersector=(0,B.Z8)(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=U.eC.MIN}},{key:"getScreenPointIntersection",value:function(e){var t=(0,z.md)(e,W.qW.get()),n=(0,N.u4)(this.view.state.camera,t,ee);return this._getRayIntersection(n)}},{key:"_getRayIntersection",value:function(e,t){if((0,v.Wi)(e)||(0,v.Wi)(this.view.sceneIntersectionHelper))return null;this.intersector.options.store=U.eC.MIN,this.view.sceneIntersectionHelper.intersectToolIntersectorRay(e,this.intersector,t);var n=this.intersector.results.min;if(!n.getIntersectionPoint(X))return null;var i=this.view.renderCoordsHelper.fromRenderCoords(X,this.view.spatialReference),r=(0,f.d)(n.normal);if((0,G.G)(n))return new H({type:U.q7.OBJECT,id:"".concat(n.target.layerUid,"/").concat(n.target.nodeIndex,"/").concat(n.target.componentIndex),point:i,normal:r,ray:(0,A.JG)(e),graphic:null});if((0,x.T)(n))return new H({type:U.q7.TERRAIN,id:n.target.lij.slice(),point:i,normal:r,ray:(0,A.JG)(e),graphic:null});var o=(0,Y.tB)(n,this.view);if((0,v.pC)(o)){var a,s=o.layer,l=o.sourceLayer;return a=l&&"scene"===l.type?(0,F.MS)(o,l.objectIdField):o.uid,new H({type:U.q7.OBJECT,id:"".concat(s.uid,"/").concat(a),point:i,normal:r,ray:(0,A.JG)(e),graphic:o})}return null}},{key:"updateFromGroundIntersection",value:function(e,t,n){var i=X,r=J,o=Q,a=K,s=$;(0,L.c)(r,e),this.view.renderCoordsHelper.worldUpAtPosition(r,o),(0,L.n)(o,o);var l=this.view.basemapTerrain.elevationBounds,u=this.view.renderCoordsHelper.getAltitude(r),c=l?Math.abs(l.max-l.min):100,d=u>0?1:-1;(0,L.g)(a,o,d*(c+Math.abs(t))),(0,L.a)(i,r,a),(0,A.zk)(i,r,ee);var p=this._getRayIntersection(ee,{include:this._terrainIntersectionOptionsLayerUids});return(0,v.pC)(p)&&(0,v.pC)(p.point)?(this.view.renderCoordsHelper.toRenderCoords(p.point,s),(0,L.g)(a,o,d*t),(0,L.a)(n,s,a),(0,f.a)(p.normal)):((0,L.c)(n,e),null)}}]),n}(l.Z);(0,s._)([(0,d.Cb)()],q.prototype,"view",void 0),(0,s._)([(0,d.Cb)()],q.prototype,"intersector",void 0),q=(0,s._)([(0,h.j)("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],q);var X=(0,f.c)(),J=(0,f.c)(),Q=(0,f.c)(),K=(0,f.c)(),$=(0,f.c)(),ee=(0,A.Ue)(),te=n(33906),ne=n(93463),ie=n(7882),re=I.Z.getLogger("esri.views.3d.analysis.LineOfSight.LineOfSightController"),oe=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).updateOnCameraChange=!0,r._effectiveObserverElevationMode="absolute-height",r._observerFeatureId=null,r._updatingHandles=new V.t,r._frameTask=ne.sq,r._handles=new Z.Z,r._computationHandles=new Z.Z,r._externalObserverUpdate=!0,r}return(0,r.Z)(n,[{key:"initialize",value:function(){var e,t=null===(e=this.view.resourceController)||void 0===e?void 0:e.scheduler;this._frameTask=t?t.registerTask(ne.T8.LINE_OF_SIGHT_TOOL):ne.sq,this._intersector=new q({view:this.view}),this._handles.add([this._connectObserver(),this._connectComputations(),this._connectTargets()])}},{key:"destroy",value:function(){this._handles.destroy(),this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}},{key:"updating",get:function(){return this._frameTask.updating||this._updatingHandles.updating}},{key:"priority",get:function(){return this._frameTask.priority},set:function(e){this._frameTask.priority=e}},{key:"_computations",get:function(){return this.analysisViewData.computations}},{key:"_elevationAlignedObserverPositionRenderSpace",get:function(){return this.analysisViewData.observerEngineLocation},set:function(e){this.analysisViewData.observerEngineLocation=e}},{key:"_screenPixelSize",get:function(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}},{key:"getLineOfSightComputationDependencies",value:function(e){return{inputPoints:e.inputPoints}}},{key:"_computeResult",value:function(e){var t=e.computation,n=t.inputPoints,i=t.computationResult,r=n.observerAdjusted,o=n.targetAdjusted,a=i.start,s=i.end;(0,L.c)(a,r),(0,L.c)(s,o),this._canCompute(t)?this._computeIntersection(e):this._interpolateIntersection(e),t.notifyResultChanged(),this.emit("result-changed",{target:e.computation.target,result:t.result})}},{key:"_updateAdjustedPointsFromFeatures",value:function(e){var t=this.view,n=t.sceneIntersectionHelper,i=e.inputPoints,r=i.observerAdjusted,o=i.observerFeatureId,a=i.targetFeatureId,s=i.targetAdjusted;if(!(0,v.Wi)(o)||!(0,v.Wi)(a)){var l=(0,L.i)(r,s),u=this._intersector.intersector,c=(0,A.zk)(i.observer,i.target,le);u.options.store=U.eC.ALL,n.intersectToolIntersectorRay(c,u);var d,p=null,h=null,y=null,g=null,_=(0,m.Z)(u.results.all);try{for(_.s();!(d=_.n()).done;){var b=d.value,C=(0,Y.tB)(b,this.view);if(!(0,v.Wi)(C)&&!(0,v.Wi)(b.distanceInRenderSpace)){var Z=(0,w.pD)(C);(0,v.Wi)(Z)||((0,v.pC)(o)&&Z===o&&((0,v.Wi)(p)&&(p=this._getFeatureDistanceThreshold(b,t,l)),b.distanceInRenderSpace<p&&(y=b)),(0,v.pC)(a)&&Z===a&&((0,v.Wi)(h)&&(h=this._getFeatureDistanceThreshold(b,t,l)),(0,v.Wi)(g)&&b.distanceInRenderSpace<l&&l-b.distanceInRenderSpace<h&&(g=b)))}}}catch(k){_.e(k)}finally{_.f()}(0,v.pC)(y)&&y.getIntersectionPoint(r)&&(i.observerSurfaceNormal=y.getTransformedNormal((0,f.c)())),(0,v.pC)(g)&&g.getIntersectionPoint(s)&&(i.targetSurfaceNormal=g.getTransformedNormal((0,f.c)()))}}},{key:"_getFeatureDistanceThreshold",value:function(e,t,n){if((0,Y._s)(e)){var i=(0,Y.VB)(e,t);if((0,v.pC)(i))return Math.min(i*ce,n)}return 1e-5*n}},{key:"_adjustStartEndPositions",value:function(e){var t=this._screenPixelSize,n=this.view,i=e.inputPoints,r=i.observer,o=i.observerSurfaceNormal,a=i.target,s=i.targetSurfaceNormal,l=i.observerAdjusted,u=i.targetAdjusted,c=se;(0,L.c)(l,r),(0,L.c)(u,a),this._updateAdjustedPointsFromFeatures(e),(0,v.pC)(o)?(0,L.c)(c,o):(0,L.b)(c,u,l);var d=t;(0,L.n)(c,c),(0,L.g)(c,c,Math.min(d,1)),(0,L.a)(l,l,c),(0,v.pC)(s)?(0,L.c)(c,s):(0,L.b)(c,l,u);var p=n.state.camera.computeScreenPixelSizeAt(u);(0,L.n)(c,c),(0,L.g)(c,c,Math.min(p,1)),(0,L.a)(u,u,c)}},{key:"_computeIntersection",value:function(e){var t=e.computation,n=e.interpolationInfo,i=this.view,r=i.sceneIntersectionHelper,o=i.renderCoordsHelper;if(!(0,v.Wi)(r)){var a=this._intersector.intersector,s=t.computationResult,l=t.inputPoints,u=l.observer,c=l.target,d=s.start,p=s.end,h=(0,A.zk)(d,p,le);a.options.store=U.eC.MIN,r.intersectToolIntersectorRay(h,a);var f=a.results.min,y=s.intersection,g=se,_=!0;if((0,v.pC)(f)&&f.getIntersectionPoint(y)){(0,L.c)(n.originalIntersection,y),(0,L.c)(n.originalObserver,d),(0,L.c)(n.originalTarget,p),o.fromRenderCoords(y,g,i.spatialReference);var b=1-(0,L.j)(p,c)/(0,L.j)(d,c);_=(0,L.j)(u,y)>=b*(0,L.j)(u,c)}var C=new ie.Z(g,i.spatialReference),m=t.result,w=t.target;(0,v.pC)(m)?(m.target=w,m.intersectedGraphic=_?null:(0,Y.tB)(f,i),m.intersectedLocation=_?null:C,m.visible=_):t.result=new M({target:w,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:_?null:(0,Y.tB)(f,i),intersectedLocation:_?null:C,visible:_}),s.isValid=l.isValid=!0,s.isTargetVisible=_}}},{key:"_interpolateIntersection",value:function(e){var t=e.computation,n=e.interpolationInfo,i=t.computationResult,r=t.inputPoints,o=i.start,a=i.end,s=i.intersection,l=n.originalIntersection,u=n.originalObserver,c=n.originalTarget;if((0,L.c)(s,l),r.isValid){var v=se,d=(0,L.j)(u,l)/(0,L.j)(u,c);(0,L.v)(v,o,u),(0,L.g)(v,v,1-d),(0,L.a)(s,s,v),(0,L.v)(v,a,c),(0,L.g)(v,v,d),(0,L.a)(s,s,v),i.isValid=!0}else t.result=null,i.isValid=!1,i.isTargetVisible=!1}},{key:"_canCompute",value:function(e){var t=this.analysisViewData.elevationAlignedObserver,n=this.view.frustum;if((0,v.Wi)(t)||(0,v.Wi)(e.elevationAlignedTargetLocation)||(0,v.Wi)(n))return!1;var i=e.inputPoints,r=i.observerAdjusted,o=i.targetAdjusted,a=n.intersectsPoint(r),s=n.intersectsPoint(o);return a&&s}},{key:"_onObserverPositionChange",value:function(e,t,n,i,r){if(this._externalObserverUpdate=r,(0,v.Wi)(e))return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if((0,v.Wi)(t))return(0,te.e)(this.analysis,e.spatialReference,re),void(this.analysisViewData.elevationAlignedObserver=null);var o=this._getEffectiveElevationInfo(t,n),a=(0,E.tq)(t.x,t.y,t.z,this.view.spatialReference,this.view,o),s=a.absoluteZ,l=a.elevation,u=t.clone();u.z=s,this._effectiveObserverElevationMode=o.mode,this.analysisViewData.elevationAlignedObserver=u;var c=(0,f.c)();this.view.renderCoordsHelper.toRenderCoords(u,c),this._elevationAlignedObserverPositionRenderSpace=c,this._observerGroundOffsetRenderSpace=s-l,this._observerFeatureId=(0,w.pD)(i),this.priority=ne.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}},{key:"_onObserverRenderSpacePositionChangeForComputation",value:function(e,t,n,i,r){var o=e.inputPoints;switch((0,L.c)(o.observer,t),o.observerFeatureId=r,o.observerSurfaceNormal=null,i){case"on-the-ground":case"relative-to-ground":var a=this._intersector.updateFromGroundIntersection(o.observer,n,o.observer);(0,v.Wi)(o.observerFeatureId)&&(o.observerSurfaceNormal=a)}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=ne.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}},{key:"_onTargetPositionChange",value:function(e,t,n,i,r){var o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=e.inputPoints;if(o&&(a.isValid=!1),(0,v.Wi)(n))return(0,v.pC)(t)&&(0,te.e)(this.analysis,t.spatialReference,re),e.elevationAlignedTargetLocation=null,void e.notifyInputPointsChanged();var s=this._getEffectiveElevationInfo(n,i),l=(0,E.tq)(n.x,n.y,n.z,this.view.spatialReference,this.view,s),u=l.absoluteZ,c=l.elevation,d=n.clone();switch(d.z=u,e.elevationAlignedTargetLocation=d,this.view.renderCoordsHelper.toRenderCoords(e.elevationAlignedTargetLocation,a.target),a.targetFeatureId=(0,w.pD)(r),a.targetSurfaceNormal=null,s.mode){case"on-the-ground":case"relative-to-ground":var p=this._intersector.updateFromGroundIntersection(a.target,u-c,a.target);(0,v.Wi)(a.targetFeatureId)&&(a.targetSurfaceNormal=p)}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=ne.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}},{key:"_connectComputationToTarget",value:function(e){var t=this;return(0,k.AL)([(0,S.YP)((function(){return{computation:e,targetPosition:e.target.position,targetElevationInfo:e.target.elevationInfo,targetFeatureInfo:e.target.feature,projectedTargetPosition:(0,P.dz)(e.target.position,t.view.spatialReference)}}),(function(e){var n=e.computation,i=e.targetPosition,r=e.targetElevationInfo,o=e.targetFeatureInfo,a=e.projectedTargetPosition;(0,v.pC)(a.pending)?t._updatingHandles.addPromise(a.pending):t._onTargetPositionChange(n,i,a.geometry,r,o)}),S.tX)])}},{key:"_connectComputationToObserver",value:function(e){var t=this;return(0,S.YP)((function(){return{computation:e,observer:t.analysisViewData.elevationAlignedObserver}}),(function(e){var n=e.computation;t._externalObserverUpdate&&(n.inputPoints.isValid=!1,n.notifyInputPointsChanged())}),S.tX)}},{key:"_connectComputationToRenderSpaceObserver",value:function(e){var t=this;return(0,S.YP)((function(){return{computation:e,observer:t._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:t._observerGroundOffsetRenderSpace,observerElevationMode:t._effectiveObserverElevationMode,observerFeatureId:t._observerFeatureId}}),(function(e){var n=e.computation,i=e.observer,r=e.observerGroundOffset,o=e.observerElevationMode,a=e.observerFeatureId;t._onObserverRenderSpacePositionChangeForComputation(n,i,r,o,a)}),S.tX)}},{key:"_connectComputationToCamera",value:function(e){var t=this;return(0,S.YP)((function(){return{camera:t.view.state.camera,isDirty:t._isCameraDirty}}),(function(n){var i=n.isDirty;!t.updateOnCameraChange||e.inputPoints.isValid&&!i||e.notifyInputPointsChanged()}),S.Z_)}},{key:"_connectComputationToSlicePlane",value:function(e){var t=this;return(0,S.YP)((function(){return t.view.slicePlane}),(function(){e.inputPoints.isValid=!1,e.notifyInputPointsChanged()}))}},{key:"_connectComputationToElevation",value:function(e){var t=this,n=function n(i,r){var o=t.analysis.observer,a=e.target,s=null,l=null,u=null,c=null,d=null,p=null;if((0,v.pC)(o)&&(0,v.pC)(o.position)){var h=(0,P.dz)(o.position,t.view.spatialReference);if((0,v.pC)(h.pending))return t._updatingHandles.addPromise(h.pending),void h.pending.finally((function(){return n(i,r)}));s=h.geometry,l=o.elevationInfo,u=o.feature}if((0,v.pC)(a.position)){var f=(0,P.dz)(a.position,t.view.spatialReference);if((0,v.pC)(f.pending))return t._updatingHandles.addPromise(f.pending),void f.pending.finally((function(){return n(i,r)}));c=f.geometry,d=a.elevationInfo,p=a.feature}(0,v.Wi)(s)&&(0,v.Wi)(c)||((0,P.dH)(i,r,ue,t.view.spatialReference),(0,v.pC)(s)&&(0,R.Qn)(ue,s)&&t._onObserverPositionChange((0,v.pC)(o)?o.position:null,s,l,u,!1),(0,v.pC)(c)&&(0,R.Qn)(ue,c)&&t._onTargetPositionChange(e,a.position,c,d,p,!1),(0,v.pC)(s)&&(0,v.pC)(c)&&(0,R.I7)(ue,s,c)&&e.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",(function(e){return n(e.extent,e.spatialReference)}))}},{key:"_connectComputationToTask",value:function(e){var t=this,n=v.YP,i={computation:e,interpolationInfo:{originalIntersection:(0,f.c)(),originalObserver:(0,f.c)(),originalTarget:(0,f.c)()}};return(0,k.AL)([(0,S.YP)((function(){return t.getLineOfSightComputationDependencies(e)}),(function(){n=(0,v.IM)(n),n=(0,T.vr)(function(){var e=(0,C.Z)((0,b.Z)().mark((function e(n){return(0,b.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,T.R8)(t._frameTask.schedule((function(){return t._computeResult(i)}),n));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}),{sync:!0,initial:!0,equals:O.fS}),(0,k.kB)((function(){return n=(0,v.IM)(n)}))])}},{key:"_connectComputation",value:function(e){var t=this._computationHandles;t.has(e)||t.add([this._connectComputationToTarget(e),this._connectComputationToObserver(e),this._connectComputationToRenderSpaceObserver(e),this._connectComputationToCamera(e),this._connectComputationToSlicePlane(e),this._connectComputationToElevation(e),this._connectComputationToTask(e)],e)}},{key:"_disconnectComputation",value:function(e){this._computationHandles.remove(e)}},{key:"_onComputationCollectionChange",value:function(e){var t,n=e.added,i=e.removed,r=(0,m.Z)(i);try{for(r.s();!(t=r.n()).done;){var o=t.value;this._disconnectComputation(o)}}catch(u){r.e(u)}finally{r.f()}var a,s=(0,m.Z)(n);try{for(s.s();!(a=s.n()).done;){var l=a.value;this._connectComputation(l)}}catch(u){s.e(u)}finally{s.f()}}},{key:"_onTargetCollectionChange",value:function(e){var t,n=e.added,i=e.removed,r=(0,m.Z)(i);try{for(r.s();!(t=r.n()).done;){var o=t.value;this._removeTarget(o)}}catch(u){r.e(u)}finally{r.f()}var a,s=(0,m.Z)(n);try{for(s.s();!(a=s.n()).done;){var l=a.value;this._addTarget(l)}}catch(u){s.e(u)}finally{s.f()}}},{key:"_onCursorTargetChange",value:function(e,t){(0,v.pC)(t)&&this._removeTarget(t),(0,v.pC)(e)&&this._addTarget(e)}},{key:"_addTarget",value:function(e){this._computations.some((function(t){return t.target===e}))||this._computations.add(new D({target:e}))}},{key:"_removeTarget",value:function(e){var t=this._computations.findIndex((function(t){return t.target===e}));this._computations.removeAt(t)}},{key:"_connectObserver",value:function(){var e=this;return(0,k.AL)([(0,S.YP)((function(){return{observerPosition:(0,v.pC)(e.analysis.observer)?e.analysis.observer.position:null,projectedObserverPosition:(0,P.dz)((0,v.pC)(e.analysis.observer)?e.analysis.observer.position:null,e.view.spatialReference),observerElevationInfo:(0,v.pC)(e.analysis.observer)?e.analysis.observer.elevationInfo:null,observerFeatureInfo:(0,v.pC)(e.analysis.observer)?e.analysis.observer.feature:null}}),(function(t){var n=t.observerPosition,i=t.projectedObserverPosition,r=t.observerElevationInfo,o=t.observerFeatureInfo;(0,v.pC)(i.pending)?e._updatingHandles.addPromise(i.pending):e._onObserverPositionChange(n,i.geometry,r,o,!0)}),S.tX)])}},{key:"_connectComputations",value:function(){var e=this;return(0,S.on)((function(){return e._computations}),"change",(function(t){return e._onComputationCollectionChange(t)}),{onListenerAdd:function(t){var n,i=(0,m.Z)(t);try{for(i.s();!(n=i.n()).done;){var r=n.value;e._connectComputation(r)}}catch(o){i.e(o)}finally{i.f()}},onListenerRemove:function(t){var n,i=(0,m.Z)(t);try{for(i.s();!(n=i.n()).done;){var r=n.value;e._disconnectComputation(r)}}catch(o){i.e(o)}finally{i.f()}},sync:!0})}},{key:"_connectTargets",value:function(){var e=this;return(0,k.AL)([this._updatingHandles.addOnCollectionChange((function(){return e.analysis.targets}),(function(t){return e._onTargetCollectionChange(t)}),{initial:!0,final:!0}),(0,S.YP)((function(){return e.analysisViewData.cursorTarget}),(function(t,n){e._onCursorTargetChange(t,n)}))])}},{key:"_isCameraDirty",get:function(){var e=this.analysisViewData.elevationAlignedObserver,t=this.view,n=t.renderCoordsHelper;if((0,v.Wi)(e)||(0,v.Wi)(n))return!1;var i=se;n.toRenderCoords(e,i);var r=t.state.camera.computeScreenPixelSizeAt(i);return Math.abs((r-this._screenPixelSize)/this._screenPixelSize)>ae}},{key:"_getEffectiveElevationInfo",value:function(e,t){return e.hasZ?(0,v.Pt)(t,{mode:"absolute-height",offset:0}):{mode:"on-the-ground",offset:0}}}]),n}(c.Z.EventedMixin(l.Z));(0,s._)([(0,d.Cb)({constructOnly:!0})],oe.prototype,"analysis",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],oe.prototype,"analysisViewData",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],oe.prototype,"view",void 0),(0,s._)([(0,d.Cb)()],oe.prototype,"updating",null),(0,s._)([(0,d.Cb)()],oe.prototype,"priority",null),(0,s._)([(0,d.Cb)()],oe.prototype,"updateOnCameraChange",void 0),(0,s._)([(0,d.Cb)()],oe.prototype,"_computations",null),(0,s._)([(0,d.Cb)()],oe.prototype,"_elevationAlignedObserverPositionRenderSpace",null),(0,s._)([(0,d.Cb)()],oe.prototype,"_observerGroundOffsetRenderSpace",void 0),(0,s._)([(0,d.Cb)()],oe.prototype,"_effectiveObserverElevationMode",void 0),(0,s._)([(0,d.Cb)()],oe.prototype,"_observerFeatureId",void 0),(0,s._)([(0,d.Cb)()],oe.prototype,"_screenPixelSize",null),(0,s._)([(0,d.Cb)({readOnly:!0})],oe.prototype,"_updatingHandles",void 0),(0,s._)([(0,d.Cb)()],oe.prototype,"_frameTask",void 0),(0,s._)([(0,d.Cb)()],oe.prototype,"_isCameraDirty",null),oe=(0,s._)([(0,h.j)("esri.views.3d.analysis.LineOfSight.LineOfSightController")],oe);var ae=.1,se=(0,f.c)(),le=(0,A.Ue)(),ue=(0,R.cS)(),ce=.05,ve=n(1413),de=n(97613),pe=n(33985),he=n(85981),fe=n(64575),ye=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).enabled=!0,r.glowColor=new g.Z([255,127,0]),r.glowWidth=8,r.innerColor=new g.Z([255,255,255]),r.innerWidth=.75,r.globalAlpha=.75,r}return(0,r.Z)(n)}(l.Z);(0,s._)([(0,d.Cb)({type:Boolean})],ye.prototype,"enabled",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],ye.prototype,"glowColor",void 0),(0,s._)([(0,d.Cb)({type:Number})],ye.prototype,"glowWidth",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],ye.prototype,"innerColor",void 0),(0,s._)([(0,d.Cb)({type:Number})],ye.prototype,"innerWidth",void 0),(0,s._)([(0,d.Cb)({type:Number})],ye.prototype,"globalAlpha",void 0),ye=(0,s._)([(0,h.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightLaserLineConfiguration")],ye);var ge=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).size=.5,r.color=new g.Z([255,127,0,.75]),r}return(0,r.Z)(n)}(l.Z);(0,s._)([(0,d.Cb)({type:Number})],ge.prototype,"size",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],ge.prototype,"color",void 0),ge=(0,s._)([(0,h.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightObserverConfiguration")],ge);var _e=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).size=.5,r.visibleColor=new g.Z([3,252,111,.75]),r.occludedColor=new g.Z([252,3,69,.75]),r.undefinedColor=new g.Z([127,127,127,.75]),r}return(0,r.Z)(n)}(l.Z);(0,s._)([(0,d.Cb)({type:Number})],_e.prototype,"size",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],_e.prototype,"visibleColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],_e.prototype,"occludedColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],_e.prototype,"undefinedColor",void 0),_e=(0,s._)([(0,h.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTargetConfiguration")],_e);var be=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).innerWidth=2,r.outerWidth=8,r.visibleInnerColor=new g.Z([3,252,111,1]),r.visibleOuterColor=new g.Z([3,252,111,.15]),r.occludedInnerColor=new g.Z([252,3,69,1]),r.occludedOuterColor=new g.Z([252,3,69,.1]),r.undefinedInnerColor=new g.Z([255,255,255,1]),r.undefinedOuterColor=new g.Z([127,127,127,.2]),r}return(0,r.Z)(n)}(l.Z);(0,s._)([(0,d.Cb)({type:Number})],be.prototype,"innerWidth",void 0),(0,s._)([(0,d.Cb)({type:Number})],be.prototype,"outerWidth",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],be.prototype,"visibleInnerColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],be.prototype,"visibleOuterColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],be.prototype,"occludedInnerColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],be.prototype,"occludedOuterColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],be.prototype,"undefinedInnerColor",void 0),(0,s._)([(0,d.Cb)({type:g.Z})],be.prototype,"undefinedOuterColor",void 0);var Ce=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).laserLine=new ye,r.observer=new ge,r.target=new _e,r.lineOfSight=new be,r}return(0,r.Z)(n)}(l.Z);(0,s._)([(0,d.Cb)({type:ye})],Ce.prototype,"laserLine",void 0),(0,s._)([(0,d.Cb)({type:ge})],Ce.prototype,"observer",void 0),(0,s._)([(0,d.Cb)({type:_e})],Ce.prototype,"target",void 0),(0,s._)([(0,d.Cb)({type:be})],Ce.prototype,"lineOfSight",void 0),Ce=(0,s._)([(0,h.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightToolConfiguration")],Ce);var me=n(35284),we=n(60142);var Ze=n(70619),ke=n(99034);function Oe(e,t,n){return{geometry:Ze.Z.createSphereGeometry(e,32,32),material:(0,we.EA)(g.Z.toUnitRGBA(t)),stateMask:n}}function Ie(e){var t=[];return e.customColor1&&t.push(Oe(e.size,e.customColor1,ke.jg.Custom1)),e.customColor2&&t.push(Oe(e.size,e.customColor2,ke.jg.Custom2)),e.customColor3&&t.push(Oe(e.size,e.customColor3,ke.jg.Custom3)),e.color&&t.push(Oe(e.size,e.color)),t}function Te(e,t){var n=Ie(t),i=new me.Z({view:e,renderObjects:n,elevationInfo:{mode:"absolute-height",offset:0}});return function(e,t){var n=null,i=e.events.on("grab-changed",(function(i){(0,v.pC)(n)&&(n.remove(),n=null),"start"===i.action?(n=e.disableDisplay(),t&&t(i)):t&&t(i)}))}(i),i}var Se,Le=n(62389),Ve=(n(84057),n(86509)),Pe=n(5693),Re=n(72612),Ae=n(63920);!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(Se||(Se={}));u.Z.ofType(pe.Z);var Ee=I.Z.getLogger("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool"),Me=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).preferManipulatorCursor=!0,r.removeIncompleteOnCancel=!1,r.configuration=new Ce,r.analysisViewData=null,r._laserlineVisualElement=null,r._grabbedManipulator=null,r._analysisHandles=new Z.Z,r._handles=new Z.Z,r._manipulatorHandles=new Z.Z,r._targetTrackerManipulator=null,r}return(0,r.Z)(n,[{key:"initialize",value:function(){var e=this;this._intersector=new q({view:this.view}),this._handles.add((0,S.YP)((function(){return e.state}),(function(t){t===Se.Created&&e.finishToolCreation()}),S.tX)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([(0,S.YP)((function(){return(0,ve.Z)({},e.configuration.observer)}),(function(){return e._updateObserverManipulatorStyle()}),S.Z_),(0,S.YP)((function(){return e.analysisViewData.elevationAlignedObserver}),(function(t){return e._onObserverLocationChange(t)}),S.tX),(0,S.YP)((function(){return(0,ve.Z)({},e.configuration.laserLine)}),(function(){return e._createVisualElements()}),S.tX),(0,S.YP)((function(){return e._laserLineRendererDependencies()}),(function(t){return e._updateLaserLineRenderer(t)})),this._connectComputations()])}},{key:"destroy",value:function(){this._handles=(0,v.SC)(this._handles),this._manipulatorHandles=(0,v.SC)(this._manipulatorHandles),this._analysisHandles=(0,v.SC)(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)}},{key:"state",get:function(){return this.active?(0,v.pC)(this._grabbedManipulator)?Se.Created:Se.Creating:(0,v.pC)(this.analysis.observer)&&(0,v.pC)(this.analysis.observer.position)?Se.Created:Se.Ready}},{key:"cursor",get:function(){return this.active&&this._showTracker?"crosshair":null}},{key:"updating",get:function(){return!!(0,v.pC)(this.analysisViewData)&&this.analysisViewData.updating}},{key:"_showTracker",get:function(){return this.active&&"mouse"===this._latestPointerMovePointerType}},{key:"_shouldRenderTracker",get:function(){return this._showTracker&&(0,v.pC)(this.analysis.observer)&&(0,v.pC)(this.analysis.observer.position)&&!this.hasFocusedManipulators}},{key:"continue",value:function(){this.view.activeTool=this}},{key:"stop",value:function(){this.view.activeTool=null}},{key:"onEditableChange",value:function(){this.analysisViewData.editable=this.internallyEditable}},{key:"onInputEvent",value:function(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}},{key:"onInputEventAfter",value:function(e){"immediate-click"===e.type&&this._clickHandler(e)}},{key:"onShow",value:function(){}},{key:"onHide",value:function(){this._grabbedManipulator=null}},{key:"onDeactivate",value:function(){this._clearCursorTracker()}},{key:"_connectComputations",value:function(){var e=this;return(0,S.on)((function(){return e.analysisViewData.computations}),"change",(function(t){return e._onComputationsCollectionChange(t)}),{onListenerAdd:function(t){var n,i=(0,m.Z)(t);try{for(i.s();!(n=i.n()).done;){var r=n.value;e._connectComputation(r)}}catch(o){i.e(o)}finally{i.f()}},onListenerRemove:function(t){var n,i=(0,m.Z)(t);try{for(i.s();!(n=i.n()).done;){var r=n.value;e._disconnectComputation(r)}}catch(o){i.e(o)}finally{i.f()}},sync:!0})}},{key:"_onComputationsCollectionChange",value:function(e){var t,n=e.added,i=e.removed,r=(0,m.Z)(i);try{for(r.s();!(t=r.n()).done;){var o=t.value;this._disconnectComputation(o)}}catch(u){r.e(u)}finally{r.f()}var a,s=(0,m.Z)(n);try{for(s.s();!(a=s.n()).done;){var l=a.value;this._connectComputation(l)}}catch(u){s.e(u)}finally{s.f()}}},{key:"_connectComputation",value:function(e){var t=this;if(this.destroyed)Ee.warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");else{var n=this._analysisHandles;if(!n.has(e)){var i=this._createTargetManipulator(e.target);(0,v.Wi)(this._targetTrackerManipulator)&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),n.add([(0,S.YP)((function(){return t._getLineOfSightManipulatorStateDependencies(e)}),(function(){return t._updateManipulatorState(i,e)}),S.tX),(0,S.YP)((function(){return e.elevationAlignedTargetLocation}),(function(e){return t._onTargetLocationChange(e,i)}),S.tX)],e)}}}},{key:"_disconnectComputation",value:function(e){if(this.destroyed)Ee.warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");else{this._analysisHandles.remove(e);var t=this._getTargetManipulator(e.target);(0,v.pC)(t)&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),(0,v.pC)(this._targetTrackerManipulator)&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))}}},{key:"_clearCursorTracker",value:function(){this.analysisViewData.cursorTarget=(0,v.SC)(this.analysisViewData.cursorTarget)}},{key:"_createManipulator",value:function(e,t,n){var i=this,r=Te(this.view,e);return r.metadata=n,this._manipulatorHandles.add([t(r),r.events.on("grab-changed",(function(e){return i._manipulatorGrabChanged(r,e)})),r.events.on("immediate-click",(function(e){return i._manipulatorClick(r,e)}))],r),this.manipulators.add(r),r}},{key:"_createTargetManipulator",value:function(e){var t=this,n=this.configuration,i={size:n.target.size,customColor1:n.target.visibleColor,customColor2:n.target.occludedColor,customColor3:n.target.undefinedColor,visible:!0},r={target:e,type:"target"},o=this._createManipulator(i,(function(e){return t._createTargetManipulatorDragPipeline(e)}),r);return(0,v.pC)(e.position)?o.elevationAlignedLocation=e.position:o.available=!1,o}},{key:"_getTargetManipulator",value:function(e){var t=null;return this.manipulators.forEach((function(n){var i=n.manipulator;(0,v.Wi)(t)&&"target"===i.metadata.type&&i.metadata.target===e&&(t=i)})),t}},{key:"_createObserverManipulator",value:function(){var e=this,t=this.configuration,n={size:t.observer.size,color:t.observer.color,visible:!0};return this._createManipulator(n,(function(t){return e._createObserverManipulatorDragPipeline(t)}),{type:"observer",intersection:null})}},{key:"_updateObserverManipulatorStyle",value:function(){var e=this._observerManipulator,t=this.configuration.observer,n={size:t.size,color:t.color,visible:e.available};e.renderObjects=Ie(n)}},{key:"_screenToIntersection",value:function(){var e=this;return function(t){var n=e._intersector.getScreenPointIntersection(t.screenEnd);return(0,v.Wi)(n)?null:(0,ve.Z)((0,ve.Z)({},t),{},{intersection:n})}}},{key:"_createTargetManipulatorDragPipeline",value:function(e){var t=this;return(0,Pe.Xd)(e,(function(n,i,r){i.next(t._screenToIntersection()).next(t._updateTargetDragStep(e)).next((function(){return t._updateLaserLineRenderer()})),r.next(t._cancelTargetDragStep(e.metadata.target)).next((function(){return t._updateLaserLineRenderer()}))}))}},{key:"_createObserverManipulatorDragPipeline",value:function(e){var t=this;return(0,Pe.Xd)(e,(function(e,n,i){n.next(t._screenToIntersection()).next(t._updateObserverDragStep()).next((function(){return t._updateLaserLineRenderer()})),i.next(t._cancelObserverDragStep()).next((function(){return t._updateLaserLineRenderer()}))}))}},{key:"_updateObserverDragStep",value:function(){var e=this;return function(t){return(0,v.pC)(t.intersection.point)?((0,v.Wi)(e.analysis.observer)&&(e.analysis.observer=new de.Z),e._updateFromIntersection(e.analysis.observer,t.intersection)):e.analysis.observer=null,t}}},{key:"_cancelObserverDragStep",value:function(){var e=this,t=(0,v.pC)(this.analysis.observer)&&(0,v.pC)(this.analysis.observer.position)?this.analysis.observer.clone():null;return function(n){return e.analysis.observer=t,n}}},{key:"_updateTargetDragStep",value:function(e){var t=this;return function(n){t._updateFromIntersection(e.metadata.target,n.intersection);var i=n.intersection.point;return(0,v.pC)(i)&&(e.elevationAlignedLocation=i),n}}},{key:"_cancelTargetDragStep",value:function(e){var t=(0,v.yw)(e.position,(function(e){return e.clone()}));return function(n){return e.position=t,n}}},{key:"_manipulatorGrabChanged",value:function(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}}},{key:"_updateManipulatorState",value:function(e,t){var n=t.computationResult,i=n.isValid,r=n.isTargetVisible;e.state=i?r?ke.jg.Custom1:ke.jg.Custom2:ke.jg.Custom3}},{key:"_getLineOfSightManipulatorStateDependencies",value:function(e){var t=e.computationResult;return{isValid:t.isValid,isTargetVisible:t.isTargetVisible}}},{key:"_laserLineRendererDependencies",value:function(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:(0,v.pC)(this.analysis.observer)?this.analysis.observer.position:null,visible:this.visible}}},{key:"_updateLaserLineRenderer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._laserLineRendererDependencies(),t=e.laserlineVisualElement,n=e.grabbedManipulator,i=e.shouldRenderTracker,r=e.observerPosition,o=e.visible;if(!(0,v.Wi)(t)){var a=(0,v.pC)(n)?n:i&&(0,v.pC)(r)?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&(0,v.pC)(a)&&o?(t.visible=!0,t.heightManifoldTarget=a.renderLocation,a!==this._observerManipulator?t.lineVerticalPlaneSegment=(0,he.zk)(this._observerManipulator.renderLocation,a.renderLocation,De):t.lineVerticalPlaneSegment=null):(t.visible=!1,t.heightManifoldTarget=null,t.lineVerticalPlaneSegment=null)}}},{key:"_createVisualElements",value:function(){var e=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new Le.W({view:this.view,attached:!0,visible:this.visible,style:{glowColor:g.Z.toUnitRGB(e.glowColor),glowWidth:e.glowWidth,innerColor:g.Z.toUnitRGB(e.innerColor),innerWidth:e.innerWidth,globalAlpha:e.globalAlpha}})}},{key:"_removeVisualElements",value:function(){(0,v.pC)(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}},{key:"_onObserverLocationChange",value:function(e){(0,v.Wi)(e)?this._observerManipulator.available=!1:(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e)}},{key:"_onTargetLocationChange",value:function(e,t){(0,v.pC)(e)?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1}},{key:"_addPointFromClickEvent",value:function(e){var t=this._intersector.getScreenPointIntersection(e);if(!(0,v.Wi)(t)&&!(0,v.Wi)(t.point))if((0,v.pC)(this.analysis.observer)&&(0,v.pC)(this.analysis.observer.position)){this._clearCursorTracker();var n=new pe.Z;this._updateFromIntersection(n,t),this.analysis.targets.add(n)}else{var i=new de.Z;this._updateFromIntersection(i,t),this.analysis.observer=i}}},{key:"_clickHandler",value:function(e){this.active&&e.button!==Ae.t.Right&&(this._addPointFromClickEvent((0,Re.vT)(e)),e.stopPropagation())}},{key:"_doubleClickHandler",value:function(e){this.active&&e.button!==Ae.t.Right&&(this.stop(),e.stopPropagation())}},{key:"_keyDownHandler",value:function(e){this.active&&"Escape"===e.key&&(this.stop(),e.stopPropagation())}},{key:"_pointerMoveHandler",value:function(e){if(!this.hasFocusedManipulators&&(this._latestPointerMovePointerType=e.pointerType,this._updateLaserLineRenderer(),this._showTracker&&!(0,v.Wi)(this.analysis.observer)&&!(0,v.Wi)(this.analysis.observer.position))){var t=(0,Re.vT)(e),n=this._intersector.getScreenPointIntersection(t);(0,v.pC)(n)&&(0,v.pC)(n.point)&&((0,v.Wi)(this.analysisViewData.cursorTarget)&&(this.analysisViewData.cursorTarget=new pe.Z),this._updateFromIntersection(this.analysisViewData.cursorTarget,n),this._updateLaserLineRenderer())}}},{key:"_updateFromIntersection",value:function(e,t){if((0,v.Wi)(t.point))return e.position=null,e.elevationInfo=null,void(e.feature=null);switch(t.type){case U.q7.OBJECT:if((0,v.pC)(t.graphic)){var n=t.graphic,i=(0,E.RL)(n);"on-the-ground"===i.mode&&(i.mode="relative-to-ground",i.offset=0),e.elevationInfo=new fe.ZP(i),e.feature=n}else e.elevationInfo=null,e.feature=null;break;case U.q7.TERRAIN:case U.q7.I3S:e.elevationInfo=new fe.ZP({mode:"on-the-ground"}),e.feature=null;break;default:e.elevationInfo=null,e.feature=null}var r=t.point.clone();r.z=(0,E.vQ)(this.view,r,{mode:"absolute-height",offset:0},e.elevationInfo),e.position=r}},{key:"_manipulatorClick",value:function(e,t){if(!("observer"===e.metadata.type||e.grabbing||e.dragging||t.button!==Ae.t.Right||this.analysis.targets.length<=1)){var n=e.metadata.target;this.analysis.targets.remove(n),t.stopPropagation()}}},{key:"testInfo",get:function(){return{laserLineVisualElement:this._laserlineVisualElement}}}]),n}(Ve.f);(0,s._)([(0,d.Cb)({constructOnly:!0})],Me.prototype,"view",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],Me.prototype,"analysis",void 0),(0,s._)([(0,d.Cb)({readOnly:!0})],Me.prototype,"state",null),(0,s._)([(0,d.Cb)({readOnly:!0})],Me.prototype,"cursor",null),(0,s._)([(0,d.Cb)({readOnly:!0})],Me.prototype,"preferManipulatorCursor",void 0),(0,s._)([(0,d.Cb)()],Me.prototype,"removeIncompleteOnCancel",void 0),(0,s._)([(0,d.Cb)({readOnly:!0})],Me.prototype,"updating",null),(0,s._)([(0,d.Cb)({type:Ce})],Me.prototype,"configuration",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],Me.prototype,"analysisViewData",void 0),(0,s._)([(0,d.Cb)({readOnly:!0})],Me.prototype,"_showTracker",null),(0,s._)([(0,d.Cb)()],Me.prototype,"_latestPointerMovePointerType",void 0),(0,s._)([(0,d.Cb)()],Me.prototype,"_shouldRenderTracker",null),(0,s._)([(0,d.Cb)()],Me.prototype,"_laserlineVisualElement",void 0),(0,s._)([(0,d.Cb)()],Me.prototype,"_grabbedManipulator",void 0),Me=(0,s._)([(0,h.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],Me);var De=(0,he.Ue)(),je=n(81949),ze=n(33837),We=n(13759),Fe=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e))._lineOfSightVisualizations=[],r._computationHandles=new Z.Z,r}return(0,r.Z)(n,[{key:"initialize",value:function(){this.own(this._connectComputations()),this._createObserverVisualization()}},{key:"destroy",value:function(){this._computationHandles=(0,v.SC)(this._computationHandles),this._observerVisualElement=(0,v.SC)(this._observerVisualElement)}},{key:"visible",get:function(){return this.analysisViewData.visible}},{key:"interactiveAndEditable",get:function(){return this.analysisViewData.interactive&&this.analysisViewData.editable}},{key:"testInfo",get:function(){return{visualizations:this._lineOfSightVisualizations}}},{key:"_configuration",get:function(){return this.analysisViewData.configuration}},{key:"_createLineOfSightVisualization",value:function(){var e=this._configuration,t=this.view,n={view:t,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth},i=g.Z.toUnitRGBA(e.visibleOuterColor),r=g.Z.toUnitRGBA(e.visibleInnerColor),o=g.Z.toUnitRGBA(e.occludedOuterColor),a=g.Z.toUnitRGBA(e.occludedInnerColor),s=g.Z.toUnitRGBA(e.undefinedOuterColor),l=g.Z.toUnitRGBA(e.undefinedInnerColor),u={visibleLineVisualElement:new ze.r((0,ve.Z)((0,ve.Z)({},n),{},{color:i,innerColor:r})),occludedLineVisualElement:new ze.r((0,ve.Z)((0,ve.Z)({},n),{},{color:o,innerColor:a})),undefinedLineVisualElement:new ze.r((0,ve.Z)((0,ve.Z)({},n),{},{color:s,innerColor:l})),targetVisualElement:new We.L((0,ve.Z)((0,ve.Z)({view:t,attached:!0},He),{},{size:8}))};return this._lineOfSightVisualizations.push(u),u}},{key:"_destroyLineOfSightVisualization",value:function(e){e.visibleLineVisualElement=(0,v.SC)(e.visibleLineVisualElement),e.occludedLineVisualElement=(0,v.SC)(e.occludedLineVisualElement),e.undefinedLineVisualElement=(0,v.SC)(e.undefinedLineVisualElement),e.targetVisualElement=(0,v.SC)(e.targetVisualElement),this._lineOfSightVisualizations.splice(this._lineOfSightVisualizations.indexOf(e),1)}},{key:"_updateLineOfSightVisualization",value:function(e,t,n){var i=this._configuration,r=e.computationResult,o=e.inputPoints,a=r.start,s=r.end,l=r.intersection,u=r.isValid,c=r.isTargetVisible,d=o.observer,p=Be;p[12]=d[0],p[13]=d[1],p[14]=d[2];var h=(0,L.b)(Ge,a,d),y=(0,L.b)(Ne,s,d),_=(0,L.b)(xe,l,d),b=t.visibleLineVisualElement,C=t.occludedLineVisualElement,m=t.undefinedLineVisualElement,w=t.targetVisualElement,Z=(0,v.Wi)(this.analysisViewData.elevationAlignedObserver)||(0,v.Wi)(e.elevationAlignedTargetLocation),k=this.visible&&!Z;b.visible=k,C.visible=k,m.visible=k,w.visible=k,w.attached=!n.interactiveAndEditable,k&&(b.geometry=null,C.geometry=null,m.geometry=null,w.geometry=e.elevationAlignedTargetLocation,u?c?(b.geometry=[[(0,f.d)(h),(0,f.d)(y)]],b.transform=p,b.color=g.Z.toUnitRGBA(i.visibleOuterColor),w.color=g.Z.toUnitRGBA(i.visibleInnerColor)):(b.geometry=[[(0,f.d)(h),(0,f.d)(_)]],b.transform=p,b.color=g.Z.toUnitRGBA(i.occludedOuterColor),C.geometry=[[(0,f.d)(_),(0,f.d)(y)]],C.transform=p,w.color=g.Z.toUnitRGBA(i.occludedInnerColor)):(m.geometry=[[(0,f.d)(h),(0,f.d)(y)]],m.transform=p,w.color=g.Z.toUnitRGBA(i.undefinedInnerColor)))}},{key:"_getLineOfSightVisualizationDependencies",value:function(e){var t=e.computationResult,n=this._configuration;return{computationResult:t,occludedOuterColor:n.occludedOuterColor,visibleOuterColor:n.visibleOuterColor,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}},{key:"_connectComputation",value:function(e){var t=this,n=this._computationHandles;if(!n.has(e)){var i=this._createLineOfSightVisualization();n.add([(0,S.YP)((function(){return t._getLineOfSightVisualizationDependencies(e)}),(function(n){return t._updateLineOfSightVisualization(e,i,n)}),{sync:!0,initial:!0,equals:O.fS}),(0,k.kB)((function(){return t._destroyLineOfSightVisualization(i)}))],e)}}},{key:"_disconnectComputation",value:function(e){this._computationHandles.remove(e)}},{key:"_connectComputations",value:function(){var e=this;return(0,S.on)((function(){return e.analysisViewData.computations}),"change",(function(t){return e._onComputationsCollectionChange(t)}),{sync:!0,onListenerAdd:function(t){var n,i=(0,m.Z)(t);try{for(i.s();!(n=i.n()).done;){var r=n.value;e._connectComputation(r)}}catch(o){i.e(o)}finally{i.f()}},onListenerRemove:function(t){var n,i=(0,m.Z)(t);try{for(i.s();!(n=i.n()).done;){var r=n.value;e._disconnectComputation(r)}}catch(o){i.e(o)}finally{i.f()}}})}},{key:"_onComputationsCollectionChange",value:function(e){var t,n=e.added,i=e.removed,r=(0,m.Z)(i);try{for(r.s();!(t=r.n()).done;){var o=t.value;this._disconnectComputation(o)}}catch(u){r.e(u)}finally{r.f()}var a,s=(0,m.Z)(n);try{for(s.s();!(a=s.n()).done;){var l=a.value;this._connectComputation(l)}}catch(u){s.e(u)}finally{s.f()}}},{key:"_createObserverVisualization",value:function(){var e=this,t=g.Z.toUnitRGBA(this._configuration.visibleInnerColor),n=new We.L((0,ve.Z)({view:this.view,attached:!1,color:t},He));this._observerVisualElement=n,this.own((0,S.YP)((function(){return{observer:e.analysisViewData.elevationAlignedObserver,interactiveAndEditable:e.interactiveAndEditable,visible:e.visible}}),(function(t){var i=t.observer,r=t.interactiveAndEditable,o=t.visible;(0,v.Wi)(i)||r||!o?n.attached=!1:(n.geometry=i,e._observerVisualElement.attached=!0)}),S.nn))}}]),n}(l.Z);(0,s._)([(0,d.Cb)({constructOnly:!0})],Fe.prototype,"analysis",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],Fe.prototype,"analysisViewData",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0})],Fe.prototype,"view",void 0),(0,s._)([(0,d.Cb)({readOnly:!0})],Fe.prototype,"visible",null),(0,s._)([(0,d.Cb)()],Fe.prototype,"interactiveAndEditable",null),(0,s._)([(0,d.Cb)()],Fe.prototype,"testInfo",null),(0,s._)([(0,d.Cb)()],Fe.prototype,"_configuration",null),Fe=(0,s._)([(0,h.j)("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],Fe);var He={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},Ge=(0,f.c)(),Ne=(0,f.c)(),xe=(0,f.c)(),Be=(0,je.c)(),Ue=n(70209),Ye=function(e){(0,o.Z)(n,e);var t=(0,a.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).type="line-of-sight-view-3d",r.analysis=null,r.tool=null,r.computations=new u.Z,r.elevationAlignedObserver=null,r.configuration=new _,r.observerEngineLocation=(0,f.c)(),r.cursorTarget=null,r.editable=!0,r}return(0,r.Z)(n,[{key:"initialize",value:function(){var e=this,t=this.view,n=this.analysis;this._analysisController=new oe({analysis:n,analysisViewData:this,view:t}),this._analysisVisualization=new Fe({analysis:n,analysisViewData:this,view:t}),this.own([this._analysisController.on("result-changed",(function(t){t.target!==e.cursorTarget&&e.emit("result-changed",t)})),(0,Ue.Lp)(this,Me)])}},{key:"destroy",value:function(){(0,Ue.Yq)(this),this._analysisController=(0,v.SC)(this._analysisController),this._analysisVisualization=(0,v.SC)(this._analysisVisualization)}},{key:"results",get:function(){return this.computations.map((function(e){return e.result}))}},{key:"priority",get:function(){return this._analysisController.priority},set:function(e){this._analysisController.priority=e}},{key:"updating",get:function(){return(0,v.pC)(this._analysisController)&&this._analysisController.updating}},{key:"getResultForTarget",value:function(e){var t=this.computations.find((function(t){return t.target===e}));return(0,v.yw)(t,(function(e){return e.result}))}},{key:"testInfo",get:function(){return{visualization:this._analysisVisualization,controller:this._analysisController}}}]),n}((0,y.p)(c.Z.EventedMixin(l.Z)));(0,s._)([(0,d.Cb)({readOnly:!0})],Ye.prototype,"type",void 0),(0,s._)([(0,d.Cb)({constructOnly:!0,nonNullable:!0})],Ye.prototype,"analysis",void 0),(0,s._)([(0,d.Cb)()],Ye.prototype,"tool",void 0),(0,s._)([(0,d.Cb)({readOnly:!0})],Ye.prototype,"results",null),(0,s._)([(0,d.Cb)()],Ye.prototype,"priority",null),(0,s._)([(0,d.Cb)()],Ye.prototype,"computations",void 0),(0,s._)([(0,d.Cb)()],Ye.prototype,"elevationAlignedObserver",void 0),(0,s._)([(0,d.Cb)()],Ye.prototype,"configuration",void 0),(0,s._)([(0,d.Cb)()],Ye.prototype,"observerEngineLocation",void 0),(0,s._)([(0,d.Cb)()],Ye.prototype,"cursorTarget",void 0),(0,s._)([(0,d.Cb)()],Ye.prototype,"updating",null),(0,s._)([(0,d.Cb)()],Ye.prototype,"editable",void 0),(0,s._)([(0,d.Cb)()],Ye.prototype,"_analysisController",void 0),(0,s._)([(0,d.Cb)()],Ye.prototype,"_analysisVisualization",void 0);var qe=Ye=(0,s._)([(0,h.j)("esri.views.3d.analysis.LineOfSightAnalysisView3D")],Ye)}}]);
//# sourceMappingURL=4327.372c9ff5.chunk.js.map