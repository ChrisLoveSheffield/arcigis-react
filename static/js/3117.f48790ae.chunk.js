"use strict";(self.webpackChunkuums_front_end=self.webpackChunkuums_front_end||[]).push([[3117],{54748:function(e,t,i){i.d(t,{Z:function(){return Ue}});var r=i(29439),n=i(15671),a=i(43144),s=i(60136),o=i(29388),d=i(27366),u=i(85015),l=i(100),h=i(93169),c=i(32718),f=i(92026),v=i(27546),_=i(67426),g=i(66978),m=i(94172),p=i(49861),y=i(63780),b=(i(25243),i(69912)),x=i(79803),C=i(65156),k=i(65618),N=i(41388),D=i(50951),w=i(37762),I=i(93463),P=function(){function e(t){(0,n.Z)(this,e),this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(I.T8.I3S_CONTROLLER,this)}return(0,a.Z)(e,[{key:"destroy",value:function(){this.handle&&(this.handle.remove(),this.handle=null)}},{key:"running",get:function(){var e,t=(0,w.Z)(this.callbacks);try{for(t.s();!(e=t.n()).done;){if(e.value.needsUpdate())return!0}}catch(i){t.e(i)}finally{t.f()}return!1}},{key:"runTask",value:function(e){this._sort();for(var t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0},r=0;r<t.length&&!e.done;++r)t[r].priority=t[r].update(e,i),this.runIndex=r}},{key:"_sort",value:function(){for(var e=this.callbacks,t=e.length,i=this.runIndex;i>0;i--){for(var r=e[i-1],n=i;n<e.length&&r.priority<=e[n].priority&&(n!==t||r.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=r,t=n-1}this.runIndex=0}},{key:"add",value:function(e){this._sort(),e.priority=1/0,this.callbacks.unshift(e)}},{key:"remove",value:function(e){(0,y.e$)(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort()}}]),e}(),S=new Map;function L(e,t){var i=S.get(e);return null==i&&(i=new P(e),S.set(e,i)),i.add(t),{remove:function(){null!=i&&(i.remove(t),i.callbacks.length>0||(S.delete(e),i.destroy()),i=null)}}}var M=i(11186),O=i(67077),F=i(95964),A=i(44011),T=i(89414),E=(0,a.Z)((function e(t,i,r,a,s){(0,n.Z)(this,e),this.childOffset=t,this.childCount=i,this.visibilityCache=r,this.ref=a,this.node=s,this.useAsHole=0,this.filterImpact=F.U_.NotChecked})),R=function(){function e(t,i,r,a,s,o,d,u,l,h,c,f,_,g){(0,n.Z)(this,e),this.streamDataController=r,this.viewportQueries=a,this.logger=s,this.holeFilling=o,this._isLoaded=d,this._isReloading=u,this._isSelected=l,this._enable=h,this._needsUpdate=c,this._canRequest=f,this._computeVisibilityObb=_,this._computeNodeFiltering=g,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=F.w5.None,this._lodConversion=function(e){return e},this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=j(0),this._visibilityCacheVersion=j(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new v.Z({deallocator:null}),this._prefetch=new v.Z({deallocator:null}),this._updates=new U(this._missing),this._imModificationUncategorized=new v.Z({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=[],this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=t,t.serviceUpdateTimeStamp&&t.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate="".concat(t.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this._init(i)}return(0,a.Z)(e,[{key:"_init",value:function(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=F.w5.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this.lodMetric=F.w5.MaxScreenThreshold,this._lodConversion=Y}this._addPage(H(this.rootIndex,this.nodesPerPage),e.rootPage),this._updateParentsAndLevel()}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this._makeRefNode(new F.$i(e.rootNode.id,null),-1);var t=this._validateNode(e.rootNode.id,e.rootNode);t&&this._addNode(t,0)}}},{key:"_loadPage",value:function(e){var t=this;this._loading.add(e);var i=this.urlPrefix+e;this.streamDataController.request(i,"json").then((function(i){t._pageQueue.push({pageIndex:e,page:i})})).catch((function(i){t._loading.delete(e),(0,g.D_)(i)||(t._failedPages.add(e),t.logger.error("#loadPage()",t.logLayer,"Error when loading page ".concat(e),i))}))}},{key:"_addQueuedPages",value:function(e){for(;this._pageQueue.length>0&&!e.done;){var t=this._pageQueue.shift(),i=t.pageIndex,r=t.page;this._addPage(i,r),this._loading.delete(i),e.madeProgress()}this._updateParentsAndLevel()}},{key:"_addPage",value:function(e,t){for(var i=this,r=this._nodePages.length;r<e;r++)this._nodePages[r]=null;var n=[],a=[],s=t.nodes.map((function(t,r){var s=n.length,o=t.children?t.children.length:0;a.push(-1);for(var d=0;d<o;d++)n.push(t.children[d]);var u="".concat(t.index),l=(0,T.d9)(t.obb),h=(0,O.b)([l.center[0],l.center[1],l.center[2],(0,M.l)(l.halfSize)]),c=t.mesh&&t.mesh.attribute,f=t.mesh&&t.mesh.geometry,v=t.mesh&&t.mesh.material,_={hasSharedResource:!1,hasFeatureData:!!f,attributes:c&&null!=c.resource?"".concat(c.resource):null,geometry:f&&null!=f.resource?"".concat(f.resource):null,texture:v&&null!=v.resource?"".concat(v.resource):null,geometryDefinition:f?f.definition:-1,materialDefinition:v?v.definition:-1},g=new F.NB(u,e*i.nodesPerPage+r,h,o,0,_,i.lastUpdate,i.lodMetric,i._lodConversion(t.lodThreshold),f?f.featureCount:null);return g.serviceObb=l,g.visibilityObb=i._computeVisibilityObb(g),g.vertexCount=f?f.vertexCount:0,new E(s,o,Z(i._visibilityCacheVersion),null,g)}));this._nodePages[e]={nodes:s,children:n,parents:a},this.nodeCount+=s.length}},{key:"_updateParentsAndLevel",value:function(){var e=this,t=new Array,i=function(i,r,n){var a=e._getPage(i);if((0,f.pC)(a)){var s=Q(i,e.nodesPerPage);a.parents[s]=r;var o=a.nodes[s].node;(0,f.pC)(o)&&(o.level=n,t.push(i))}};for(i(this.rootIndex,-1,0);t.length;){var r=t.pop(),n=this.getNode(r);if((0,f.pC)(n))for(var a=0;a<n.childCount;a++)i(this.getChildIndex(n.index,a),r,n.level+1),this._maxLevel=Math.max(this._maxLevel,n.level+1)}}},{key:"_getPage",value:function(e){return this._nodePages[H(e,this.nodesPerPage)]}},{key:"_getNodeInternal",value:function(e){var t=this._getPage(e);return(0,f.Wi)(t)?null:t.nodes[Q(e,this.nodesPerPage)]}},{key:"_addNode",value:function(e,t){null!=e.children&&this.populateChildren(t,e.children);var i=this.getParent(t),r=(0,f.pC)(i)?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?r+1:r);var n=function(e){if(e)for(var t=0;t<e.length;t++){var i,r=(0,w.Z)(z);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}}catch(a){r.e(a)}finally{r.f()}}return{lodMetric:F.w5.None,maxError:0}}(e.lodSelection),a=n.lodMetric,s=n.maxError,o=(0,f.Wg)(this._getNodeInternal(t));return o.node=new F.NB(e.id,t,(0,O.b)(e.mbs),o.childCount,r,e.resources,e.version,a,s,e.numFeatures),e.obb&&(o.node.serviceObb=(0,T.d9)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),(0,f.pC)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}},{key:"_makeRefNode",value:function(e,t){var i=this._nodePages[0],r=i.nodes.length;return i.nodes.push(new E(0,0,Z(this._visibilityCacheVersion),e,null)),this.nodeCount++,i.parents.push(t),(0,A.WD)(e.renderMbs),(0,A.VL)(e.serviceObbInRenderSR),r}},{key:"populateChildren",value:function(e,t){var i=(0,f.Wg)(this._getNodeInternal(e)),r=(0,f.Wg)(this._getPage(e));i.childOffset=r.children.length,i.childCount=t.length;for(var n=0;n<t.length;n++){var a=this._makeRefNode(t[n],e);r.children.push(a)}}},{key:"getNode",value:function(e){var t=this._getNodeInternal(e);return(0,f.pC)(t)?t.node:null}},{key:"getIndexById",value:function(e){var t;return this._forAllNodes((function(i,r){((0,f.pC)(i.node)&&i.node.id===e||(0,f.pC)(i.ref)&&i.ref.id===e)&&(t=r)})),t}},{key:"getNodeById",value:function(e){var t=this.getIndexById(e);return t>=0?this.getNode(t):null}},{key:"getChildIndex",value:function(e,t){var i=this._getPage(e);if((0,f.Wi)(i))return-1;var r=i.nodes[Q(e,this.nodesPerPage)];return i.children[r.childOffset+t]}},{key:"getParentIndex",value:function(e){var t=this._getPage(e);return(0,f.pC)(t)?t.parents[Q(e,this.nodesPerPage)]:-1}},{key:"getParent",value:function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}},{key:"isLeaf",value:function(e){var t=this._getNodeInternal(e);return(0,f.pC)(t)&&0===t.childCount}},{key:"rootNode",get:function(){return this.getNode(this.rootIndex)}},{key:"size",get:function(){return this.nodeCount}},{key:"removeAllGeometryObbs",value:function(){this._forAllNodes((function(e){(0,f.pC)(e.node)&&(e.node.geometryObb=null)}))}},{key:"invalidateVisibilityCache",value:function(){this._visibilityCacheVersion=j(this._visibilityCacheVersion)}},{key:"invalidateNodeVisibilityCache",value:function(e){var t=this._getNodeInternal(e);(0,f.pC)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}},{key:"invalidateNodeVisibilityCacheInternal",value:function(e){e.visibilityCache=Z(this._visibilityCacheVersion)}},{key:"invalidateBoundingVolumeCache",value:function(e){var t=this._getNodeInternal(e);(0,f.pC)(t)&&(G(t),this.invalidateNodeVisibilityCacheInternal(t))}},{key:"updateElevationChanged",value:function(e){var t=this._getNodeInternal(e);if(!(0,f.Wi)(t))if(this.needNodeElevationRange){var i=(0,f.pC)(t.node)?t.node:t.ref;if(!(0,f.Wi)(i)){var r=i.elevationRange;(0,f.Wi)(r)||(r.valid=!1)}}else this.invalidateBoundingVolumeCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){var t=this._getNodeInternal(e);(0,f.pC)(t)&&(0,f.pC)(t.node)&&(t.node.geometryObb=null,(0,A.WD)(t.node.renderMbs),(0,A.VL)(t.node.serviceObbInRenderSR))}},{key:"invalidateVisibilityObbs",value:function(){var e=this;(0,f.Wi)(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.visibilityObb=e._computeVisibilityObb(t),t.geometryObb=null,!0}))}},{key:"_updateElevationRange",value:function(e){var t=this._getNodeInternal(e);if((0,f.Wi)(t))return null;var i=(0,f.pC)(t.node)?t.node:t.ref;if((0,f.Wi)(i))return null;var r=i.elevationRange;if((0,f.pC)(r)&&r.valid)return r;for(var n=new F.rw,a=!1,s=0;s<t.childCount;s++){var o=this._updateElevationRange(this.getChildIndex(e,s));(0,f.Wi)(o)?a=!0:(n.min=Math.min(n.min,o.min),n.max=Math.max(n.max,o.max))}if(0===t.childCount||a&&(0,f.pC)(t.node)&&t.node.resources.geometry){var d=this.viewportQueries.getElevationRange(i);(0,f.pC)(d)&&(n.min=Math.min(n.min,d.min),n.max=Math.max(n.max,d.max))}return(0,f.pC)(r)&&r.min===n.min&&r.max===n.max?(r.valid=!0,r):(n.valid=!0,i.elevationRange=n,this.invalidateBoundingVolumeCache(e),n)}},{key:"isNodeVisible",value:function(e){var t=this._getNodeInternal(e);if((0,f.Wi)(t)||(0,f.pC)(t.ref)&&!t.ref.mbs)return!0;if(this.needNodeElevationRange&&this._updateElevationRange(e),!q(t.visibilityCache,this._visibilityCacheVersion)){var i=t.node,r=(0,f.pC)(i)&&((0,f.Wi)(t.ref)||(0,f.pC)(i.visibilityObb))?i:(0,f.pC)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&((0,f.pC)(i)||(0,f.pC)(t.ref))&&t.filterImpact===F.U_.NotChecked){var n=(0,f.pC)(i)?i.mbs:(0,f.pC)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=n?this._computeNodeFiltering(n):F.U_.Unmodified}var a=(0,f.pC)(i)&&t.filterImpact===F.U_.Culled,s=!((0,f.pC)(i)&&i.imModificationImpact===F.O4.Culled)&&(!r||this.viewportQueries.isNodeVisible(r))&&!a;return t.visibilityCache=W(s,this._visibilityCacheVersion),s}return B(t.visibilityCache)}},{key:"isGeometryVisible",value:function(e){if(!this.isNodeVisible(e))return!1;var t=this._getNodeInternal(e);return!((0,f.pC)(t)&&(0,f.pC)(t.node)&&(0,f.pC)(t.node.geometryObb)&&(!this.layerHasModifications||t.node.imModificationImpact!==F.O4.NotChecked))||this.viewportQueries.isGeometryVisible(t.node)}},{key:"_traverseCoverage",value:function(e,t,i,r,n){var a=this._getPage(e);if(!(0,f.Wi)(a)&&0!==t.childCount){for(var s=t.childOffset+t.childCount,o=new Array,d=t.childOffset;d<s;++d){var u=a.children[d],l=this._getNodeInternal(u);(0,f.pC)(l)&&(0,f.pC)(l.node)&&this.isGeometryVisible(u)&&o.push(l)}r/=o.length;for(var h=0,c=o;h<c.length;h++){var v=c[h],_=(0,f.Wg)(v.node).index;this._isLoaded(_)||this._isReloading(_)?(n.delta=Math.max(n.delta,i),n.coverage+=r):this._traverseCoverage(_,v,i+1,r,n)}}}},{key:"useNodeAsHole",value:function(e){if("off"===this.holeFilling)return!1;var t=this._getNodeInternal(e);if((0,f.Wi)(t))return!1;if("always"===this.holeFilling)return!0;if(q(t.useAsHole,this._version))return B(t.useAsHole);var i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);var r=i.delta*i.coverage<=.5;return t.useAsHole=W(r,this._version),r}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"destroy",value:function(){this._updates.add.prune(),this._updates.update.prune()}},{key:"requestUpdate",value:function(){this._dirty=!0,this._indexMissing=1,this._version=j(this._version)}},{key:"imModificationsChanged",value:function(e){var t=this;this.layerHasModifications=e,this._forAllNodes((function(e){var i=e.node;(0,f.pC)(i)&&(i.imModificationImpact=F.O4.NotChecked,i.visibilityObb=t._computeVisibilityObb(i),i.hasModifications&&t.invalidateGeometryVisibility(i.index))})),this.invalidateVisibilityCache()}},{key:"layerFilterChanged",value:function(e){var t=this;this._layerHasFilter=e,this._forAllNodes((function(e){if((0,f.pC)(e)){e.filterImpact=F.U_.NotChecked;var i=e.node;(0,f.pC)(i)&&t.invalidateNodeVisibilityCache(i.index)}})),this.invalidateVisibilityCache()}},{key:"update",value:function(e,t,i){var r=this;if(this._dirty){this._pageQueue.length>0&&this._addQueuedPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e),V.clear();var n=!0,a=new K,s=new K,o=this._imModificationUncategorized;o.clear();var d=new Set;this.traverseVisible((function(u,l,h){if((0,f.Wi)(l)){var c=r._entryPriority(u);c===1/0&&(c=r._entryPriority(h));var v=H(u,r.nodesPerPage);return V.set(v,Math.max(c,V.get(v)||0)),r._loading.has(v)||r._failedPages.has(v)||r._missing.push(v),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,c))}var _=l.node;if(r._updateNodeFeatureEstimate(_,s),(0,f.Wi)(_)){var g=r._entryPriority(u);return r._loading.has(u)||r._failedNodes.has(u)||(r._missing.push(u),V.set(u,g)),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,g))}var m=(0,f.Wg)(r._getPage(u));if(0===r._missing.length&&0===r.nodesPerPage)for(var p=0;p<l.childCount;p++){var y=m.children[l.childOffset+p],b=r._getNodeInternal(y);!(0,f.pC)(b)||b.node||r._loading.has(y)||r._failedNodes.has(y)||(V.set(y,r._entryPriority(y)),r._prefetch.push(y))}if(!_.failed&&_.resources.hasFeatureData)if(d.add(_.id),r._isLoaded(u)){if(a.known+=_.memory,++a.knownNodes,r._isSelected(_)?l.childCount>0&&(n=!1):(a.unremoved+=_.memory,n=!1),r._needsUpdate(_)){var x=r._entryPriority(u);V.set(u,x),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,x),r._updates.update.push(u)}}else if(_.memory&&(a.known+=_.memory,++a.knownNodes),r._isSelected(_)){if(l.childCount>0&&(n=!1),_.memory?(a.missing+=_.memory,a.known+=_.memory,++a.knownNodes):++a.missingNodes,e.includes(_.index))return r._maxProcessingPrio=Math.max(r._maxProcessingPrio,r._entryPriority(u)),void(r._updates.cancel=r._updates.cancel.filter((function(e){return e!==_.index})));if(t.done||!r._enable(_)){var C=r._entryPriority(u);V.set(u,C),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,C),r._updates.add.push(u),r.layerHasModifications&&i&&(0,f.pC)(_)&&_.imModificationImpact===F.O4.NotChecked&&o.push(u)}else t.madeProgress()}else r._isReloading(u)&&r._updates.remove.push(u);else n&&l.childCount>0&&r._isSelected(_)&&(n=!1)}));var u=this._updates.add;u.length>0&&this.layerHasModifications&&(o.length>0&&i(o),u.filterInPlace((function(e){var t=r._getNodeInternal(e),i=(0,f.Wi)(t)||(0,f.Wi)(t.node)||t.node.imModificationImpact!==F.O4.Culled;return i||r.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(s),this._featureEstimate.leavesReached=n,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||r._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return V.get(e)-V.get(t)})),this._missing.length>0&&(this._maxUnloadedPrio=V.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((function(e){return V.get(e)>=r._maxUnloadedPrio})).sort((function(e,t){return V.get(e)-V.get(t)})),this._updates.update.sort((function(e,t){return V.get(e)-V.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,V.clear()}}},{key:"checkFeatureTarget",value:function(e,t){for(var i=this.viewportQueries.updateScreenSpaceErrorBias(t),r=t,n=t,a=i,s=10;s--;){var o=new K;if(this._updateFeatureEstimate(r,o),this._computeFeatureEstimate(o)<=e){if(r>=t||o.missingNodes>0||0===s)break;a=r,r=.5*(r+n)}else n=r,r=.5*(r+a)}return this._version=j(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)}},{key:"_updateFeatureEstimate",value:function(e,t){var i=this;this._version=j(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,r){return i._updateNodeFeatureEstimate((0,f.pC)(r)&&r.node,t)}))}},{key:"_updateNodeFeatureEstimate",value:function(e,t){if(!((0,f.Wi)(e)||e.failed||(0,f.Wi)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&((0,f.pC)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}},{key:"_computeFeatureEstimate",value:function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}},{key:"load",value:function(){return this._load(this._missing)}},{key:"prefetch",value:function(){return this._prefetch.sort((function(e,t){return V.get(e)-V.get(t)})),this._load(this._prefetch)}},{key:"_load",value:function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this._loadPage(e.pop());return!0}},{key:"isLoading",value:function(){return this._indexMissing>0}},{key:"getIndexLoading",value:function(){return this._loading.size}},{key:"getIndexMissing",value:function(){return this._indexMissing}},{key:"getUnloadedMemoryEstimate",value:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"nodeTraversalState",value:function(e){if((0,f.Wi)(e))return null;var t=this._nodeTraversalState.get(e.index);if(t&&q(t.version,this._version))return t;var i=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e),n=!0;if(r){var a=this.getParentIndex(e.index);if(a>=0){var s=this._nodeTraversalState.get(a);n=s&&i>s.lodLevel}else n=i>0}else n=0===e.childCount;return t?(t.lodLevel=i,t.isChosen=n,t.version=W(!0,this._version),t):(t=new F.oQ(r,n,i,W(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}},{key:"_loadNode",value:function(e){var t=this;this._loading.add(e);var i=(0,f.Wg)(this._getNodeInternal(e)).ref;if((0,f.Wi)(i))this._failedNodes.add(e);else{var r=i.id,n=this.urlPrefix+r,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(n,"json").then((function(i){a();var n=t._validateNode(r,i);if(null!=n){n.obb&&t.invalidateNodeVisibilityCache(e);var s=t._addNode(n,e);t.nodeTraversalState(s)}}),(function(i){a(),(0,g.D_)(i)||(t.logger.error("#loadNode()",t.logLayer,"Error loading node: "+n),t._failedNodes.add(e))}))}}},{key:"_validateNode",value:function(e,t){var i=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,'Invalid node. Wrong type or wrong id "'.concat(e,'"')),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,"Invalid bounding volume on node ".concat(e,".")),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,'Invalid shared resource href on node "'.concat(e,'"')),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,'Invalid geometry data on node "'.concat(e,'"')),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_".concat(t,"/0")}))||this.logger.warn("#validateNode()",this.logLayer,'Invalid attribute data on node "'.concat(e,'"')),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,"Node ".concat(e," has ").concat(t.featureData.length," bundles. Only the first bundle will be loaded."));var r=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,a=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var r=function(t){return i.logger.error("#validateNode()",i.logLayer,"Invalid node reference on node ".concat(e,": ").concat(t))};if("number"==typeof t.id)r("id ".concat(t.id," is a number instead of a string."));else if("string"!=typeof t.id||!Array.isArray(t.mbs))return r("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return r("Invalid bounding volume on reference ".concat(t.id,".")),null;t.href&&t.href!=="../"+t.id&&i.logger.error("#validateNode()",i.logLayer,'Invalid node href on node "'.concat(e,'"'));var n=t.hasOwnProperty("obb")&&!i.ignoreServiceObb?t.obb:null,a=new F.$i("".concat(t.id),t.mbs);return a.serviceObb=n,a.visibilityObb=i._computeVisibilityObb(a),a})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:r,children:a,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}}},{key:"resetFailedNodes",value:function(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((function(e){(0,f.pC)(e.node)&&(e.node.failed=!1)}))}},{key:"_entryPriority",value:function(e){var t=this._getNodeInternal(e),i=this.getParentIndex(e);if((0,f.Wi)(t)||i<0&&null==t.node)return i<0?1/0:this._entryPriority(i);var r=0;if(t.node&&i>=0){var n=this._nodeTraversalState.get(i);null!=n&&(r=n.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var o=(0,f.pC)(t.ref)?this.viewportQueries.distToPOI(t.ref):(0,f.pC)(t.node)?this.viewportQueries.distToPOI(t.node):0;return-o-r*(o+this.progressiveLoadPenalty)+a}},{key:"traverseVisible",value:function(e){var t=this._getNodeInternal(this.rootIndex);(0,f.Wi)(t)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,t,e)}},{key:"_traverseVisible",value:function(e,t,i,r){if(i.node&&0===i.childCount)this.isGeometryVisible(e)&&r(e,i,t);else if(this.isNodeVisible(e)&&(r(e,i,t),null!=i.node)){var n=this.nodeTraversalState(i.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var a=(0,f.Wg)(this._getPage(e)),s=0;s<i.childCount;s++){var o=a.children[i.childOffset+s],d=this._getNodeInternal(o);(0,f.pC)(d)?this._traverseVisible(o,e,d,r):r(o,null,e)}}}},{key:"traverse",value:function(e,t){t(e)&&this.traverseChildren(e,t)}},{key:"traverseChildren",value:function(e,t){var i=e.index,r=this._getNodeInternal(i);(0,f.pC)(r)&&this._traverseChildren(i,r,t)}},{key:"_traverseChildren",value:function(e,t,i){var r=this._getPage(e);if(!(0,f.Wi)(r))for(var n=t.childOffset+t.childCount,a=t.childOffset;a<n;++a){var s=r.children[a],o=this._getNodeInternal(s);(0,f.pC)(o)&&(0,f.pC)(o.node)&&i(o.node)&&this._traverseChildren(s,o,i)}}},{key:"updateChildrenLoaded",value:function(e,t){for(var i=this.getNode(e);(0,f.pC)(i);)i.childrenLoaded+=t,i=this.getParent(i.index)}},{key:"checkChildrenLoadedInvariant",value:function(){var e=this;if((0,f.Wi)(this.rootNode))return!0;var t=[];return function i(r){var n=e._isLoaded(r.index)||e._isReloading(r.index)?1:0;return e.traverseChildren(r,(function(e){return n+=i(e),!1})),r.childrenLoaded!==n&&t.push(r.index),n}(this.rootNode),t.length&&this.logger.error("childrenLoaded invariant broken at following nodes: "+t.join(",")),t.length>0}},{key:"updateStats",value:function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||0),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}},{key:"getPriority",value:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"updateElevationInfo",value:function(e,t){this.needNodeElevationRange=t&&e&&("relative-to-ground"===e.mode||"on-the-ground"===e.mode),this._forAllNodes((function(e){G(e),(0,f.pC)(e.node)&&(e.node.elevationRange=null),(0,f.pC)(e.ref)&&(e.ref.elevationRange=null)})),this.viewportQueries.updateElevationInfo(e)}},{key:"_forAllNodes",value:function(e){for(var t=0;t<this._nodePages.length;t++){var i=this._nodePages[t];if(i)for(var r=t*this.nodesPerPage,n=0;n<i.nodes.length;n++)e(i.nodes[n],r+n)}}},{key:"test",get:function(){var e=this;return{addNode:function(t,i){return e._addNode(t,i)}}}}]),e}(),V=new Map,U=function(){function e(t){(0,n.Z)(this,e),this.missing=t,this.update=new v.Z({deallocator:null}),this.add=new v.Z({deallocator:null}),this.remove=new v.Z({deallocator:null}),this.cancel=[]}return(0,a.Z)(e,[{key:"reset",value:function(e){this.add.clear(),this.update.clear(),this.cancel=e}}]),e}();function G(e){(0,f.pC)(e.node)&&((0,A.WD)(e.node.renderMbs),(0,A.VL)(e.node.serviceObbInRenderSR)),(0,f.pC)(e.ref)&&((0,A.WD)(e.ref.renderMbs),(0,A.VL)(e.ref.serviceObbInRenderSR))}function Z(e){return(0,A.HV)(e,-2)}function j(e){return(0,A.HV)(e,2)}function W(e,t){return t+(e?1:0)}function q(e,t){return(-2&e)===t}function B(e){return 1==(1&e)}function H(e,t){return 0===t?0:e/t|0}function Q(e,t){return 0===t?e:e%t}var z=[["maxScreenThreshold",F.w5.MaxScreenThreshold],["screenSpaceRelative",F.w5.ScreenSpaceRelative],["removedFeatureDiameter",F.w5.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",F.w5.DistanceRangeFromDefaultCamera]];var K=(0,a.Z)((function e(){(0,n.Z)(this,e),this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}));function Y(e){return Math.sqrt(e*(4/Math.PI))}var X=i(21765),J=function(){function e(t){(0,n.Z)(this,e),this.layerView=t,this._lodGlobalDirty=!1}return(0,a.Z)(e,[{key:"startNodeLoading",value:function(e,t,i,r){this._maxLodLevel=r.maxLodLevel,this._index=i,this._isNodeInScaleBounds=e,this._removeNodes=t}},{key:"shouldLoadNode",value:function(e){if((0,f.Wi)(e))return!1;var t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}},{key:"setLodGlobalDirty",value:function(){this._lodGlobalDirty=!0}},{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}},{key:"lodGlobalHandling",value:function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var t=this.layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));$.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,this.layerView.nodeCrossfadingEnabled);var r=$.length;this._removeNodes($,e);var n=$.length<r;return 0!==$.length&&(this._lodGlobalDirty=!0),$.clear(),n}},{key:"_lodGlobalHandling",value:function(e,t,i,r){if((0,f.Wi)(e))return!1;var n=e.index,a=this._index,s=this.layerView,o=a.nodeTraversalState(e),d=this._isChosenMaxLOD(o),u=!e.resources.hasFeatureData;if(d&&u)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;var l=s.isNodeLoaded(n);if(r&&l&&d){var h=!i&&this.hasNoVisibleChildren(e);s.fadeNode(n,X.B.FadeIn,!h)}var c=l&&(!s.isNodeFullyFadedIn||s.isNodeFullyFadedIn(n));if(l&&(s.updateNodeState(n,d?F.FE.Leaf:F.FE.Hole),d))return c&&this._removeChildrenRecursive(e),c;var v=e.childCount>0,_=v;if(v)for(var g=0;g<e.childCount;g++){var m=a.getChildIndex(n,g),p=a.getNode(m);(0,f.pC)(p)?a.isGeometryVisible(m)&&!this._lodGlobalHandling(p,t,i||c,r)&&this._isNodeInScaleBounds(p)&&(_=!1):a.isNodeVisible(m)&&(_=!1)}var y=l&&!d&&(_||$.length<t);y&&$.push(n),!r||y||!l||i||_||s.fadeNode(n,X.B.FadeIn,!1);var b=!e.resources.hasFeatureData;return _||c&&!y||b}},{key:"_removeChildrenRecursive",value:function(e){var t=this;this._index.traverseChildren(e,(function(e){return(t.layerView.isNodeLoaded(e.index)||t.layerView.isNodeReloading(e.index))&&$.push(e.index),e.childrenLoaded>0}))}},{key:"hasNoVisibleChildren",value:function(e){var t=this,i=!0;return this._index.traverseChildren(e,(function(e){return!(!i||!t._index.isNodeVisible(e.index))&&(t.layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0)})),i}},{key:"_childrenRequireLoading",value:function(e){var t=this,i=!1,r=!0;return this._index.traverseChildren(e,(function(e){if(!r||!t._index.isNodeVisible(e.index))return!1;var n=t._index.nodeTraversalState(e);return t._isChosenMaxLOD(n)&&t._index.isGeometryVisible(e.index)&&(i=!0),t.layerView.isNodeLoaded(e.index)?(r=!1,!1):e.childrenLoaded>0})),r&&i}},{key:"_isChosenMaxLOD",value:function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}]),e}(),$=new v.Z({deallocator:null}),ee=i(74165),te=i(15861),ie=i(14921),re=i(84652),ne=i(35995),ae=i(99048),se=i(28278),oe=i(36007),de=function(){function e(t,i,r,a,s,o){if((0,n.Z)(this,e),this.streamDataController=i,this.logger=r,this.defaultGeometrySchema=a,this.requiredAttributes=s,this.options=o,this.logLayer=t,this.layerUrl=t.parsedUrl.path,this.geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){var d=t.textureSetDefinitions;this.materialAndTextures=t.materialDefinitions.map((function(e){return(0,oe.R0)(d,e)}))}}return(0,a.Z)(e,[{key:"_load",value:function(e,t,i){return this.streamDataController.request(e,t,i)}},{key:"_loadAttribute",value:function(e,t,i){var r="".concat(this.layerUrl,"/nodes/").concat(e.resources.attributes,"/attributes/").concat(t.key,"/0");return this._load(r,"binary",i).then((function(e){return(0,se.qM)(t,e)}))}},{key:"loadAttributes",value:function(e,t,i){var r=this;return(0,g.as)(t.map((function(t){return r._loadAttribute(e,t.attributeStorageInfo,i)}))).then((function(i){for(var n={},a=0;a<t.length;++a)if(i[a].value)n[t[a].name]=i[a].value;else{if((0,g.D_)(i[a].error))throw i[a].error;r.logger.error("#loadAttributes",r.logLayer,"Failed to load attributeData for '".concat(t[a].name,"' on node '").concat(e.id,"'"),i[a].error)}return n}))}},{key:"loadNodeData",value:function(){var e=(0,te.Z)((0,ee.Z)().mark((function e(t,i){var r,n,a,s,o,d,u,l,h,c,v,_,g,m,p,y,b,x,C,k,N,D;return(0,ee.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null!=this.requiredAttributes&&t.resources.attributes?(0,ie.q6)(this.loadAttributes(t,this.requiredAttributes,i)):null,n=ce(this.geometryDefinitions,t),a=n.bufferDefinition,s=n.bufferIndex,o=!!t.resources.geometry,d=o?(0,ie.q6)(this._loadGeometry(t.resources.geometry,s,i)):null,!t.resources.hasSharedResource){e.next=12;break}return e.next=9,this._loadShared(t,i);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=null;case 13:if(u=e.t0,l=this.materialAndTextures&&t.resources.materialDefinition>=0?this.materialAndTextures[t.resources.materialDefinition]:null!=u?(0,oe.Pg)(u):null,h=l&&l.material,c=l&&l.textures,v="".concat(t.id),!(_=!o&&this.options.loadFeatureData)){e.next=25;break}return e.next=22,this._loadFeatureData(v,i);case 22:e.t1=e.sent,e.next=26;break;case 25:e.t1=null;case 26:if(g=e.t1,m=_?ue(g):{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:h}}],featureDataPosition:[0,0,0]},p=(0,f.Wi)(m)&&le(g),y=null!=c&&c.length>0?(0,ie.q6)(this.loadTextures(t,c,i)):null,b=null,x=null,!d){e.next=39;break}return e.t2=ie.w6,e.next=35,d;case 35:e.t3=e.sent,b=(0,e.t2)(e.t3),C=he(this.defaultGeometrySchema,u),x=(0,se.Es)(a,C);case 39:if(!y){e.next=47;break}return e.t5=ie.w6,e.next=43,y;case 43:e.t6=e.sent,e.t4=(0,e.t5)(e.t6),e.next=48;break;case 47:e.t4=null;case 48:if(k=e.t4,!r){e.next=57;break}return e.t8=ie.w6,e.next=53,r;case 53:e.t9=e.sent,e.t7=(0,e.t8)(e.t9),e.next=58;break;case 57:e.t7={};case 58:if(N=e.t7,D=N?{attributeData:N,loadedAttributes:this.requiredAttributes}:null,!(0,f.pC)(m)){e.next=62;break}return e.abrupt("return",{geometryData:m,attributeDataInfo:D,geometryBuffer:b,geometryDescriptor:x,requiredTextures:c,textureData:k});case 62:if(!(0,f.pC)(p)){e.next=64;break}return e.abrupt("return",{pointData:p,attributeDataInfo:D,geometryBuffer:b,geometryDescriptor:x,requiredTextures:c,textureData:k});case 64:throw new Error;case 65:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_loadShared",value:function(t,i){var r="".concat(this.layerUrl,"/nodes/").concat(t.resources.geometry,"/shared");return this._load(r,"json",i).then((function(t){return e._fixTextureEncodings(t),e._addAbsoluteHrefTexture(t,r),t}))}},{key:"_loadTexture",value:function(e,t,i,r,n,a){var s=!1;return n===ae.j.DDS_S3TC||n===ae.j.KTX2||n===ae.j.Basis?this._load(e,"binary",a).then((function(e){return{id:t,usage:i,data:e,encoding:n,downsampled:s}})):this._load(e,"image",a).then((function(e){var a=e;if(r&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),d=Math.ceil(e.height/2),u=document.createElement("canvas");u.width=o,u.height=d,u.getContext("2d").drawImage(e,0,0,o,d),a=u,s=!0}return{id:t,usage:i,data:a,encoding:n,downsampled:s}}))}},{key:"loadTextures",value:function(e,t,i){var r=this,n=this.options.uncompressedTextureDownsamplingEnabled,a=this.options.textureUsageMask;return Promise.all(t.map((function(t){if(0==(t.usage&a))return null;var s=(0,oe.nn)(t.encodings,r.options.textureEncodings);if(null==s)return r.logger.error("#loadTextures",r.logLayer,"No known encoding for texture found on node ".concat(e.id)),Promise.reject();var o=e.resources.texture||e.id,d="".concat(r.layerUrl,"/nodes/").concat(o,"/textures/").concat(s.name);return r._loadTexture(d,t.id,t.usage,n,s.encoding,i)})))}},{key:"_loadFeatureData",value:function(e,t){var i="".concat(this.layerUrl,"/nodes/").concat(e,"/features/0");return this._load(i,"json",t)}},{key:"_loadGeometry",value:function(e,t,i){var r="".concat(this.layerUrl,"/nodes/").concat(e,"/geometries/").concat(t);return this._load(r,"binary",i)}}],[{key:"_addAbsoluteHrefTexture",value:function(e,t){var i=e.textureDefinitions;if(null!=i)for(var r=0,n=Object.keys(i);r<n.length;r++){var a,s=n[r],o=(0,w.Z)(i[s].images);try{for(o.s();!(a=o.n()).done;){var d=a.value;Array.isArray(d.href)?d.hrefConcat=d.href.map((function(e){return(0,ne.hF)(e,t)})):d.hrefConcat=(0,ne.hF)(d.href,t)}}catch(u){o.e(u)}finally{o.f()}}}},{key:"_fixTextureEncodings",value:function(e){var t=e.textureDefinitions;if(null!=t)for(var i in t){var r=t[i];if(Array.isArray(r.encoding))for(var n=0;n<r.encoding.length;n++){var a=r.encoding[n];"data:"===a.substring(0,5)&&(r.encoding[n]=a.substring(5))}else{var s=r.encoding;"data:"===s.substring(0,5)&&(r.encoding=s.substring(5))}}}}]),e}();function ue(e){var t,i=(0,w.Z)(e.featureData);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.geometries;if(null!=n){var a,s=(0,w.Z)(n);try{for(s.s();!(a=s.n()).done;){var o=a.value;return{featureIds:[r.id],featureDataPosition:r.position,geometries:[o]}}}catch(d){s.e(d)}finally{s.f()}}}}catch(d){i.e(d)}finally{i.f()}return null}function le(e){var t,i=new Array,r=(0,w.Z)(e.featureData);try{for(r.s();!(t=r.n()).done;){var n=t.value;null!=n.position&&i.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}}catch(a){r.e(a)}finally{r.f()}return i}function he(e,t){if(!e||!t||!t.materialDefinitions)return e;var i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=(0,re.d9)(e)).vertexAttributes.region,e}function ce(e,t){var i={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return i;var r=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==r)return i;for(var n=0;n<r.length;n++){var a=r[n];if(null==a.compressedAttributes)i.bufferIndex=n,i.bufferDefinition=r[n];else if("draco"===a.compressedAttributes.encoding&&!(0,h.Z)("disable-feature:i3s-draco"))return i.bufferIndex=n,i.bufferDefinition=a,i}return i}var fe=function(){function e(t,i){(0,n.Z)(this,e),this.requester=t,this.apiKey=i,this.activeRequests=new Set}return(0,a.Z)(e,[{key:"busy",get:function(){return this.requester.busy}},{key:"request",value:function(e,t,i){var r=this,n=new AbortController,a=(0,g.$F)(i,(function(){return n.abort()})),s={signal:n.signal,query:{token:this.apiKey}},o=this.requester.request(e,t,s),d={response:o,abortController:n,abortHandle:a};return this.activeRequests.add(d),(0,g.Bx)(o,(function(){var e;d.abortController=null,null!==(e=d.abortHandle)&&void 0!==e&&e.remove(),d.abortHandle=null,r.activeRequests.delete(d)})),o}},{key:"cancelAll",value:function(){this.activeRequests.forEach((function(e){var t,i;null!==(t=e.abortController)&&void 0!==t&&t.abort(),e.abortController=null,null===(i=e.abortHandle)||void 0===i||i.remove()})),this.activeRequests.clear()}}]),e}(),ve=i(71353),_e=i(90045),ge=i(92183),me=i(95773),pe=i(92975),ye=i(23470),be=i(69691),xe=i(78935),Ce=i(8821),ke=1e5,Ne=function(){function e(t,i,r,a,s,o,d,u){var l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:{};(0,n.Z)(this,e),this._indexSR=t,this._renderCoordsHelper=i,this.clippingArea=s,this._elevationProvider=o,this._viewingMode=d,this._options=l,this._frustum=(0,me.Ue)(),this._useFrustumCulling=!1,this._poi=(0,ve.c)(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=(0,T.Ue)(),this._tmp1=(0,ve.c)(),this._tmp2=(0,ve.c)(),this._tmp3=(0,ve.c)(),this._tmp0=(0,ve.c)(),this._screenspaceErrorBias=l.screenspaceErrorBias||1,this._progressiveLoadFactor=l.progressiveLoadFactor||1,this.updateCamera(r,a),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(u),this._tmpPoint=(0,k.Tx)(0,0,0,t),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(this.engineSR.isWebMercator||(0,pe.QM)(this.engineSR)),this._indexSREllipsoidRadius=(0,ge.Iu)(this._indexSR).radius}return(0,a.Z)(e,[{key:"updateElevationInfo",value:function(e){null!=e?(this._elevationContext=xe.o.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext((0,Ce.bw)((0,Ce.WI)(e,!1)))):this._elevationContext=null}},{key:"updateCamera",value:function(e,t){this._useFrustumCulling=t,t&&(0,me.q_)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}},{key:"setPointOfInterest",value:function(e){this._poi=e}},{key:"updateScreenSpaceErrorBias",value:function(e){var t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}},{key:"updateClippingArea",value:function(e){this.clippingArea=e}},{key:"getElevationRange",value:function(e){if((0,f.Wi)(this._elevationContext))return null;var t=e.mbs[0],i=e.mbs[1],r=e.mbs[2],n=e.mbs[3],a="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds)return this._elevationProvider.getSphereElevationBounds(t,i,r,n,this._indexSR,a);var s=this._elevationProvider.getElevation(t,i,r,this._indexSR,a);return(0,f.pC)(s)?{min:s,max:s}:null}},{key:"getRenderMbs",value:function(e){var t=e.renderMbs;return(0,A.c$)(t)||((0,_e.c)(t,e.mbs),this._elevationContext&&t[3]<ke&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=(0,be.w7)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)),(0,x.st)(t,this._indexSR,t,this.engineSR)),t}},{key:"getVisibilityObb",value:function(e){if((0,f.pC)(e.visibilityObb))return e.visibilityObb;var t=e.serviceObb,i=.01*this._indexSREllipsoidRadius;return(0,f.Wi)(t)||!(0,A.vH)(t)||this._isECEFOBBInLocalMode&&t.halfSize.some((function(e){return e>i}))?null:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3],e.elevationRange),e.serviceObbInRenderSR)}},{key:"_computeRenderObb",value:function(e,t,i,r){if((0,f.Wi)(t))t=(0,T.Ue)();else if((0,A.vH)(t))return t;var n=0,a=0;if(this._elevationContext&&(0,f.pC)(r)&&Number.isFinite(r.min))switch(this._elevationContext.mode){case"relative-to-ground":n=this._elevationContext.geometryZWithOffset(e.center[2],this._renderCoordsHelper)+r.min-e.center[2],a=r.max-r.min;break;case"on-the-ground":n=r.min-e.center[2],a=r.max-r.min}else this._elevationContext&&i<ke&&(this._tmpPoint.x=e.center[0],this._tmpPoint.y=e.center[1],this._tmpPoint.z=e.center[2],n=(0,be.w7)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]);return a>0?((0,A.jv)(e,this._indexSR,this._tmpObb,this.engineSR,n),(0,A.gI)(this._tmpObb,0,a,this._viewingMode,t)):(0,A.jv)(e,this._indexSR,t,this.engineSR,n),t}},{key:"isNodeVisible",value:function(e){var t=this.getRenderMbs(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;var i=this.getVisibilityObb(e);return(0,f.pC)(i)?(0,T.pn)(i,this._frustum):(0,me.hr)(this._frustum,(0,ye.w)(t))}},{key:"isGeometryVisible",value:function(e){if(!this._useFrustumCulling)return!0;var t=e.geometryObb;return(0,f.pC)(t)?(0,T.pn)(t,this._frustum):this.isNodeVisible(e)}},{key:"_isMBSinClippingArea",value:function(e){return!!(0,f.Wi)(this.clippingArea)||(0,A.cr)(this.clippingArea,e)!==A.pD.OUTSIDE}},{key:"_screenSpaceDiameterMbs",value:function(e,t){var i=this.getRenderMbs(e),r=Math.sqrt((0,M.d)(i,this._camPos)),n=r-i[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}},{key:"calcCameraDistance",value:function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}},{key:"calcCameraDistanceToCenter",value:function(e){var t=this.getRenderMbs(e),i=(0,M.i)(t,this._camPos);return this._updateMinMaxDistance(i),i}},{key:"calcAngleDependentLoD",value:function(e){var t=this.getRenderMbs(e),i=t[3],r=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/(0,M.l)(t)+i)/(0,M.i)(t,this._camPos);return Math.min(1,r)}},{key:"hasLOD",value:function(e){return e.lodMetric!==F.w5.None}},{key:"_getDistancePlanarMode",value:function(e,t){var i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],a=i*i+r*r,s=t[3];if(a<=s*s)return Math.abs(n);var o=Math.sqrt(a)-s;return Math.sqrt(n*n+o*o)}},{key:"_getDistanceGlobeMode",value:function(e,t){var i=(0,M.l)(t),r=(0,M.l)(e)-i;(0,M.g)(this._tmp0,e,(0,M.e)(e,t)/(0,M.p)(e));var n=(0,M.d)(t,this._tmp0),a=t[3];if(n<=a*a)return Math.abs(r);var s=(0,M.g)(this._tmp0,t,1/i),o=i,d=a*a/2/o,u=(0,M.g)(this._tmp1,s,o-d),l=e,h=(0,M.b)(this._tmp2,l,u),c=(0,M.b)(this._tmp2,h,(0,M.g)(this._tmp3,s,(0,M.e)(s,h))),f=(0,M.a)(this._tmp2,u,(0,M.g)(this._tmp2,c,a/(0,M.l)(c))),v=(0,M.i)(l,f);if(r>=2e5){var _=(0,M.b)(this._tmp1,l,f),g=(0,M.e)(_,s)/(0,M.l)(_);g<.08&&(g=1e-4),v/=g}return v}},{key:"_getDistance",value:function(e,t){return this.engineSR===(0,ge.rS)(this.engineSR)?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)}},{key:"_updateMinMaxDistance",value:function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}},{key:"getLodLevel",value:function(e){if(e.lodMetric===F.w5.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){var t=this._progressiveLoadFactor*this._screenspaceErrorBias,i=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}},{key:"evaluateLODmetric",value:function(e,t){switch(e.lodMetric){case F.w5.ScreenSpaceRelative:var i=this.getRenderMbs(e),r=this._getDistance(this._camPos,i),n=2*r/this._screenSizeFactor,a=r+i[3];return this._updateMinMaxDistance(a),e.maxError*t<=n;case F.w5.MaxScreenThreshold:var s=this._screenSpaceDiameterMbs(e,e.mbs[3]*t);return this._options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError;case F.w5.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case F.w5.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}},{key:"distToPOI",value:function(e){var t=this.getRenderMbs(e);return(0,M.i)(t,this._poi)-t[3]}},{key:"distCameraToPOI",value:function(){return(0,M.i)(this._camPos,this._poi)}}]),e}(),De=i(65206),we=i(45888),Ie=i(69787),Pe=c.Z.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),Se=1e-4,Le=function(e){(0,s.Z)(i,e);var t=(0,o.Z)(i);function i(e){var r;return(0,n.Z)(this,i),(r=t.call(this,e)).screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingProgress=1,r.leavesReached=!1,r.scaleVisibilityEnabled=!0,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._newLoadingNodes=new v.Z({deallocator:null}),r._loadedNodeScales=new Map,r._modificationsNodeFilteringArray=new v.Z,r._downloadingCount=0,r._loadingNodes=new Map,r._updatingNodes=new Map,r._progressMaxNumNodes=1,r._requiredAttributes=new Array,r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r._disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new l.Z,r._idleQueue=new N.b,r._elevationUpdateNodes=new v.Z({deallocator:null}),r._errorCount=0,r}return(0,a.Z)(i,[{key:"isMeshPyramid",get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"useMaximumNumberOfFeatures",get:function(){return!this.isMeshPyramid&&((0,f.Wi)(this.layer.priority)||"High"===this.layer.priority)}},{key:"indexStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(we.Bh.I3S_INDEX);return new fe(e,this.layer.apiKey)}},{key:"dataStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(we.Bh.I3S_DATA);return new fe(e,this.layer.apiKey)}},{key:"crsVertex",get:function(){return(0,A.T2)(this.layer)}},{key:"crsIndex",get:function(){return(0,A.tp)(this.layer)}},{key:"layer",get:function(){return this.layerView.i3slayer}},{key:"rootNodeVisible",get:function(){if((0,f.pC)(this._index)){var e=this._index.rootNode;if((0,f.pC)(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}},{key:"index",get:function(){return this._index}},{key:"initialize",value:function(){var e=this,t=this.layerView,i=this.layer;this._disableMemCache=!t.loadCachedGPUData||!t.addCachedGPUData,this._lodHandling=new J(t),this._defaultGeometrySchema=i.store.defaultGeometrySchema,this.disableIDBCache=(0,h.Z)("disable-feature:idb-cache"),"fields"in i&&(this._fields=i.fields,this._attributeStorageInfo=i.attributeStorageInfo),this.addResolvingPromise(Promise.all([i.indexInfo,i.when(),t.when()]).then((function(n){var a=(0,r.Z)(n,1)[0];if(!e.destroyed&&t&&!t.destroyed){var s=t.view,o=s.resourceController;e._setClippingArea(s.clippingArea),e.own([(0,m.YP)((function(){var e,t;return null===s||void 0===s||null===(e=s.pointsOfInterest)||void 0===e||null===(t=e.focus)||void 0===t?void 0:t.renderLocation}),(function(t){return e._pointOfInterestChanged(t)}),m.nn),(0,m.YP)((function(){return o.memoryController.memoryFactor}),(function(){return e._setCameraDirty()}),m.Z_),(0,m.YP)((function(){return t.suspended}),(function(t){var i=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},r=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=i,e._idleStateCallbacks.idleEnd=r):e._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(i,r)}),m.nn),L(t.view.resourceController.scheduler,{update:function(t,i){return e._frame(t,i)},needsUpdate:function(){return e.updating}}),(0,m.YP)((function(){return t.uncompressedTextureDownsamplingEnabled}),(function(){return e.restartNodeLoading()})),(0,m.YP)((function(){return[e.featureTarget,e.fixedFeatureTarget]}),(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),(0,m.YP)((function(){var e;return null===(e=s.state)||void 0===e?void 0:e.contentCamera}),(function(){return e._setCameraDirty()})),(0,m.YP)((function(){return i.elevationInfo}),(function(t){return e._elevationInfoChanged(t)})),(0,m.YP)((function(){return i.effectiveScaleRange}),(function(){return e._scaleBoundsChanged()})),(0,m.YP)((function(){return t.lodFactor}),(function(){return e._setCameraDirty()})),(0,m.YP)((function(){return t.availableFields}),(function(){return e._requiredFieldsChange()})),(0,m.YP)((function(){return t.holeFilling}),(function(t){return(0,f.pC)(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new Ne(e.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||e.isGraphics3D,e._clippingArea,e.isMeshPyramid?s.basemapTerrain:s.elevationProvider,(0,D.wg)(s.viewingMode),e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new R(i,a,e.indexStreamController,e._viewportQueries,Pe,t.holeFilling,(function(e){return t.isNodeLoaded(e)}),(function(e){return t.isNodeReloading(e)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,F.FE.Leaf)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.indexStreamController.busy}),(function(e){return t.computeVisibilityObb?t.computeVisibilityObb(e):null}),null!==t&&void 0!==t&&t.computeNodeFiltering?function(e){return t.computeNodeFiltering(e)}:void 0),e._index.updateElevationInfo(e.layer.elevationInfo,e.isMeshPyramid),e._index.imModificationsChanged(!!t.hasModifications),e._startNodeLoading()}}))),this._tmpPoint=(0,k.Tx)(0,0,0,this.crsIndex)}},{key:"updateNodeModificationStatus",value:function(e){var t=this,i=this._index,r=this.layerView;(0,f.pC)(i)&&(null===r||void 0===r?void 0:r.updateNodeModificationStatus)&&(this._modificationsNodeFilteringArray.clear(),e.forAll((function(e){var r=i.getNode(e);(0,f.pC)(r)&&t._modificationsNodeFilteringArray.push(r)})),r.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}},{key:"destroy",value:function(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,Oe.prune(),(0,f.pC)(Me)&&(Me.hide(),Me=null)}},{key:"_getRequiredAttributes",value:function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((function(i){var r=Ae(e,i),n=Ae(t,i);return r>=0&&n>=0?{index:r,name:t[n].name,field:t[n],attributeStorageInfo:e[r]}:null})).filter((function(e){return null!=e&&e.name!==i}))}},{key:"_requiredFieldsChange",value:function(){var e=this._getRequiredAttributes();Fe(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}},{key:"requestUpdate",value:function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}},{key:"_setClippingArea",value:function(e){var t=(0,C.Ue)();(0,De.G)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}},{key:"_pointOfInterestChanged",value:function(e){(0,f.pC)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),(0,f.pC)(this._index)&&(this._index.progressiveLoadPenalty=Re.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}},{key:"updateClippingArea",value:function(e){this._setClippingArea(e),(0,f.pC)(this._viewportQueries)&&(0,f.pC)(this._index)&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}},{key:"_setCameraDirty",value:function(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateElevationChanged",value:function(e,t){var i=this._index;if((0,f.Wi)(i)||(0,f.Wi)(i.rootNode))return null;var r=this._elevationUpdateNodes;return r.clear(),(0,A.tS)(e,t,i.rootNode,this.crsIndex,i,(function(e){return r.push(e.index)})),r.length&&(r.forAll((function(e){return i.updateElevationChanged(e)})),this._setCameraDirty()),r}},{key:"getParentIndex",value:function(e){return(0,f.pC)(this._index)&&this._index.getParentIndex(e)}},{key:"removeAllGeometryObbs",value:function(){(0,f.pC)(this._index)&&this._index.removeAllGeometryObbs()}},{key:"_elevationInfoChanged",value:function(e){(0,f.Wi)(this._index)||(this._index.updateElevationInfo(e,this.isMeshPyramid),this._setCameraDirty())}},{key:"_updateScaleHandles",value:function(){var e=this,t="scale-bounds";this._handles.remove(t),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),t)}},{key:"_scaleBoundsChanged",value:function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}},{key:"_scaleUpdateHandler",value:function(e){this._updateScaleInBoundingRect(e.extent,e.spatialReference),this._setCameraDirty()}},{key:"_updateScaleInBoundingRect",value:function(e,t){var i=this,r=this._index;if(!(0,f.Wi)(r)){var n=r.rootNode;!(0,f.Wi)(n)&&(0,x.dH)(e,t,Ve,this.crsIndex)&&this._loadedNodeScales.forEach((function(e,t){var n=r.getNode(t);(0,f.pC)(n)&&(0,C.hr)(Ve,n.mbs)&&i._loadedNodeScales.set(t,i._computeScale(n))}))}}},{key:"restartNodeLoading",value:function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}},{key:"schedule",value:function(e,t){return this._idleQueue.push(e,t)}},{key:"reschedule",value:function(e,t){return this._idleQueue.unshift(e,t)}},{key:"isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"areScaleBoundsActive",get:function(){var e=(0,Ie.lu)(this.layer),t=e.minScale,i=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||i>0)}},{key:"unloadedMemoryEstimate",get:function(){return(0,f.Wi)(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}},{key:"indexDepth",get:function(){return(0,f.pC)(this._index)?this._index.maxLevel:0}},{key:"disableMemCache",set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}},{key:"_frame",value:function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||(0,f.Wi)(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}},{key:"_processLogError",value:function(e,t){try{this._process(e,t)}catch(i){this._errorCount<50?Pe.error("Error during processing: "+i):50===this._errorCount&&Pe.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}},{key:"_process",value:function(e,t){var i=this;this._restartNodeLoading&&this._startNodeLoading(),null==this._nodeLoader||(0,f.Wi)(this._index)||(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((function(){return i._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return i._processCache(e)})),this.isIntegratedMesh&&(e.enabled=!0),e.run((function(){return i._processNodes(e,t)})),this._idleQueue.runTask(e),e.run((function(){return i._prefetchIndex()})),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((function(){return i._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating())}},{key:"_processIndex",value:function(e){var t=this;if((0,f.Wi)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),e,(function(e){return t.updateNodeModificationStatus(e)})),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var i=this._index.featureEstimate.leavesReached;this._index.isLoading()||i===this._get("leavesReached")||this._set("leavesReached",i)}return this._index.load()}},{key:"_prefetchIndex",value:function(){return!((0,f.Wi)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}},{key:"_updateFeatureLOD",value:function(){if(this.useMaximumNumberOfFeatures&&!(0,f.Wi)(this._index)&&!(0,f.Wi)(this._viewportQueries)){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=Se)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var r=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=r;var n=this.lod,a=this._index.checkFeatureTarget(t,n);a!==n&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=Se)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Se,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}}},{key:"_processCache",value:function(e){var t=this._index;if((0,f.Wi)(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var i=this._newLoadingNodes.pop(),r=t.getParent(i);(0,f.pC)(r)&&!this.layerView.isNodeLoaded(r.index)&&this._isNodeInScaleBounds(r);r=t.getParent(r.index))if(this._enableFromGPUCache(r,F.FE.Hole)){e.madeProgress();break}return e.hasProgressed}},{key:"_processNodes",value:function(e,t){if((0,f.Wi)(this._index))return!1;var i=(this._isIdle?100:2)-this._loadingNodes.size,r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!e.done;)this.layerView.removeNode(r.remove.pop()),e.madeProgress();for(;r.update.length>0&&!e.done;){var n=this._index.getNode(r.update.pop());(0,f.pC)(n)&&(this._updateLoadedNode(n),e.madeProgress())}for(;r.add.length>0&&!e.done&&i>0;){--i;var a=this._index.getNode(r.add.back());if((0,f.Wi)(a)||a.cacheState!==F.Hw.Cached&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed}},{key:"_cancelAllNodes",value:function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()}},{key:"_cancelNode",value:function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}},{key:"_hasNodeLoadToken",value:function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<we.NT&&!this.dataStreamController.busy}},{key:"_evaluateUpdating",value:function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?0:1;else{var i=((0,f.pC)(this._index)?this._index.getIndexMissing():0)+3*((0,f.pC)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}this.updating=e,this.updatingProgress=t}},{key:"_updateViewData",value:function(){if(this._cameraDirty&&!(0,f.Wi)(this._index)&&!(0,f.Wi)(this._viewportQueries)){var e=this.layerView.view,t=e.state,i=t.contentCamera,r=t.fixedContentCamera;this.screenSizeFactor=1/(i.perScreenPixelRatio/2),this._viewportQueries.updateCamera(i,!r||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Re.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}}},{key:"_getProgressiveLoadFactor",value:function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}},{key:"lod",get:function(){return this._featureLOD*this.baseLOD}},{key:"baseLOD",get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}},{key:"lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}},{key:"isGeometryVisible",value:function(e){return(0,f.pC)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"updateVisibility",value:function(e){(0,f.pC)(this._index)&&this._index.invalidateNodeVisibilityCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){(0,f.pC)(this._index)&&this._index.invalidateGeometryVisibility(e)}},{key:"invalidateVisibilityObbs",value:function(){(0,f.pC)(this._index)&&this._index.invalidateVisibilityObbs()}},{key:"modificationsChanged",value:function(){(0,f.pC)(this._index)&&this._index.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}},{key:"_shouldLoadNode",value:function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&!((0,f.Wi)(this._index)||!this._index.isGeometryVisible(e.index))&&this._isNodeInScaleBounds(e)}},{key:"_shouldDropNode",value:function(e){if((0,f.Wi)(this._viewportQueries))return!1;var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}},{key:"_startNodeLoading",value:function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!(this._updatesDisabled||(0,f.Wi)(t)||(0,f.Wi)(this._viewportQueries))){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var i={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new de(this.layer,this.dataStreamController,Pe,this._defaultGeometrySchema,this._requiredAttributes,i),t.requestUpdate(),this._lodHandling.startNodeLoading((function(t){return e._isNodeInScaleBounds(t)}),(function(t,i){return e._removeNodes(t,i,Te.fadeout)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}}},{key:"isNodeLoading",value:function(){return null!=this._nodeLoader&&null!=this._index}},{key:"cancelNodeLoading",value:function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}},{key:"_removeInvisibleNodes",value:function(e){var t=this,i=this._index;if((0,f.Wi)(i)||(0,f.Wi)(this._viewportQueries))return!1;Oe.clear(),this.layerView.getLoadedNodeIndices(Oe);var r=0===this._viewportQueries.maxDistance,n=r?function(){return!1}:function(e){return t._shouldDropNode(e)};return Oe.filterInPlace((function(e){var r=i.getNode(e);return(0,f.Wi)(r)||!i.isGeometryVisible(e)||n(r)||!t._isNodeInScaleBounds(r)})),Oe.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(Oe,e,Te.pop),!(r&&this.lodDropFactor<1)&&(0===Oe.length||(Oe.clear(),!1))}},{key:"markNodeToRemove",value:function(e){Oe.push(e)}},{key:"removeMarkedNodes",value:function(){this._removeNodes(Oe,I.G5,Te.pop)}},{key:"_removeNodes",value:function(e,t,i){var r=e.length;if(0!==r&&!t.done){for((0,f.pC)(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){var n=e.pop(),a=this._index;i===Te.fadeout&&this.layerView.nodeFadeoutEnabled&&(0,f.pC)(a)&&a.isGeometryVisible(n)?this.layerView.fadeNode(n,X.B.FadeOut,!0):this.layerView.removeNode(n),t.madeProgress()}if(this._loadedNodeScales.size>0)for(var s=e.length;s<r;s++){var o=e.data[s];this._loadedNodeScales.delete(o)}}}},{key:"_needsUpdate",value:function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}},{key:"_updateLoadedNode",value:function(e){var t=this,i=new AbortController;this._updatingNodes.set(e.index,i),(Fe(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,i.signal)).then((function(r){return t.schedule((function(){return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:r},i.signal)}),i.signal)})).catch((function(r){if(!(0,g.D_)(r))return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}},i.signal)})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()}},{key:"_loadNode",value:function(e){var t=this;if(this._loadingNodes.has(e.index))Pe.error("already loading node "+e.index);else{var i=new AbortController;this._loadingNodes.set(e.index,i),this._evaluateUpdating(),this._loadAndAddNode(e,i.signal).then((function(r){r&&(0,f.pC)(t._index)&&t._loadingNodes.get(e.index)===i&&(t._loadingNodes.delete(e.index),t._index.requestUpdate())})).catch((function(e){if(!(0,g.D_)(e))throw e})).finally((function(){t._loadingNodes.get(e.index)===i&&t._loadingNodes.delete(e.index),t._evaluateUpdating()}))}}},{key:"_loadAndAddNode",value:function(e,t){return e.cacheState===F.Hw.Uncached?this._loadUncached(e,t).then((function(){return!1})):this._loadCached(e,t).then((function(t){return!t&&(e.cacheState=F.Hw.Uncached,!0)})).catch((function(t){return!(0,g.D_)(t)&&(e.cacheState=F.Hw.Uncached,!0)}))}},{key:"_enableFromGPUCache",value:function(e,t){if(this._disableMemCache||(0,f.Wi)(this._index))return!1;if(t===F.FE.Hole&&!this._index.useNodeAsHole(e.index))return!0;var i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}},{key:"_loadCachedGPUData",value:function(e){var t=this.layerView.loadCachedGPUData(e);return(0,f.pC)(t)&&(0,f.pC)(t.attributeInfo)&&Fe(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}},{key:"_nodeAdded",value:function(){(0,f.pC)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateLoadStatus",value:function(e,t){var i=this._index;(0,f.pC)(i)&&i.updateChildrenLoaded(e,t?1:-1)}},{key:"_loadCached",value:function(e,t){var i=this;if(this._enableFromGPUCache(e,F.FE.Leaf))return Promise.resolve(!0);var r=this.layerView;return!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData?this.schedule((function(){return r.loadCachedNodeData(e,t,(function(t,r){return i._nodeLoader.loadTextures(e,t,r)}))}),t).then((function(n){if((0,f.Wi)(n))return!1;var a=i._requiredAttributes;return i.reschedule((function(){return i._nodeLoader.loadAttributes(e,a,t)}),t).then((function(s){return i.reschedule((function(){return r.addCachedNodeData(e,n,{loadedAttributes:a,attributeData:s},t)}),t)})).then((function(){return i._nodeAdded(),!0}))})):Promise.resolve(!1)}},{key:"_loadUncached",value:function(e,t){var i=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw i._downloadingCount--,e})).then((function(r){return i._downloadingCount--,i.schedule((function(){return i.layerView.addNode(e,r,t)}),t)})).then((function(){i._nodeAdded(),e.cacheState=F.Hw.Cached})).catch((function(t){if(!(0,g.D_)(t))throw Pe.error("#loadNodeData()",i.layer,"Failed to load node '".concat(e.id,"'"),t),e.failed=!0,(0,f.pC)(i._index)&&i._index.requestUpdate(),t}))}},{key:"_updateIdleState",value:function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&(0,f.pC)(this._index)&&this._index.resetFailedNodes())}},{key:"_getScale",value:function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);var t=this._computeScale(e);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}},{key:"_computeScale",value:function(e){this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=e.mbs[3];return this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,t)}},{key:"_isNodeInScaleBounds",value:function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),i=(0,Ie.lu)(this.layer),r=i.minScale,n=i.maxScale;return(0,Ie.rs)(t,r,n)}},{key:"updateStats",value:function(e){e.index=(0,f.pC)(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),(0,f.pC)(this._index)&&this._index.updateStats(e)}},{key:"test",get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){(0,f.pC)(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}}},{key:"notifyLODUpdate",value:function(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),(0,f.pC)(this._index)&&this._index.requestUpdate()}},{key:"geometryFilterChanged",value:function(e){var t=this._index;(0,f.pC)(t)&&t.layerFilterChanged(e),this.requestUpdate()}}]),i}((0,_.v)(u.Z));(0,d._)([(0,p.Cb)({readOnly:!0})],Le.prototype,"isMeshPyramid",null),(0,d._)([(0,p.Cb)({readOnly:!0})],Le.prototype,"isGraphics3D",null),(0,d._)([(0,p.Cb)({readOnly:!0})],Le.prototype,"useMaximumNumberOfFeatures",null),(0,d._)([(0,p.Cb)({readOnly:!0})],Le.prototype,"indexStreamController",null),(0,d._)([(0,p.Cb)({readOnly:!0})],Le.prototype,"dataStreamController",null),(0,d._)([(0,p.Cb)({readOnly:!0})],Le.prototype,"crsVertex",null),(0,d._)([(0,p.Cb)({readOnly:!0})],Le.prototype,"crsIndex",null),(0,d._)([(0,p.Cb)()],Le.prototype,"screenSizeFactor",void 0),(0,d._)([(0,p.Cb)()],Le.prototype,"featureTarget",void 0),(0,d._)([(0,p.Cb)()],Le.prototype,"fixedFeatureTarget",void 0),(0,d._)([(0,p.Cb)()],Le.prototype,"layerView",void 0),(0,d._)([(0,p.Cb)()],Le.prototype,"layer",null),(0,d._)([(0,p.Cb)({})],Le.prototype,"updating",void 0),(0,d._)([(0,p.Cb)({})],Le.prototype,"updatingProgress",void 0),(0,d._)([(0,p.Cb)({readOnly:!0})],Le.prototype,"leavesReached",void 0),(0,d._)([(0,p.Cb)({constructOnly:!0})],Le.prototype,"scaleVisibilityEnabled",void 0),(0,d._)([(0,p.Cb)({readOnly:!0,dependsOn:[]})],Le.prototype,"rootNodeVisible",null),Le=(0,d._)([(0,b.j)("esri.layers.graphics.controllers.I3SOnDemandController")],Le);var Me,Oe=new v.Z({deallocator:null});function Fe(e,t){return(0,f.pC)(e)&&e.length===t.length&&e.every((function(e){return Ae(t,e.name)>=0}))}function Ae(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}var Te,Ee,Re={factorIM:.2,factor3dObject:.05,distancePenalty:10},Ve=(0,C.Ue)();(Ee=Te||(Te={}))[Ee.pop=0]="pop",Ee[Ee.fadeout=1]="fadeout";var Ue=Le},2296:function(e,t,i){i.d(t,{l:function(){return w}});var r=i(93433),n=i(74165),a=i(15861),s=i(29439),o=i(37762),d=i(15671),u=i(43144),l=i(76200),h=i(63780),c=i(14921),f=i(59896),v=i(32718),_=i(92026),g=i(66978),m=i(6291),p=i(21149);function y(e,t,i){return b.apply(this,arguments)}function b(){return b=(0,a.Z)((0,n.Z)().mark((function e(t,i,r){var a,s,o,d;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=i.clone(),t.capabilities.query.supportsMaxRecordCountFactor&&(i.maxRecordCountFactor=C(t)),a=x(t),s=t.capabilities.query.supportsPagination,i.start=0,i.num=a,o=null;case 4:return e.next=6,t.source.queryFeaturesJSON(i,r);case 6:if(d=e.sent,(0,_.Wi)(o)?o=d:o.features=o.features.concat(d.features),o.exceededTransferLimit=d.exceededTransferLimit,s&&d.exceededTransferLimit){e.next=9;break}return e.abrupt("break",12);case 9:i.start+=a;case 10:e.next=4;break;case 12:return e.abrupt("return",o);case 13:case"end":return e.stop()}}),e)}))),b.apply(this,arguments)}function x(e){return C(e)*function(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function C(e){return e.capabilities.query.supportsMaxRecordCountFactor?p.Z.MAX_MAX_RECORD_COUNT_FACTOR:1}var k,N,D=v.Z.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides"),w=function(){function e(t,i){var r=this;(0,d.Z)(this,e),this.layer=t,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=new AbortController,this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=S,this.memCache=i.newCache("".concat(t.uid,"-attribute-overrides")),this.pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((function(){return r.pendingFetchAbortController=null}))}return(0,u.Z)(e,[{key:"destroy",value:function(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null}},{key:"createInteractiveEditSession",value:function(e){var t=this;this.changedObjectIds.add(e),(0,_.Wi)(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);var i=this.interactiveEditingSessions,r=new I(e,{rollback:function(){(0,h.Od)(i,r),0===i.length&&(t.interactiveEditingSessions=null)},commit:function(i){var r,n=(0,o.Z)(i);try{for(n.s();!(r=n.n()).done;){var a=(0,s.Z)(r.value,2),d=a[0],u=a[1];t.updateValue(e,d,u)}}catch(l){n.e(l)}finally{n.f()}}});return i.unshift(r),r}},{key:"apply",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i,r){var a,s,o,d,u,l,h;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,_.Wi)(i)){e.next=2;break}return e.abrupt("return");case 2:if(a=i.loadedAttributes,s=i.attributeData,!(0,_.Wi)(a)&&0!==a.length&&!(0,_.Wi)(s)){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,(0,g.Hl)(this.pendingFetchChangedObjectIds,r);case 7:if(0!==this.changedObjectIds.size){e.next=9;break}return e.abrupt("return");case 9:return o={loadedAttributes:a,attributeData:s},d=this._getOverridesFromCache(t,o,this.changedObjectIds),u=d.objectIds,l=d.fieldNames,e.next=15,this._queryOverridesFromAssociatedLayer(u,l,r);case 15:h=e.sent,(0,_.Wi)(h)||this._processOverridesFromAssociatedLayer(t,h,l,o);case 17:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"updateValue",value:function(e,t,i){this.changedObjectIds.add(e),this._cacheValue(e,t,i)}},{key:"_cacheValue",value:function(e,t,i){this.memCache.put(this._getCacheKey(e,t),i,this._memCacheValueSize(i))}},{key:"_getOverridesFromCache",value:function(e,t,i){var r,n=t.loadedAttributes,a=t.attributeData,s=new Set,d=new Array,u=(0,o.Z)(n);try{for(u.s();!(r=u.n()).done;){var l=r.value;d[l.index]=a[l.name]}}catch(p){u.e(p)}finally{u.f()}for(var h=new Set,c=0;c<e.length;c++){var f=e[c];if(i.has(f)){var v,_=(0,o.Z)(n);try{for(_.s();!(v=_.n()).done;){var g=v.value,m=this._fromCache(f,g.index);void 0===m?(s.add(f),h.add(g.name)):d[g.index][c]=m}}catch(p){_.e(p)}finally{_.f()}}}return{objectIds:Array.from(s),fieldNames:Array.from(h)}}},{key:"_fromCache",value:function(e,t){var i=this._fromInteractiveEditingSession(e,t);if(void 0!==i)return i;var r=this._getCacheKey(e,t);return this.memCache.get(r)}},{key:"_fromInteractiveEditingSession",value:function(e,t){if(!(0,_.Wi)(this.interactiveEditingSessions)){var i,r=(0,o.Z)(this.interactiveEditingSessions);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n.objectId===e){var a=n.get(t);if(void 0!==a)return a}}}catch(s){r.e(s)}finally{r.f()}}}},{key:"_getCacheKey",value:function(e,t){return"".concat(e,"-").concat(t)}},{key:"_queryOverridesFromAssociatedLayer",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,i,a){var s,o,d,u;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length&&0!==i.length){e.next=2;break}return e.abrupt("return",null);case 2:return t=t.sort((function(e,t){return e-t})),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this._logMaximumObjectsExceededWarning()),s=(0,_.Wg)(this.layer.associatedLayer),(o=s.createQuery()).where="1=1",o.returnGeometry=!1,o.outFields=[s.objectIdField].concat((0,r.Z)(i)),o.cacheHint=!0,o.objectIds=t,d=x(s),u=t.length>d?(0,h.vr)(t,d).map((function(e){var t=o.clone();return t.objectIds=e,(0,c.mt)(y(s,t,{signal:a}))})):[(0,c.mt)(y(s,o,{signal:a}))],e.next=8,Promise.all(u);case 8:return e.abrupt("return",e.sent.reduce((function(e,t){return e.concat(t.ok?t.value.features:[])}),[]));case 9:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_logMaximumObjectsExceededWarning",value:function(){var e="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat((0,m.uf)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service"),t=this.layer.portalItem;t&&t.loaded?e+=" (".concat(t.portal.url,"/home/item.html?id=").concat(t.id,"#settings)"):e+=" (".concat(this.layer.parsedUrl.path,")"),D.warn("#queryOverrides()",this.layer.title,"".concat(e,"."))}},{key:"_processOverridesFromAssociatedLayer",value:function(e,t,i,r){var n,a=r.loadedAttributes,s=r.attributeData,d=(0,_.Wg)(this.layer.associatedLayer).objectIdField,u=i.map((function(e){return s[e]})),l=new Map(a.map((function(e){return[e.name,e.index]}))),h=i.map((function(e){return l.get(e)})),c=new Map(Array.from(e,(function(e,t){return[e,t]}))),f=(0,o.Z)(t);try{for(f.s();!(n=f.n()).done;)for(var v=n.value,g=v.attributes[d],m=0;m<i.length;m++){var p=h[m],y=c.get(g),b=v.attributes[i[m]];u[m][y]=b,this._cacheValue(g,p,b)}}catch(x){f.e(x)}finally{f.f()}}},{key:"_memCacheValueSize",value:function(e){return"string"==typeof e?(0,f.hH)(e):(0,f.G3)()}},{key:"_fetchChangedObjectIds",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var i,r,a,s,o,d,u,h,f,v,g;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.layer,e.next=3,s.load({signal:t});case 3:if(this.changedObjectIds.clear(),!(0,_.Wi)(s.associatedLayer)&&null!==(i=s.associatedLayer.capabilities)&&void 0!==i&&null!==(r=i.operations)&&void 0!==r&&r.supportsChangeTracking){e.next=6;break}return e.abrupt("return");case 6:if(o=this._getFetchChangedObjectIdsServerGen(),!(0,_.Wi)(o)){e.next=9;break}return e.abrupt("return",null);case 9:return d=s.associatedLayer.layerId,e.next=12,(0,c.q6)((0,l.default)("".concat(s.associatedLayer.url,"/extractChanges"),{method:"post",query:{f:"json",returnIdsOnly:!0,layers:"".concat(d),returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:d,serverGen:o}])},timeout:P,signal:t}));case 12:if(u=e.sent,h=u.ok&&null!==(a=u.value.data)&&void 0!==a&&a.edits?(0,_.U2)(u.value.data.edits[0],"objectIds","updates"):null,(0,_.pC)(h))for((f=Math.min(this._maximumNumberOfEditOVerrides,h.length))<h.length&&(this.warnMaximumChangedObjectsExceeded=!0),v=h.sort((function(e,t){return e-t})),g=0;g<f;g++)this.changedObjectIds.add(v[g]);case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getFetchChangedObjectIdsServerGen",value:function(){var e=this.layer;if((0,_.pC)(e.serviceUpdateTimeStamp)&&(0,_.pC)(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;var t=e.associatedLayer;return(0,_.pC)(t)&&(0,_.pC)(t.serverGens)&&(0,_.pC)(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}},{key:"test",get:function(){var e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}}]),e}(),I=function(){function e(t,i){(0,d.Z)(this,e),this.objectId=t,this.options=i,this.updates=new Map,this.state=k.ACTIVE}return(0,u.Z)(e,[{key:"get",value:function(e){return this.updates.get(e)}},{key:"set",value:function(e,t){this.isActive&&this.updates.set(e,t)}},{key:"rollback",value:function(){this.isActive&&(this.state=k.ROLLED_BACK,this.options.rollback())}},{key:"commit",value:function(){this.isActive&&(this.state=k.COMMITTED,this.options.commit(this.updates),this.updates.clear())}},{key:"isActive",get:function(){return this.state===k.ACTIVE}}]),e}();(N=k||(k={}))[N.ACTIVE=0]="ACTIVE",N[N.COMMITTED=1]="COMMITTED",N[N.ROLLED_BACK=2]="ROLLED_BACK";var P=1e4,S=5e4},36007:function(e,t,i){i.d(t,{RE:function(){return P},cU:function(){return D},dY:function(){return N},R0:function(){return y},Pg:function(){return k},K0:function(){return S},nn:function(){return L}});var r,n=i(4942),a=i(93169),s=i(16889),o=i(92026),d=i(99048),u=i(15671),l=i(43144),h=i(66978),c=function(){function e(t,i){var r=this;(0,u.Z)(this,e),this._textureRep=t,this._disposed=!1;var n=this._textureRep.acquire(i);(0,h.y8)(n)?(n.then((function(e){r._disposed?(0,o.RY)(e):r._textureRef=e})),this.loadPromise=n):this._textureRef=n}return(0,l.Z)(e,[{key:"dispose",value:function(){this._textureRef=(0,o.RY)(this._textureRef),this._disposed=!0}},{key:"glTexture",get:function(){return(0,o.pC)(this._textureRef)?this._textureRef.glTexture:null}}]),e}(),f=i(41481),v=i(26461),_=i(86097),g=i(68401),m=i(1487),p=i(8548);function y(e,t){var i=new Map,r=function(e,t){if((0,o.Wi)(e))return-1;if(i.has(e.id)){var r=i.get(e.id);return r.usage|=t,r.id}var n=i.size;return i.set(e.id,{id:n,usage:t}),n},n=t.pbrMetallicRoughness,a=n&&n.baseColorFactor,s=t.emissiveFactor,u=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!n||null==n.metallicRoughnessTexture&&1===n.roughnessFactor&&(1===n.metallicFactor||0===n.metallicFactor)),l=u?f.Fw[0]:n?n.metallicFactor:1,h=u?f.Fw[1]:n?n.roughnessFactor:1,c="mask"===t.alphaMode?d.v.Color|d.v.AlphaMask:d.v.Color,v={baseColorFactor:a?[a[0],a[1],a[2],a[3]]:[1,1,1,1],baseColorTextureId:r(n&&n.baseColorTexture,c),metallicRoughnessTextureId:r(n&&n.metallicRoughnessTexture,d.v.MetallicRoughness),metallicFactor:l,roughnessFactor:h},_={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?g.Vr.None:"back"===t.cullFace?g.Vr.Back:"front"===t.cullFace?g.Vr.Front:void 0,normalTextureId:r(t.normalTexture,d.v.Normal),emissiveTextureId:r(t.emissiveTexture,d.v.Emissive),occlusionTextureId:r(t.occlusionTexture,d.v.Occlusion),emissiveFactor:s?[s[0],s[1],s[2]]:[0,0,0],metallicRoughness:v,wrapTextures:!1,hasParametersFromSource:u},m=[];return i.forEach((function(t,i){var r=t.usage,n=(0,o.pC)(e)&&e[i]&&e[i].formats,a=n?b(n.map((function(e){var t=e.name,i=e.format;return{name:t,encoding:x[i]}}))):[];m.push({id:i,usage:r,encodings:a})})),{material:_,textures:m}}function b(e){return e.sort((function(e,t){return e.encoding-t.encoding}))}var x={ktx2:d.j.KTX2,basis:d.j.Basis,dds:d.j.DDS_S3TC,png:d.j.PNG,jpg:d.j.JPG,"ktx-etc2":d.j.KTX_ETC2},C=(r={},(0,n.Z)(r,m.x.KTX2_ENCODING,d.j.Basis),(0,n.Z)(r,m.x.BASIS_ENCODING,d.j.Basis),(0,n.Z)(r,m.x.DDS_ENCODING,d.j.DDS_S3TC),(0,n.Z)(r,"image/png",d.j.PNG),(0,n.Z)(r,"image/jpg",d.j.JPG),(0,n.Z)(r,"image/jpeg",d.j.JPG),(0,n.Z)(r,"image/ktx",d.j.KTX_ETC2),r);function k(e){var t=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,i=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,r=t&&e.materialDefinitions[t],n=i&&e.textureDefinitions[i],a=N();if(null!=r){var o=r.params;o.diffuse&&(a.metallicRoughness.baseColorFactor=[o.diffuse[0],o.diffuse[1],o.diffuse[2],1]),null!=o.doubleSided&&(a.doubleSided=o.doubleSided,a.cullFace=o.doubleSided?g.Vr.None:g.Vr.Back),"none"!==o.cullFace&&"front"!==o.cullFace&&"back"!==o.cullFace||(a.cullFace="none"===o.cullFace?g.Vr.None:"back"===o.cullFace?g.Vr.Back:g.Vr.Front),o.transparency&&(a.metallicRoughness.baseColorFactor[3]=(0,s.uZ)(1-o.transparency,0,1)),(o.useVertexColorAlpha||a.metallicRoughness.baseColorFactor[3]<1)&&(a.alphaMode="blend")}var u=[];if(null!=n){!n.wrap||"repeat"!==n.wrap[0]&&"repeat"!==n.wrap[1]||(a.wrapTextures=!0);var l=d.v.Color;"rgba"===n.channels&&(a.alphaMode="blend",l|=d.v.AlphaMask);var h=n.images.length-1,c=n.images[h],f=function(e){return e&&e.split("/").pop()},v=Array.isArray(n.encoding)?b(n.encoding.map((function(e,t){return{name:f(c.href[t]),encoding:C[e]||0}}))):[{name:f(c.href),encoding:C[n.encoding]||0}];u.push({id:0,usage:l,encodings:v}),a.metallicRoughness.baseColorTextureId=0}return{material:a,textures:u}}var N=function(){return{alphaMode:"opaque",alphaCutoff:v.F,doubleSided:!0,cullFace:g.Vr.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}};function D(e,t,i,r){if((0,o.Wi)(e)||null==e.data)return null;var n=e.data,a=!(n instanceof HTMLImageElement)||(0,s.wt)(n.width)&&(0,s.wt)(n.height),u=r.renderingContext.parameters.maxMaxAnisotropy,l=i&&!r.capabilities.shaderTextureLOD?1:u,h=a&&!e.downsampled&&l>1,c=i||!t.wrapTextures?w:I,f=function(e){switch(e){case d.j.KTX2:return m.x.KTX2_ENCODING;case d.j.Basis:return m.x.BASIS_ENCODING;case d.j.DDS_S3TC:return m.x.DDS_ENCODING;case d.j.PNG:return"image/png";case d.j.JPG:return"image/jpeg";case d.j.KTX_ETC2:return"image/ktx";default:return""}}(e.encoding),v=e.usage&d.v.Color?"opaque"===t.alphaMode?3:4:3;return new m.x(n,{mipmap:h,maxAnisotropy:l,encoding:f,wrap:c,components:v,noUnpackFlip:!0})}var w={s:p.e8.CLAMP_TO_EDGE,t:p.e8.CLAMP_TO_EDGE},I={s:p.e8.REPEAT,t:p.e8.REPEAT};function P(e,t,i,r,n,a){var u=a.rendererTextureUsage,l=function(e){return function(e,t,i){if((0,o.Wi)(e)||i===d.v.None)return null;for(var r=0;r<e.length;r++){var n=e[r];if((0,o.pC)(n)&&0!=(n.usage&i)){var a=t[r];return(0,o.pC)(a)?a.id:null}}return null}(r,i,e&u)},h=t.metallicRoughness.baseColorFactor,f=(0,s.uZ)(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[h[0],h[1],h[2],f],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=a.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?.2:.5],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=a.isIntegratedMesh,e.textureAlphaCutoff="mask"===t.alphaMode?t.alphaCutoff:v.F,e.alphaDiscardMode="opaque"===t.alphaMode?g.JJ.Opaque:"mask"===t.alphaMode?g.JJ.Mask:g.JJ.MaskBlend;var m=[],p=l(d.v.Color|d.v.AlphaMask);(0,o.pC)(p)&&(e.baseColorTexture=new c(n,p),m.push(e.baseColorTexture.loadPromise));var y=l(d.v.MetallicRoughness);(0,o.pC)(y)&&(e.metallicRoughnessTexture=new c(n,y),m.push(e.metallicRoughnessTexture.loadPromise));var b=l(d.v.Emissive);(0,o.pC)(b)&&(e.emissionTexture=new c(n,b),m.push(e.emissionTexture.loadPromise));var x=l(d.v.Occlusion);(0,o.pC)(x)&&(e.occlusionTexture=new c(n,x),m.push(e.occlusionTexture.loadPromise));var C=l(d.v.Normal);return(0,o.pC)(C)&&(e.normalTexture=new c(n,C),m.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.hasSlicePlane=a.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=(0,_.j)(a.viewSpatialReference),Promise.all(m)}function S(e){var t=!!e.compressedTextureS3TC,i=!!e.compressedTextureETC,r=(0,a.Z)("disable-feature:i3s-basis")?0:d.j.Basis|d.j.KTX2,n=d.j.JPG|d.j.PNG,s=r|d.j.DDS_S3TC;return n|(t?s:0)|(i?r:0)}function L(e,t){return e.find((function(e){return 0!=(e.encoding&t)}))}},95964:function(e,t,i){i.d(t,{$i:function(){return v},FE:function(){return o},Hw:function(){return a},NB:function(){return g},O4:function(){return n},U_:function(){return r},oQ:function(){return m},rw:function(){return _},w5:function(){return s}});var r,n,a,s,o,d,u=i(60136),l=i(29388),h=i(43144),c=i(15671),f=i(23470),v=(0,h.Z)((function e(t,i){(0,c.Z)(this,e),this.id=t,this.mbs=i,this.renderMbs=(0,f.f)(0,0,0,-1),this.elevationRange=null})),_=(0,h.Z)((function e(){(0,c.Z)(this,e),this.min=1/0,this.max=-1/0,this.valid=!1}));(d=r||(r={}))[d.Unmodified=0]="Unmodified",d[d.Culled=1]="Culled",d[d.NotChecked=2]="NotChecked",function(e){e[e.Unmodified=0]="Unmodified",e[e.PotentiallyModified=1]="PotentiallyModified",e[e.Culled=2]="Culled",e[e.Unknown=3]="Unknown",e[e.NotChecked=4]="NotChecked"}(n||(n={}));var g=function(e){(0,u.Z)(i,e);var t=(0,l.Z)(i);function i(e,r,s,o,d,u,l,h,f,v){var _;return(0,c.Z)(this,i),(_=t.call(this,e,s)).index=r,_.childCount=o,_.level=d,_.resources=u,_.version=l,_.lodMetric=h,_.maxError=f,_.numFeatures=v,_.failed=!1,_.cacheState=a.Unknown,_.vertexCount=0,_.memory=0,_.childrenLoaded=0,_.hasModifications=!1,_.imModificationImpact=n.NotChecked,_}return(0,h.Z)(i)}(v);!function(e){e[e.Unknown=0]="Unknown",e[e.Uncached=1]="Uncached",e[e.Cached=2]="Cached"}(a||(a={})),function(e){e[e.None=0]="None",e[e.MaxScreenThreshold=1]="MaxScreenThreshold",e[e.ScreenSpaceRelative=2]="ScreenSpaceRelative",e[e.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",e[e.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(s||(s={})),function(e){e[e.Hole=0]="Hole",e[e.Leaf=1]="Leaf"}(o||(o={}));var m=(0,h.Z)((function e(t,i,r,n){(0,c.Z)(this,e),this.nodeHasLOD=t,this.isChosen=i,this.lodLevel=r,this.version=n}))},99048:function(e,t,i){var r,n;i.d(t,{j:function(){return r},v:function(){return n}}),function(e){e[e.KTX2=1]="KTX2",e[e.Basis=2]="Basis",e[e.DDS_S3TC=4]="DDS_S3TC",e[e.PNG=8]="PNG",e[e.JPG=16]="JPG",e[e.KTX_ETC2=32]="KTX_ETC2"}(r||(r={})),function(e){e[e.None=0]="None",e[e.Color=1]="Color",e[e.MetallicRoughness=2]="MetallicRoughness",e[e.Normal=4]="Normal",e[e.Occlusion=8]="Occlusion",e[e.Emissive=16]="Emissive",e[e.AlphaMask=32]="AlphaMask",e[e.ColorTextures=19]="ColorTextures",e[e.GeometryTextures=36]="GeometryTextures",e[e.GeometryTexturesPBR=44]="GeometryTexturesPBR",e[e.AllTextures=37]="AllTextures",e[e.AllTexturesPBR=63]="AllTexturesPBR"}(n||(n={}))},21765:function(e,t,i){var r;i.d(t,{B:function(){return r}}),function(e){e[e.FadeIn=0]="FadeIn",e[e.FadeOut=1]="FadeOut"}(r||(r={}))},76836:function(e,t,i){i.d(t,{f:function(){return h}});var r=i(93433),n=i(37762),a=i(15671),s=i(43144),o=i(60136),d=i(29388),u=i(91505),l=i(77427),h=function(e){(0,o.Z)(i,e);var t=(0,d.Z)(i);function i(){var e;return(0,a.Z)(this,i),(e=t.apply(this,arguments))._map=new Map,e}return(0,s.Z)(i,[{key:"clear",value:function(){if(this._map.size>0){var e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._map.size}},{key:"get",value:function(e){return this._map.get(e)}},{key:"addMany",value:function(e){if(0!==e.length){for(var t=new Set,i=0;i<e.length;i++){var r=e[i],n=r.objectId,a=this._map.get(n);a?(t.add(n),r!==a&&(e[i]=a),++a.refCount):(r.refCount=1,this._map.set(n,r))}var s=t.size>0?e.filter((function(e){return!t.has(e.objectId)})):e;s.length>0&&this.emit("change",{added:s,removed:[]})}}},{key:"removeMany",value:function(e){var t,i=[],r=(0,n.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,s=a.objectId,o=this._map.get(s);null!=o&&--o.refCount<=0&&(this._map.delete(s),i.push(a))}}catch(d){r.e(d)}finally{r.f()}i.length>0&&this.emit("change",{added:[],removed:i})}},{key:"removeManyByObjectId",value:function(e){var t,i=[],r=(0,n.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,s=this._map.get(a);null!=s&&--s.refCount<=0&&(this._map.delete(a),i.push(s))}}catch(o){r.e(o)}finally{r.f()}i.length>0&&this.emit("change",{added:[],removed:i})}},{key:"toArray",value:function(){return(0,r.Z)(this._map.values())}},{key:"find",value:function(e){var t;return(0,l.oE)(this._map,(function(i){return!!e(i)&&(t=i,!0)})),t}},{key:"forEach",value:function(e){this._map.forEach((function(t){return e(t)}))}}]),i}(u.Z)}}]);
//# sourceMappingURL=3117.f48790ae.chunk.js.map