"use strict";(self.webpackChunkuums_front_end=self.webpackChunkuums_front_end||[]).push([[8943],{13491:function(e,t,i){i.d(t,{Q:function(){return d}});var r=i(60136),n=i(29388),a=i(37762),s=i(15671),o=i(43144),l=i(63780),h=i(92026),c=i(27546),u=i(36231),d=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,i=arguments.length>1?arguments[1]:void 0;(0,s.Z)(this,e),this.compareMinX=g,this.compareMinY=v,this._toBBox=function(e){return e},this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),i&&("function"==typeof i?this._toBBox=i:this._initFormat(i)),this.clear()}return(0,o.Z)(e,[{key:"destroy",value:function(){this.clear(),G.prune(),k.prune(),R.prune(),E.prune()}},{key:"all",value:function(e){this._all(this.data,e)}},{key:"search",value:function(e,t){var i=this.data,r=this._toBBox;if(x(e,i))for(G.clear();i;){for(var n=0,a=i.children.length;n<a;n++){var s=i.children[n],o=i.leaf?r(s):s;x(e,o)&&(i.leaf?t(s):S(e,o)?this._all(s,t):G.push(s))}i=G.pop()}}},{key:"collides",value:function(e){var t=this.data,i=this._toBBox;if(!x(e,t))return!1;for(G.clear();t;){for(var r=0,n=t.children.length;r<n;r++){var a=t.children[r],s=t.leaf?i(a):a;if(x(e,s)){if(t.leaf||S(e,s))return!0;G.push(a)}}t=G.pop()}return!1}},{key:"load",value:function(e){if(!e.length)return this;if(e.length<this._minEntries){for(var t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}var r=this._build(e.slice(0,e.length),0,e.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var n=this.data;this.data=r,r=n}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this}},{key:"insert",value:function(e){return e&&this._insert(e,this.data.height-1),this}},{key:"clear",value:function(){return this.data=new P([]),this}},{key:"remove",value:function(e){if(!e)return this;var t,i=this.data,r=null,n=0,a=!1,s=this._toBBox(e);for(R.clear(),E.clear();i||R.length>0;){var o;if(i||(i=(0,h.j0)(R.pop()),r=R.data[R.length-1],n=null!==(o=E.pop())&&void 0!==o?o:0,a=!0),i.leaf&&-1!==(t=(0,l.cq)(i.children,e,i.children.length,i.indexHint)))return i.children.splice(t,1),R.push(i),this._condense(R),this;a||i.leaf||!S(i,s)?r?(n++,i=r.children[n],a=!1):i=null:(R.push(i),E.push(n),n=0,r=i,i=i.children[0])}return this}},{key:"toJSON",value:function(){return this.data}},{key:"fromJSON",value:function(e){return this.data=e,this}},{key:"_all",value:function(e,t){var i=e;for(k.clear();i;){var r;if(!0===i.leaf){var n,s=(0,a.Z)(i.children);try{for(s.s();!(n=s.n()).done;){t(n.value)}}catch(o){s.e(o)}finally{s.f()}}else k.pushArray(i.children);i=null!==(r=k.pop())&&void 0!==r?r:null}}},{key:"_build",value:function(e,t,i,r){var n=i-t+1,a=this._maxEntries;if(n<=a){var s=new P(e.slice(t,i+1));return p(s,this._toBBox),s}r||(r=Math.ceil(Math.log(n)/Math.log(a)),a=Math.ceil(n/Math.pow(a,r-1)));var o=new D([]);o.height=r;var l=Math.ceil(n/a),h=l*Math.ceil(Math.sqrt(a));w(e,t,i,h,this.compareMinX);for(var c=t;c<=i;c+=h){var u=Math.min(c+h-1,i);w(e,c,u,l,this.compareMinY);for(var d=c;d<=u;d+=l){var y=Math.min(d+l-1,u);o.children.push(this._build(e,d,y,r-1))}}return p(o,this._toBBox),o}},{key:"_chooseSubtree",value:function(e,t,i,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==i;){for(var n=void 0,a=1/0,s=1/0,o=0,l=t.children.length;o<l;o++){var h=t.children[o],c=m(h),u=C(e,h)-c;u<s?(s=u,a=c<a?c:a,n=h):u===s&&c<a&&(a=c,n=h)}t=n||t.children[0]}return t}},{key:"_insert",value:function(e,t,i){var r=this._toBBox,n=i?e:r(e);R.clear();var a=this._chooseSubtree(n,this.data,t,R);for(a.children.push(e),f(a,n);t>=0&&R.data[t].children.length>this._maxEntries;)this._split(R,t),t--;this._adjustParentBBoxes(n,R,t)}},{key:"_split",value:function(e,t){var i=e.data[t],r=i.children.length,n=this._minEntries;this._chooseSplitAxis(i,n,r);var a=this._chooseSplitIndex(i,n,r);if(a){var s=i.children.splice(a,i.children.length-a),o=i.leaf?new P(s):new D(s);o.height=i.height,p(i,this._toBBox),p(o,this._toBBox),t?e.data[t-1].children.push(o):this._splitRoot(i,o)}else console.log("  Error: assertion failed at PooledRBush._split: no valid split index")}},{key:"_splitRoot",value:function(e,t){this.data=new D([e,t]),this.data.height=e.height+1,p(this.data,this._toBBox)}},{key:"_chooseSplitIndex",value:function(e,t,i){var r,n,a;r=n=1/0;for(var s=t;s<=i-t;s++){var o=y(e,0,s,this._toBBox),l=y(e,s,i,this._toBBox),h=_(o,l),c=m(o)+m(l);h<r?(r=h,a=s,n=c<n?c:n):h===r&&c<n&&(n=c,a=s)}return a}},{key:"_chooseSplitAxis",value:function(e,t,i){var r=e.leaf?this.compareMinX:g,n=e.leaf?this.compareMinY:v;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,n)&&e.children.sort(r)}},{key:"_allDistMargin",value:function(e,t,i,r){e.children.sort(r);for(var n=this._toBBox,a=y(e,0,t,n),s=y(e,i-t,i,n),o=b(a)+b(s),l=t;l<i-t;l++){var h=e.children[l];f(a,e.leaf?n(h):h),o+=b(a)}for(var c=i-t-1;c>=t;c--){var u=e.children[c];f(s,e.leaf?n(u):u),o+=b(s)}return o}},{key:"_adjustParentBBoxes",value:function(e,t,i){for(var r=i;r>=0;r--)f(t.data[r],e)}},{key:"_condense",value:function(e){for(var t=e.length-1;t>=0;t--){var i=e.data[t];if(0===i.children.length)if(t>0){var r=e.data[t-1],n=r.children;n.splice((0,l.cq)(n,i,n.length,r.indexHint),1)}else this.clear();else p(i,this._toBBox)}}},{key:"_initFormat",value:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}]),e}();function p(e,t){y(e,0,e.children.length,t,e)}function y(e,t,i,r,n){n||(n=new P([])),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(var a,s=t;s<i;s++)a=e.children[s],f(n,e.leaf?r(a):a);return n}function f(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function g(e,t){return e.minX-t.minX}function v(e,t){return e.minY-t.minY}function m(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function b(e){return e.maxX-e.minX+(e.maxY-e.minY)}function C(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function _(e,t){var i=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),n=Math.min(e.maxX,t.maxX),a=Math.min(e.maxY,t.maxY);return Math.max(0,n-i)*Math.max(0,a-r)}function S(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function x(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function w(e,t,i,r,n){for(var a=[t,i];a.length;){var s=(0,h.j0)(a.pop()),o=(0,h.j0)(a.pop());if(!(s-o<=r)){var l=o+Math.ceil((s-o)/r/2)*r;(0,u.q)(e,l,o,s,n),a.push(o,l,l,s)}}}var G=new c.Z,k=new c.Z,R=new c.Z,E=new c.Z({deallocator:void 0}),I=function(e){(0,r.Z)(i,e);var t=(0,n.Z)(i);function i(){var e;return(0,s.Z)(this,i),(e=t.apply(this,arguments)).height=1,e.indexHint=new l.SO,e}return(0,o.Z)(i)}((0,o.Z)((function e(){(0,s.Z)(this,e),this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}))),P=function(e){(0,r.Z)(i,e);var t=(0,n.Z)(i);function i(e){var r;return(0,s.Z)(this,i),(r=t.call(this)).children=e,r.leaf=!0,r}return(0,o.Z)(i)}(I),D=function(e){(0,r.Z)(i,e);var t=(0,n.Z)(i);function i(e){var r;return(0,s.Z)(this,i),(r=t.call(this)).children=e,r.leaf=!1,r}return(0,o.Z)(i)}(I)},77835:function(e,t,i){i.d(t,{n:function(){return o}});var r=i(92026),n=i(12717),a=i(3182),s=i(80457),o={getObjectId:function(e){return e.objectId},getAttributes:function(e){return e.attributes},getAttribute:function(e,t){return e.attributes[t]},cloneWithGeometry:function(e,t){return new a.u_(t,e.attributes,null,e.objectId)},getGeometry:function(e){return e.geometry},getCentroid:function(e,t){return(0,r.Wi)(e.centroid)&&(e.centroid=(0,n.Y)(new s.Z,e.geometry,t.hasZ,t.hasM)),e.centroid}}},86792:function(e,t,i){i.d(t,{w:function(){return rt}});var r=i(93433),n=i(29439),a=i(74165),s=i(15861),o=i(37762),l=i(15671),h=i(43144),c=i(97326),u=i(60136),d=i(29388),p=i(27366),y=(i(59486),i(94931),i(78451),i(98689),i(57823),i(32066),i(49018),i(34999),i(79850)),f=(i(9014),i(51508),i(85015)),g=i(93169),v=i(10064),m=i(100),b=i(42537),C=i(32718),_=i(77427),S=i(92026),x=i(27546),w=i(66978),G=i(94172),k=i(99346),R=i(49861),E=i(63780),I=(i(25243),i(69912)),P=i(48732),D=i(11186),O=i(71353),Z=i(79803),A=i(41414),L=i(65156),U=i(30651),M=i(65618),V=i(37818),W=i(61029),B=i(819),F=i(43977),j=i(31655),T=i(16915),Y=i(62554),z=i(1030),N=i(66985),q=i(61574),H=i(76115),X=Y.Z.fromSimpleMarkerSymbol(q.xA),J=j.Z.fromSimpleLineSymbol(q.CJ),Q=z.Z.fromSimpleFillSymbol(q.z3),K=new T.Z({symbolLayers:[new F.Z({material:{color:H.SQ},edges:new N.Z({size:"1px",color:H.X1})})]});function $(e){if((0,S.Wi)(e))return null;switch(e.type){case"mesh":return K;case"point":case"multipoint":return X;case"polyline":return J;case"polygon":case"extent":return Q}return null}var ee=i(23707),te=i(91293),ie=i(70446),re=i(8821),ne=i(91505),ae=i(3182),se=i(80457),oe=i(77835),le=function(e){(0,u.Z)(i,e);var t=(0,d.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this,e)).events=new ne.Z,r.hasZ=null,r.hasM=null,r.objectIdField=null,r.viewSpatialReference=null,r.featureAdapter={getAttribute:function(e,t){return"graphic"in e?e.graphic.attributes[t]:oe.n.getAttribute(e,t)},getAttributes:function(e){return"graphic"in e?e.graphic.attributes:oe.n.getAttributes(e)},getObjectId:function(e){return"graphic"in e?(0,M.MS)(e.graphic,r.objectIdField):oe.n.getObjectId(e)},getGeometry:function(e){return"graphic"in e?e.getAsOptimizedGeometry(r.hasZ,r.hasM):oe.n.getGeometry(e)},getCentroid:function(e,t){if("graphic"in e){var i=null;(0,S.pC)(e.centroid)?i=e.centroid:"point"===e.graphic.geometry.type&&(0,Z.nF)(e.graphic.geometry,he,r.viewSpatialReference)&&(i=he);var n=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return(0,S.Wi)(i)?(n[0]=0,n[1]=0,n[2]=0,n[3]=0):(n[0]=i.x,n[1]=i.y,t.hasZ&&(n[2]=i.hasZ?i.z:0),t.hasM&&(n[t.hasZ?3:2]=i.hasM?i.m:0)),new se.Z([],n)}return oe.n.getCentroid(e,t)},cloneWithGeometry:function(e,t){return"graphic"in e?new ae.u_(t,r.featureAdapter.getAttributes(e),null,r.featureAdapter.getObjectId(e)):oe.n.cloneWithGeometry(e,t)}},r}return(0,h.Z)(i,[{key:"forEachInBounds",value:function(e,t){this.getSpatialIndex().forEachInBounds(e,t)}},{key:"forEachBounds",value:function(e,t,i){var r,n=this.getSpatialIndex(),a=(0,o.Z)(e);try{for(a.s();!(r=a.n()).done;){var s=r.value,l=this.featureAdapter.getObjectId(s);(0,S.pC)(n.getBounds(l,i))&&t(i)}}catch(h){a.e(h)}finally{a.f()}}}]),i}(f.Z);(0,p._)([(0,R.Cb)({constructOnly:!0})],le.prototype,"getSpatialIndex",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],le.prototype,"toArray",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],le.prototype,"forEach",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],le.prototype,"hasZ",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],le.prototype,"hasM",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],le.prototype,"objectIdField",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],le.prototype,"viewSpatialReference",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],le.prototype,"featureSpatialReference",void 0),le=(0,p._)([(0,I.j)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],le);var he={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null},ce=i(91107),ue=(0,h.Z)((function e(t){(0,l.Z)(this,e),this.schedule=t,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.isAsync=!1})),de=i(11752),pe=i(61120),ye=i(14921),fe=i(90592),ge=i(64502),ve=function(e){(0,u.Z)(i,e);var t=(0,d.Z)(i);function i(e,r,n){var a;return(0,l.Z)(this,i),(a=t.call(this,e,r,n)).calloutSymbolLayer=null,a.symbol.hasVisibleCallout()&&(a.calloutSymbolLayer=(0,fe.S)(a.symbol,r)),a}return(0,h.Z)(i,[{key:"doLoad",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.calloutSymbolLayer?(0,ye.q6)(this.calloutSymbolLayer.load()):null,e.prev=1,e.next=4,(0,de.Z)((0,pe.Z)(i.prototype),"doLoad",this).call(this,t);case 4:(0,w.k_)(t),e.next=10;break;case 7:throw e.prev=7,e.t0=e.catch(1),null!==(n=this.calloutSymbolLayer)&&void 0!==n&&n.abortLoad(),e.t0;case 10:if(e.t1=r,!e.t1){e.next=14;break}return e.next=14,r;case 14:case"end":return e.stop()}}),e,this,[[1,7]])})));return function(t){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,de.Z)((0,pe.Z)(i.prototype),"destroy",this).call(this),this.calloutSymbolLayer=(0,S.SC)(this.calloutSymbolLayer)}},{key:"createGraphics3DGraphic",value:function(e,t){var r=(0,de.Z)((0,pe.Z)(i.prototype),"createGraphics3DGraphic",this).call(this,e,t);if((0,S.pC)(this.calloutSymbolLayer)&&(0,S.pC)(r)){var n=this._createCalloutGraphic(e);(0,S.pC)(n)&&r.addAuxiliaryGraphic(n)}return r}},{key:"globalPropertyChanged",value:function(e,t){var r=this;return!!(0,de.Z)((0,pe.Z)(i.prototype),"globalPropertyChanged",this).call(this,e,t)&&(!this.calloutSymbolLayer||this.calloutSymbolLayer.globalPropertyChanged(e,t,(function(e){return r._getCalloutGraphicLayer(e)})))}},{key:"updateGeometry",value:function(e,t){var r=(0,de.Z)((0,pe.Z)(i.prototype),"updateGeometry",this).call(this,e,t);if(r&&this.calloutSymbolLayer){var n=this._getCalloutGraphicLayer(e);if(n)return this.calloutSymbolLayer.updateGeometry(n,t)}return r}},{key:"_createCalloutGraphic",value:function(e){var t=e.renderingInfo,i={renderer:t.renderer,symbol:t.symbol,translation:[0,0,0],centerOffset:[0,0,0,0],screenOffset:[0,0],centerOffsetUnits:"world",elevationOffset:0,materialCollection:null};return e.renderingInfo=i,this.calloutSymbolLayer.createGraphics3DGraphic(e)}},{key:"_getCalloutGraphicLayer",value:function(e){var t,i=(0,o.Z)(e._auxiliaryGraphics);try{for(i.s();!(t=i.n()).done;){var r=t.value;if(r.graphics3DSymbolLayer===this.calloutSymbolLayer)return r}}catch(n){i.e(n)}finally{i.f()}}}]),i}(ge.Z);function me(e,t,i){return new("point-3d"===e.type?ve:ge.Z)(e,t,i)}var be=i(19477),Ce=function(){function e(t){var i=this;(0,l.Z)(this,e),this.graphicsCore=t,this.idToState=new Map,this.states=new Set;var r=t.owner.layer&&t.owner.layer.objectIdField;r?(this.getGraphicId=function(e){return(0,M.MS)(e,r)},this.getGraphics3DGraphicById=function(e){return i.graphicsCore.getGraphics3DGraphicByObjectId(e)}):(this.getGraphicId=function(e){return e.uid},this.getGraphics3DGraphicById=function(e){return i.graphicsCore.getGraphics3DGraphicById(e)})}return(0,h.Z)(e,[{key:"destroy",value:function(){var e=this;this.idToState.clear(),this.states.forEach((function(t,i){return e.remove(i)}))}},{key:"add",value:function(e){var t=this,i={remove:function(){return t.remove(e)}};if(this.states.has(e))return i;var r=this.getGraphicId(e.graphic),n=this.getGraphics3DGraphicById(r);return this.states.has(e)||this.states.add(e),this._ensureStateList(r).push(e),e.displaying=!!(0,S.pC)(n)&&n.isVisible(),e.isDraped=!!(0,S.pC)(n)&&n.isDraped,e.tracking=!0,(0,S.pC)(n)&&e.emit("changed",{}),i}},{key:"remove",value:function(e){if(this.states.has(e)){if(this.idToState.size){var t=this.getGraphicId(e.graphic),i=this.idToState.get(t);i&&((0,E.Od)(i,e),0===i.length&&this.idToState.delete(t))}this.states.delete(e),e.tracking=!1,e.displaying=!1}}},{key:"addGraphic",value:function(e){this._forEachState(e,(function(t){t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed",{})}))}},{key:"removeGraphic",value:function(e){this._forEachState(e,(function(e){e.displaying=!1,e.isDraped=!1}))}},{key:"updateGraphicGeometry",value:function(e){this._forEachState(e,(function(e){e.emit("changed",{})}))}},{key:"updateGraphicVisibility",value:function(e){this._forEachState(e,(function(t){t.displaying=e.isVisible()}))}},{key:"allGraphicsDeleted",value:function(){this.states.forEach((function(e){e.displaying=!1}))}},{key:"_ensureStateList",value:function(e){var t=this.idToState.get(e);if(t)return t;var i=new Array;return this.idToState.set(e,i),i}},{key:"_forEachState",value:function(e,t){if(0!==this.states.size&&0!==this.idToState.size){var i=this.getGraphicId(e.graphic),r=this.idToState.get(i);null!=r&&r.forEach(t)}}}]),e}(),_e=i(96387),Se=i(41325),xe=i(85042),we=i(13491),Ge=function(e){(0,u.Z)(i,e);var t=(0,d.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this,e))._index=new we.Q(9,(0,g.Z)("esri-csp-restrictions")?function(e){return{minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),r._missing=new Set,r._boundsByFeature=new Map,r.spatialReference=null,r.hasZ=null,r.hasM=null,r.objectIdField=null,r.updating=!1,r}return(0,h.Z)(i,[{key:"setup",value:function(e){this._addMany(e)}},{key:"destroy",value:function(){this._missing.clear(),this._index.destroy(),this._index=null,this._boundsByFeature.clear(),this._boundsByFeature=null}},{key:"update",value:function(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}},{key:"updatingRemaining",get:function(){return this._missing.size}},{key:"queryGraphicUIDsInExtent",value:function(e,t,i){t.equals(this.spatialReference)&&(ke.minX=e[0],ke.minY=e[1],ke.maxX=e[2],ke.maxY=e[3],this.update(),this._index.search(ke,(function(e){return i(e.graphic.uid)})))}},{key:"add",value:function(e){this._missing.add(e),this.updating=!0}},{key:"remove",value:function(e){if(this._missing.delete(e))this.updating=this._missing.size>0;else{this._index.remove(e);var t=(0,M.MS)(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}}},{key:"_addMany",value:function(e){if(0!==e.length){var t,i=this._get("objectIdField"),r=(0,o.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;n.computeExtent(this.spatialReference);var a=(0,M.MS)(n.graphic,i);null!=a&&this._boundsByFeature.set(a,n.extent)}}catch(s){r.e(s)}finally{r.f()}this._index.load(e)}}},{key:"clear",value:function(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}},{key:"forEachInBounds",value:function(e,t){ke.minX=e[0],ke.minY=e[1],ke.maxX=e[2],ke.maxY=e[3],this.update(),this._index.search(ke,(function(e){t(e)}))}},{key:"getBounds",value:function(e,t){this.update();var i=this._boundsByFeature.get(e);return i?(0,A.JR)(t,i):null}}]),i}(f.Z);(0,p._)([(0,R.Cb)({constructOnly:!0})],Ge.prototype,"spatialReference",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],Ge.prototype,"hasZ",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],Ge.prototype,"hasM",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],Ge.prototype,"objectIdField",void 0),(0,p._)([(0,R.Cb)()],Ge.prototype,"updating",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],Ge.prototype,"updatingRemaining",null),Ge=(0,p._)([(0,I.j)("esri.views.3d.layers.graphics.SpatialIndex2D")],Ge);var ke={minX:0,minY:0,maxX:0,maxY:0},Re=i(35218),Ee=i(68860),Ie=i(88152),Pe=i(88153),De=i(54463),Oe=C.Z.getLogger("esri.views.3d.layers.support.StageLayerElevationProvider"),Ze=function(e){(0,u.Z)(i,e);var t=(0,d.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this,e)).elevationOffset=0,r._layerHandes=new m.Z,r}return(0,h.Z)(i,[{key:"initialize",value:function(){var e=this;this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=(0,Pe.Z8)(this.view.state.viewingMode),this.intersector.options.store=De.eC.MIN;var t=this._computeLayerExtent(this.stageLayer);this.zmin=t[2],this.zmax=t[5];var i=this.stageLayer.events;this._layerHandes.add([i.on("layerObjectAdded",(function(t){return e._objectChanged(t.object)})),i.on("layerObjectRemoved",(function(t){return e._objectChanged(t.object)})),i.on("objectGeometryAdded",(function(t){return e._objectChanged(t.object)})),i.on("objectGeometryRemoved",(function(t){return e._objectChanged(t.object)})),i.on("vertexAttrsUpdated",(function(t){return e._objectChanged(t.object)})),i.on("objectTransformation",(function(t){return e._objectChanged(t)}))])}},{key:"dispose",value:function(){this._layerHandes.destroy()}},{key:"elevationInfoChanged",value:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){var t=(0,Ee._R)(this.layer.spatialReference),i=(0,Ie.Z7)(e.unit);this.elevationOffset=(0,S.Pt)(e.offset,0)*i/t}else this.elevationOffset=0}},{key:"getElevation",value:function(e,t,i,r){if(Be[0]=e,Be[1]=t,Be[2]=i,!this.renderCoordsHelper.toRenderCoords(Be,r,Be))return Oe.error("could not project point for elevation alignment"),null;var n=this.elevationOffset,a=this.zmin+n,s=this.zmax+n;this.renderCoordsHelper.setAltitude(Fe,s,Be),this.renderCoordsHelper.setAltitude(je,a,Be);return this.intersector.reset(Fe,je,null),this.intersector.intersect(this.intersectLayers,null,1,null,(function(e){return e.metadata&&e.metadata.isElevationSource})),this.intersector.results.min.getIntersectionPoint(Be)?this.renderCoordsHelper.getAltitude(Be):null}},{key:"_objectChanged",value:function(e){var t;if(null!==(t=e.metadata)&&void 0!==t&&t.isElevationSource&&this.spatialReference){(0,A.cS)(Me),e.metadata.lastValidElevationBB.isEmpty()||this._expandExtent(e.metadata.lastValidElevationBB.min,e.metadata.lastValidElevationBB.max,Me);var i=e.boundingVolumeWorldSpace.min,r=e.boundingVolumeWorldSpace.max;this._expandExtent(i,r,Me),(0,A.y8)(Me,Ve),this.zmin=Math.min(this.zmin,Me[2]),this.zmax=Math.max(this.zmax,Me[5]),We.extent=Ve,We.spatialReference=this.spatialReference,this.emit("elevation-change",We),(0,D.c)(e.metadata.lastValidElevationBB.min,i),(0,D.c)(e.metadata.lastValidElevationBB.max,r)}}},{key:"_computeLayerExtent",value:function(e){var t=this;return(0,A.cS)(Me),e.objects.forAll((function(e){return t._expandExtent(e.boundingVolumeWorldSpace.min,e.boundingVolumeWorldSpace.max,Me)})),Me}},{key:"_expandExtent",value:function(e,t,i){for(var r=0;r<8;++r)Be[0]=1&r?e[0]:t[0],Be[1]=2&r?e[1]:t[1],Be[2]=4&r?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(Be,Be,this.spatialReference),(0,A.pp)(i,Be);return i}}]),i}(ne.Z.EventedMixin(f.Z));(0,p._)([(0,R.Cb)({constructOnly:!0})],Ze.prototype,"layer",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],Ze.prototype,"stageLayer",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],Ze.prototype,"view",void 0),(0,p._)([(0,R.Cb)({readOnly:!0,aliasOf:"view.spatialReference"})],Ze.prototype,"spatialReference",void 0),Ze=(0,p._)([(0,I.j)("esri.views.3d.layers.support.StageLayerElevationProvider")],Ze);var Ae,Le,Ue,Me=(0,A.cS)(),Ve=(0,L.cS)(),We={spatialReference:null,extent:Ve,context:"scene"},Be=(0,O.c)(),Fe=(0,O.c)(),je=(0,O.c)(),Te=i(65206),Ye=i(76419),ze=i(68401),Ne=i(19962),qe=i(97882),He=i(93463),Xe=i(53866),Je=i(7882),Qe=i(24931),Ke=i(58009),$e=i(80045),et=(0,O.c)(),tt=(0,A.Ue)(),it=C.Z.getLogger("esri.views.3d.layers.graphics.Graphics3DCore"),rt=Ae=function(e){(0,u.Z)(i,e);var t=(0,d.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this,e)).propertiesPool=new Ye.L({computedExtent:Xe.Z},(0,c.Z)(r)),r.computedExtent=null,r.currentRenderer=null,r.rendererHasGeometryOperations=!1,r.graphicStateTracking=null,r.symbolCreationContext=new ue((function(e,t){return r._frameTask.schedule(e,t)})),r.graphics3DGraphics=new Map,r.stageLayer=null,r.stage=null,r.graphicsDrapedUids=new Set,r.graphicsBySymbol=new Map,r.symbolConversionCache=new Map,r.symbols=new Map,r.graphicsWithoutSymbol=new Map,r.graphicsWaitingForSymbol=new Map,r.graphicsUpdateId=0,r._handles=new m.Z,r._frameTask=He.sq,r.suspendSymbolCleanup=!1,r._viewSpatialReference=null,r.arcadeOnDemand=null,r.rendererChangeAbortController=null,r.elevationInfoChangeAbortController=null,r.setupAbortController=null,r.elevationAlignment=null,r.scaleVisibility=null,r._spatialIndex=null,r.extentPadding=0,r._updatingPendingLoadedGraphicsChange=null,r.featureStore=null,r.deconflictor=null,r.labeler=null,r.objectStates=null,r.viewElevationProvider=null,r.stageLayerElevationProvider=null,r.sharedSymbolResourcesOwnerHandle=null,r.whenGraphics3DGraphicRequests={},r.pendingUpdates=new Map,r.numberOfGraphics=0,r.numberOfGraphicsProvidingElevation=0,r.pendingAdds=0,r.pendingRemoves=0,r._loadingSymbols=0,r.pendingUpdatesPool=new x.Z({allocator:function(e){return e||new nt},deallocator:function(e){return e.clear(),e}}),r.symbolWarningLogged=!1,r.geometryWarningLogged=!1,r.objectIdInvisibleSet=new Set,r._whenSymbolRemoved=new x.Z,r.preferredUpdatePolicy=ze.jq.SYNC,r.forcedUpdatePolicy=null,r.elevationFeatureExpressionEnabled=!0,r.owner=null,r.layer=null,r.graphicSymbolSupported=!0,r.getRenderingInfoWithoutRenderer=!1,r.hasZ=null,r.hasM=null,r._usedMemory=0,r._visible=void 0,r._startCreateGraphics=!1,r}return(0,h.Z)(i,[{key:"spatialIndex",get:function(){var e;return this._spatialIndex||(this._spatialIndex=new Ge({objectIdField:null===(e=this.owner.layer)||void 0===e?void 0:e.objectIdField,spatialReference:this._viewSpatialReference,hasZ:this.hasZ,hasM:this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}},{key:"effectiveUpdatePolicy",get:function(){return(0,S.pC)(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?ze.jq.ASYNC:(0,S.Pt)(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}},{key:"updating",get:function(){var e;return!!(this.graphicsWaitingForSymbol.size>0||this.running||null!==(e=this.elevationAlignment)&&void 0!==e&&e.updating||(0,S.pC)(this.scaleVisibility)&&this.scaleVisibility.updating||(0,S.pC)(this.filterVisibility)&&this.filterVisibility.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||this._loadingSymbols>0)}},{key:"running",get:function(){var e;return this.pendingUpdates.size>0||!(null===(e=this._spatialIndex)||void 0===e||!e.updating)}},{key:"suspendedOrOutsideOfView",get:function(){var e;return this.owner.suspended||(null===(e=this.owner.suspendInfo)||void 0===e?void 0:e.outsideOfView)}},{key:"updatingRemaining",get:function(){var e,t;return this.updating?this.pendingUpdates.size+.1*((null===(e=this._spatialIndex)||void 0===e?void 0:e.updatingRemaining)||0)+.1*((null===(t=this.elevationAlignment)||void 0===t?void 0:t.updatingRemaining)||0):0}},{key:"displayFeatureLimit",get:function(){var e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,n=this.averageSymbolComplexity,a=Math.max(1,(0,S.pC)(n)?n.primitivesPerFeature:1),s=(0,S.pC)(n)&&n.drawCallsPerFeature>0?i/n.drawCallsPerFeature*.3:i,o=Math.ceil(r/a),l=Math.max(t,Math.min(i,o,s)),h=this._get("displayFeatureLimit");return h&&h.minimumTotalNumberOfFeatures===t&&h.maximumTotalNumberOfFeatures===i&&h.maximumTotalNumberOfPrimitives===r&&h.averageSymbolComplexity===n&&h.maximumNumberOfFeatures===l?h:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,averageSymbolComplexity:n,maximumNumberOfFeatures:l}}},{key:"averageSymbolComplexity",get:function(){var e=(0,Re.bz)(this.symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||(0,S.pC)(t)&&(e.estimated&&(t.primitivesPerFeature>=e.primitivesPerFeature||t.primitivesPerCoordinate>=e.primitivesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.primitivesPerFeature===e.primitivesPerFeature&&t.primitivesPerCoordinate===e.primitivesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}},{key:"usedMemory",get:function(){var e=(0,S.pC)(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+e}},{key:"usedMemoryPerGraphic",get:function(){if(this._usedMemory&&this.numberOfGraphics)return Math.abs(this.pendingAdds-this.pendingRemoves)/this.numberOfGraphics>30?0:this._usedMemory/this.numberOfGraphics;if((0,S.pC)(this.averageSymbolComplexity)){var e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}},{key:"unprocessedMemoryEstimate",get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)}},{key:"symbolComplexities",get:function(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}},{key:"_getConvertedSymbol",value:function(e){if("web-style"===e.type)return e.clone();var t=this.symbolConversionCache.get(e.id);if((0,S.pC)(t))return t;var i=(0,ee.q)(e,{retainId:!0,hasLabelingContext:this._hasLabelingContext(e)}),r=i.symbol||null;return(0,S.Wi)(r)&&i.error&&it.error(i.error.message),this.symbolConversionCache.set(e.id,r),r}},{key:"_getSymbolComplexitiesUsedOrRenderer",value:function(e){if((0,S.Wi)(e))return[];var t=e.getSymbols(),i="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(i||t&&t.length))return[];var r=[],n=this._getSymbolComplexityUsedOrRenderer(i);(0,S.pC)(n)&&r.push(n);var a,s=(0,o.Z)(t);try{for(s.s();!(a=s.n()).done;){var l=a.value,h=this._getSymbolComplexityUsedOrRenderer(l);(0,S.pC)(h)&&r.push(h)}}catch(c){s.e(c)}finally{s.f()}return r}},{key:"_getSymbolComplexityUsedOrRenderer",value:function(e){if((0,S.Wi)(e))return null;var t=this.symbols.get(e.id);if((0,S.pC)(t))return t.complexity;var i=this._getConvertedSymbol(e);return(0,S.pC)(i)?(0,Re.V9)(i):null}},{key:"_getSymbolComplexitiesUsed",value:function(){var e=[];return this.symbols.forEach((function(t){(0,S.pC)(t)&&e.push(t.complexity)})),e}},{key:"initialize",value:function(){var e=this;this._viewSpatialReference=this.owner.view.spatialReference,this._set("featureStore",new le({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:function(){return e.spatialIndex},forEach:function(t){return e.graphics3DGraphics.forEach(t)},toArray:function(){return Array.from(e.graphics3DGraphics.values())}}))}},{key:"setup",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var i,r,n,s,o=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setupAbortController=new AbortController,i=this.setupAbortController.signal,this._set("elevationAlignment",t.elevationAlignment),this._set("scaleVisibility",t.scaleVisibility),this._set("filterVisibility",t.filterVisibility),this._set("deconflictor",t.deconflictor),this._set("labeler",t.labeler),this._set("objectStates",t.objectStates),r=this.owner.view,this.viewElevationProvider=new te.Y(this._viewSpatialReference,r),this._initializeStage(r,this.layer.uid),this.symbolCreationContext.sharedResources=r.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=r.sharedSymbolResources.addGraphicsOwner(this.owner),(0,S.pC)(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=r.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=r.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new Ne.C(r.renderSpatialReference),this.symbolCreationContext.elevationProvider=r.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=function(e){return o.notifyGraphicGeometryChanged(e)},this.symbolCreationContext.notifyGraphicVisibilityChanged=function(e){return o.notifyGraphicVisibilityChanged(e)},n=(0,re.WI)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),e.next=8,(0,re.kr)(n,this._viewSpatialReference,it);case 8:if(this.symbolCreationContext.featureExpressionInfoContext=e.sent,(0,w.k_)(i),this.symbolCreationContext.screenSizePerspectiveEnabled=r.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled,!("drapeSourceType"in this.owner)){e.next=16;break}s=this.owner,this.symbolCreationContext.drapeSourceRenderer=r.basemapTerrain.overlayManager.registerGeometryDrapeSource(s),this._handles.add((0,b.kB)((function(){return r.basemapTerrain.overlayManager.unregisterDrapeSource(s)})));case 16:return this._handles.add([(0,G.YP)((function(){return o.suspendedOrOutsideOfView}),(function(){return o._frameTask.reschedule((function(){return o._updateLayerVisibility()}))})),(0,G.YP)((function(){var e;return[null===(e=o.layer)||void 0===e?void 0:e.screenSizePerspectiveEnabled,o.owner.view.screenSizePerspectiveEnabled]}),(function(){var e,t=r.screenSizePerspectiveEnabled&&o.layer.screenSizePerspectiveEnabled;t!==o.symbolCreationContext.screenSizePerspectiveEnabled&&(o.symbolCreationContext.screenSizePerspectiveEnabled=t,null!==(e=o.labeler)&&void 0!==e&&e.reset(),o.recreateAllGraphicsAndSymbols())})),(0,G.YP)((function(){return o.owner.slicePlaneEnabled}),(function(e){return o._slicePlaneEnabledChange(!!e)})),(0,G.YP)((function(){var e;return null===(e=o.owner.view.state)||void 0===e?void 0:e.pixelRatio}),(function(){return o._pixelRatioChange()})),(0,G.YP)((function(){var e;return null===(e=o.owner.view.qualitySettings)||void 0===e?void 0:e.physicallyBasedRenderingEnabled}),(function(e){return o._physicalBasedRenderingChange(e)})),(0,G.gx)((function(){var e;return null===(e=r.basemapTerrain)||void 0===e?void 0:e.tilingScheme}),(function(e){if(e.spatialReference.equals(o.symbolCreationContext.overlaySR)||(o.symbolCreationContext.overlaySR=r.basemapTerrain.spatialReference),o._handles.has("loaded-graphics"))o.recreateAllGraphics();else{o._handles.add([(0,G.on)((function(){var e;return null===(e=o.owner)||void 0===e?void 0:e.loadedGraphics}),"change",(function(e){o._graphicsCollectionChanged(e),o._signalUpdatingDuringAsyncLoadedGraphicsChange()}),{onListenerAdd:function(){o.recreateAllGraphics(),o._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}}),{initial:!0}),(0,G.YP)((function(){return o.effectiveUpdatePolicy}),(function(e){(0,S.pC)(o.stageLayer)&&(o.stageLayer.updatePolicy=e),o.symbolCreationContext.isAsync=o.effectiveUpdatePolicy===ze.jq.ASYNC,e===ze.jq.SYNC&&o.runTask(He.G5)}),G.tX)]),this._frameTask=r.resourceController.scheduler.registerTask(He.T8.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this._handles.add((0,G.YP)((function(){return o.layer.featureReduction}),(function(){return o.deconflictor.featureReductionChange()}))),this.notifyChange("averageSymbolComplexity"),e.prev=17,e.next=20,this.rendererChange(this.layer.renderer);case 20:e.next=24;break;case 22:e.prev=22,e.t0=e.catch(17);case 24:(0,w.k_)(i),this.setupAbortController=null;case 25:case"end":return e.stop()}}),e,this,[[17,22]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_abortSetup",value:function(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)}},{key:"destroy",value:function(){for(var e in this._abortSetup(),this._abortRendererChange(),this._abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._updatingPendingLoadedGraphicsChange=(0,S.hw)(this._updatingPendingLoadedGraphicsChange),this.clear(),this.graphicStateTracking=(0,S.SC)(this.graphicStateTracking),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=(0,S.SC)(this._handles),this._frameTask.remove(),this._frameTask=He.sq,this._viewSpatialReference=null,this._set("owner",null),this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new v.Z("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle=(0,S.hw)(this.sharedSymbolResourcesOwnerHandle),this.propertiesPool=(0,S.SC)(this.propertiesPool),this.pendingUpdatesPool=null,this.symbolConversionCache.clear(),this.objectIdInvisibleSet.clear(),this._spatialIndex=(0,S.SC)(this._spatialIndex),this._set("featureStore",(0,S.SC)(this.featureStore))}},{key:"clear",value:function(){var e,t;null!==(e=this.objectStates)&&void 0!==e&&e.allGraphicsDeleted(),(0,S.pC)(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((function(e){return e.destroy()})),null!==(t=this._spatialIndex)&&void 0!==t&&t.clear(),this.graphics3DGraphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this.symbols.forEach(S.SC),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol.clear(),this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.pendingAdds=0,this.pendingRemoves=0,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.featureStore.events.emit("changed")}},{key:"_initializeStage",value:function(e,t){var i=this;this.stage=e._stage,this.stageLayer=new qe.F({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t),this.stage.add(this.stageLayer);var r=this.stageLayer.events;r.on("objectTransformation",(function(e){return i.notifyGraphicGeometryChanged(e.metadata.graphicUid)})),r.on("visibilityChanged",(function(e){return i.notifyGraphicVisibilityChanged(e.metadata.graphicUid)})),r.on("objectGeometryAdded",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)})),r.on("objectGeometryRemoved",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)})),r.on("vertexAttrsUpdated",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)}))}},{key:"notifyGraphicGeometryChanged",value:function(e){if(!(0,S.Wi)(this.graphicStateTracking)&&!(0,S.Wi)(e)){var t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicGeometry(t)}}},{key:"notifyGraphicVisibilityChanged",value:function(e){if(!(0,S.Wi)(this.graphicStateTracking)&&!(0,S.Wi)(e)){var t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicVisibility(t)}}},{key:"_updateLayerVisibility",value:function(){var e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this.numberOfGraphics>e*at,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}},{key:"_updateStageLayerVisibility",value:function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}},{key:"getGraphics3DGraphicById",value:function(e){return this.graphics3DGraphics.get(e)}},{key:"getGraphics3DGraphicByObjectId",value:function(e){var t;return null!==(t=this.owner.layer)&&void 0!==t&&t.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}},{key:"_getGraphicObjectID",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.owner.layer&&this.owner.layer.objectIdField;return(0,M.MS)(e,t)}},{key:"graphics3DGraphicsByObjectID",get:function(){var e=this,t=this.owner.layer&&this.owner.layer.objectIdField;if(!t)return null;var i=new Map;return this.graphics3DGraphics.forEach((function(r){if(r){var n=r.graphic,a=e._getGraphicObjectID(n,t);(0,S.pC)(a)&&i.set(a,r)}})),i}},{key:"labelsEnabled",get:function(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())}},{key:"updateLabelingInfo",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var i,r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.deconflictor&&this.deconflictor.labelingInfoChange(t),r=this.labeler&&this.labeler.labelingInfoChange(t),e.next=3,(0,w.as)([i,r]);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateVisibilityInfo",value:function(){this.deconflictor&&this.deconflictor.labelingInfoChange(),this.labeler&&this.labeler.visibilityInfoChange()}},{key:"symbolUpdateType",get:function(){var e=this;if(this.pendingUpdates.size>0)return"unknown";var t=0,i=0;return(0,_.oE)(this.symbols,(function(r,n){if((0,S.pC)(r)){var a=r.getFastUpdateStatus();if(a.loading>0)return!0;e.graphicsBySymbol.has(n)&&(i+=a.fast,t+=a.slow)}return!1}))?"unknown":i>=0&&0===t?"fast":t>=0&&0===i?"slow":"mixed"}},{key:"runTask",value:function(e){this._frameTask.processQueue(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining")}},{key:"setObjectIdVisibility",value:function(e,t){t?this.objectIdInvisibleSet.delete(e):this.objectIdInvisibleSet.add(e);var i=this._findGraphics3DGraphicByObjectId(e);(0,S.pC)(i)&&this._updateUserVisibility(i)}},{key:"_findGraphics3DGraphicByObjectId",value:function(e){var t=this;return(0,_.fQ)(this.graphics3DGraphics,(function(i){return t._getGraphicObjectID(i.graphic)===e}))}},{key:"_updateUserVisibility",value:function(e){if((0,S.Wi)(e))return!1;var t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&((0,S.Wi)(i)||!this.objectIdInvisibleSet.has(i));return e.setVisibilityFlag(ie.P.USER_SETTING,r,ie.E.GRAPHIC)}},{key:"_whenGraphics3DGraphic",value:function(e){var t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);var i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;var r=(0,w.dD)();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise}},{key:"_boundsForGraphics3DGraphic",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i){var r,n,s,o,l,h,c,u,d,p;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._viewSpatialReference,n=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,o=function(e,t,i){return(0,Z.CM)(e,n,t,e,r,t,i)},l=function(e,t,i){return(0,Z.CM)(e,s,t,e,r,t,i)},h=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:(0,S.pC)(i)&&i.useViewElevation,minDemResolution:(0,S.pC)(i)&&i.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,e.next=8,t.getProjectedBoundingBox(o,l,h,(0,S.U2)(i,"signal"));case 8:if(c=e.sent){e.next=11;break}return e.abrupt("return",null);case 11:return u=c.boundingBox,c.requiresDrapedElevation&&(d=this.symbolCreationContext.elevationProvider)&&((0,A.be)(u,et),p=(0,S.Pt)(d.getElevation(et[0],et[1],0,r,"ground"),0),u[2]=Math.min(u[2],p),u[5]=Math.max(u[5],p)),e.abrupt("return",{boundingBox:u,screenSpaceObjects:c.screenSpaceObjects});case 14:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"whenGraphicBounds",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i){var r,n,s,o=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,G.N1)((function(){var e;return null===(e=o.owner)||void 0===e?void 0:e.loadedGraphics}));case 2:if(r=this.owner.layer&&this.owner.layer.objectIdField,n=this.owner.loadedGraphics.find((function(e){return e===t||r&&e.attributes&&t.attributes&&e.attributes[r]===t.attributes[r]})),n){e.next=5;break}throw new v.Z("internal:graphic-not-part-of-view","Graphic is not part of this view");case 5:return e.next=7,this._whenGraphics3DGraphic(n);case 7:return s=e.sent,e.abrupt("return",this._boundsForGraphics3DGraphic(s,i));case 9:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"computeAttachmentOrigin",value:function(e,t){var i=this.graphics3DGraphics.get(e.uid);if(!i)return null;var r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;(0,D.s)(st,0,0,0);var a=0;if(r.render.num>0){if(!(0,Z.SH)(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,ot,t))return null;(0,D.a)(st,st,ot),a++}if(r.draped.num>0){var s=(0,n.Z)(r.draped.origin,2),o=s[0],l=s[1],h=(0,S.Pt)(this.viewElevationProvider.getElevation(o,l,"ground"),0);if((0,D.s)(ot,o,l,h),!(0,Z.SH)(ot,this.viewElevationProvider.spatialReference,ot,t))return null;(0,D.a)(st,st,ot),a++}return a>1&&(0,D.g)(st,st,1/a),new Je.Z({x:st[0],y:st[1],z:st[2],spatialReference:t})}},{key:"getSymbolLayerSize",value:function(e,t){var i=this.symbols.get(e.id);if((0,S.Wi)(i))throw new v.Z("internal:symbol-not-part-of-view","Symbol is not part of this view");var r=e.symbolLayers.indexOf(t);if(-1===r)throw new v.Z("internal:missing-symbol-layer","Symbol layer is not in symbol");var n=i.getSymbolLayerSize(r);if(null==n)throw new v.Z("internal:missing-size","Symbol layer has no valid size");return n}},{key:"_graphicsCollectionChanged",value:function(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}},{key:"graphicUpdateHandler",value:function(e){var t=e.graphic.uid,i=this.graphics3DGraphics.get(t);if(!(0,S.Wi)(i)||!(0,S.Wi)(this.graphicsWithoutSymbol.get(t)))switch(e.property){case"visible":this._graphicUpdateVisibleHandler(i);break;case"geometry":this._graphicUpdateGeometryHandler(i,e);break;case"symbol":this._graphicUpdateSymbolHandler(i,e);break;case"attributes":break;case"transform":this._graphicUpdateTransformHandler(i,e)}}},{key:"_graphicUpdateGeometryHandler",value:function(e,t){var i=t.graphic.geometry;if((0,S.Wi)(i))this._recreateGraphic(t.graphic);else if((0,S.Wi)(e)){var r=t.graphic.symbol&&t.graphic.symbol.id;if(r){var n=this.symbols.get(r);if((0,S.pC)(n)&&n.loadStatus===xe.P.LOADING)return}this._recreateGraphic(t.graphic)}else{var a=e.graphics3DSymbol;!(0,S.Wi)(t.newValue)&&a.updateGeometry(e,t.newValue)||this._recreateGraphic(e.graphic),this._expandComputedExtent(i)}}},{key:"_graphicUpdateSymbolHandler",value:function(e,t){var i=t.graphic,r=(0,S.pC)(e)?e.graphics3DSymbol:(0,S.pC)(t.oldValue)?this.symbols.get(t.oldValue.id):null;if((0,S.Wi)(r)||(0,S.Wi)(t.newValue))this._recreateGraphic(i);else{var n=r.symbol,a=this._getConvertedSymbol(t.newValue);if((0,S.pC)(a)&&(a.type!==n.type||"web-style"===a.type)||"web-style"===n.type)this._recreateGraphic(i);else{var s=this.graphicsBySymbol.get(n.id);if(s&&1!==s.size)this._recreateGraphic(i);else{var l=(0,P.Hg)(n,a);if((0,S.Wi)(l))this._updateSymbolMapping(n.id,a);else{var h={diff:l,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(h),(0,P.xb)(h.diff)){var c=this._getRenderingInfo(i);if((0,S.Wi)(c))this._recreateGraphic(i);else{var u,d=r.extentPadding,p=(0,o.Z)(h.symbolStatePatches);try{for(p.s();!(u=p.n()).done;){(0,u.value)()}}catch(g){p.e(g)}finally{p.f()}if(d!==r.extentPadding&&this._recomputeExtentPadding(),(0,S.pC)(e)){var y,f=(0,o.Z)(h.graphics3DGraphicPatches);try{for(f.s();!(y=f.n()).done;){(0,y.value)(e,c)}}catch(g){f.e(g)}finally{f.f()}}this._updateSymbolMapping(n.id,a)}}else this._recreateGraphic(i)}}}}}},{key:"_graphicUpdateVisibleHandler",value:function(e){this._updateUserVisibility(e)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}},{key:"_graphicUpdateTransformHandler",value:function(e,t){}},{key:"recreateGraphics",value:function(e){this.suspendSymbolCleanup=!0,this.remove(e),this.add(e),this.suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===ze.jq.SYNC&&this._cleanupSymbols()}},{key:"_recreateGraphic",value:function(e){this.recreateGraphics([e])}},{key:"_beginGraphicUpdate",value:function(e){var t=this.graphicsUpdateId;return this.graphicsUpdateId++,this.graphicsWaitingForSymbol.set(e.uid,t),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating"),t}},{key:"_endGraphicUpdate",value:function(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))}},{key:"_recomputeExtentPadding",value:function(){var e=0;this.symbols.forEach((function(t){(0,S.pC)(t)&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)}},{key:"_expandComputedExtent",value:function(e){var t=tt,i=e.spatialReference;(0,M.FS)(e,t);var r=this._viewSpatialReference,n=Ae.tmpVec;if(i.equals(r)||(0,Z.Rg)(t[0],t[1],0,i,n,r)&&(t[0]=n[0],t[1]=n[1],(0,Z.Rg)(t[3],t[4],0,i,n,r),t[3]=n[0],t[4]=n[1]),isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])){var a=this.computedExtent,s=null,o=isFinite(t[2])&&isFinite(t[5]),l=o&&(!a||null==a.zmin||t[2]<a.zmin),h=o&&(!a||null==a.zmax||t[5]>a.zmax);a?(t[0]<a.xmin||t[1]<a.ymin||t[3]>a.xmax||t[4]>a.ymax||l||h)&&((s=this.propertiesPool.get("computedExtent")).xmin=Math.min(t[0],a.xmin),s.ymin=Math.min(t[1],a.ymin),s.xmax=Math.max(t[3],a.xmax),s.ymax=Math.max(t[4],a.ymax),s.spatialReference=r):((s=this.propertiesPool.get("computedExtent")).xmin=t[0],s.ymin=t[1],s.xmax=t[3],s.ymax=t[4],s.spatialReference=r),s&&(l&&(s.zmin=t[2]),h&&(s.zmax=t[5]),this._set("computedExtent",s))}}},{key:"_abortElevationInfoChange",value:function(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)}},{key:"elevationInfoChange",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t,i,r,n,s=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._abortElevationInfoChange(),r=new AbortController,this.elevationInfoChangeAbortController=r,n=(0,re.WI)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),e.next=6,(0,re.kr)(n,this._viewSpatialReference,it);case 6:this.symbolCreationContext.featureExpressionInfoContext=e.sent,(0,w.k_)(r),this.elevationInfoChangeAbortController=null,null!==(t=this.labeler)&&void 0!==t&&t.elevationInfoChange(),this.forEachGraphics3DSymbol((function(e,t,i){e.globalPropertyChanged("elevationInfo",t)?t.forEach((function(e){var t,i=e.graphic,r=e.labelGraphics,n=(0,o.Z)(r);try{for(n.s();!(t=n.n()).done;){var a=t.value;a.graphics3DSymbolLayer.updateGraphicElevationContext(i,a)}}catch(s){n.e(s)}finally{n.f()}})):s._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),null===(i=this.elevationAlignment)||void 0===i||i.elevationInfoChange();case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"updateStageLayerElevationProvider",value:function(){this.stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this.numberOfGraphicsProvidingElevation>0&&(this.stageLayerElevationProvider=new Ze({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))}},{key:"_clearSymbolsAndGraphics",value:function(){var e,t,i,r;this.clear(),(0,S.pC)(this.filterVisibility)&&this.filterVisibility.clear(),null!==(e=this.labeler)&&void 0!==e&&e.reset(),null!==(t=this.deconflictor)&&void 0!==t&&t.clear(),null!==(i=this.elevationAlignment)&&void 0!==i&&i.clear(),null!==(r=this.stageLayer)&&void 0!==r&&r.invalidateSpatialQueryAccelerator(),this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)}},{key:"startCreateGraphics",value:function(){this._startCreateGraphics=!0,this.recreateAllGraphics()}},{key:"recreateAllGraphics",value:function(){this._recreateAllGraphics(!1)}},{key:"recreateAllGraphicsAndSymbols",value:function(){this._recreateAllGraphics(!0)}},{key:"_recreateAllGraphics",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._startCreateGraphics){var t=this.owner,i=t.loadedGraphics,r=t.view,n=r.basemapTerrain.tilingScheme&&i&&i.length?i.toArray():null;!e&&n||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),n&&(e?this.add(n):this.recreateGraphics(n))}}},{key:"_recreateSymbol",value:function(e){var t=this,i=this.graphicsBySymbol.get(e),r=[];i&&(i.forEach((function(e,i){var n,a=e.usedMemory;t._conditionalRemove(e,i),null!==(n=t._spatialIndex)&&void 0!==n&&n.remove(e),r.push(e.graphic),e.destroy(),t._removeGraphics3DGraphic(i,a),t._updateLayerVisibility(),t.featureStore.events.emit("changed")})),this.graphicsBySymbol.set(e,new Map));var n=this.symbols.get(e);(0,S.SC)(n),this.symbols.delete(e),this.add(r)}},{key:"_recreateGraphicsForSymbol",value:function(e){var t=this.graphicsBySymbol.get(e);if(t){var i=[];t.forEach((function(e){return i.push(e.graphic)})),this.recreateGraphics(i)}}},{key:"_conditionalRemove",value:function(e,t){var i,r,n;this.graphicsDrapedUids.delete(t),null!==(i=this.objectStates)&&void 0!==i&&i.removeGraphic(e),null!==(r=this.labeler)&&void 0!==r&&r.removeGraphic(e),null!==(n=this.deconflictor)&&void 0!==n&&n.removeGraphic(e),(0,S.pC)(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(e)}},{key:"add",value:function(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(e)===ze.jq.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):it.error("#add()","Cannot add graphics before terrain surface has been initialized"))}},{key:"_updatePolicyForGraphics",value:function(e){if(this.effectiveUpdatePolicy===ze.jq.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType)){var t,i=(0,o.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;if((0,S.pC)(r.geometry)&&"mesh"===r.geometry.type&&!r.geometry.loaded)return ze.jq.ASYNC}}catch(n){i.e(n)}finally{i.f()}}return this.effectiveUpdatePolicy}},{key:"_addImmediate",value:function(e){this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;var t,i=(0,o.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._addGraphic(r,this._getRenderingInfo(r,it),ze.jq.SYNC)}}catch(n){i.e(n)}finally{i.f()}this._cleanupSymbols(),this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}},{key:"_addDelayed",value:function(e){var t,i=(0,o.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.uid,a=this.pendingUpdates.get(n);a?a.add?a.state!==Le.NEW&&a.abortController.abort():this.pendingAdds++:(a=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(n,a)),a.add=r}}catch(s){i.e(s)}finally{i.f()}this.notifyChange("running"),this.notifyChange("updatingRemaining")}},{key:"remove",value:function(e){this.effectiveUpdatePolicy===ze.jq.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")}},{key:"_removeImmediate",value:function(e){var t,i=(0,o.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._removeGraphic(r)}}catch(n){i.e(n)}finally{i.f()}this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}},{key:"_removeDelayed",value:function(e){var t,i=(0,o.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.uid,a=this.pendingUpdates.get(n);if(a)a.add&&(a.remove?a.add=null:this.pendingUpdates.delete(n),a.state===Le.LOADING&&a.abortController.abort(),this.pendingAdds--);else{var s=this.pendingUpdatesPool.pushNew();s.remove=r,this.pendingUpdates.set(n,s),this.pendingRemoves++}}}catch(l){i.e(l)}finally{i.f()}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining")}},{key:"_finishPendingUpdates",value:function(){this.pendingUpdatesPool.clear(),this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&it.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0}},{key:"_applyPendingUpdates",value:function(e){var t;if(this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,0===this.pendingUpdates.size&&null!==(t=this._spatialIndex)&&void 0!==t&&t.updating)this._spatialIndex.update();else{var i,r=(0,o.Z)(this.pendingUpdates);try{for(r.s();!(i=r.n()).done;){var a=(0,n.Z)(i.value,2),s=a[0],l=a[1];if(e.done)break;l.add&&l.state===Le.NEW&&this._processPendingUpdateNew(l);var h=this.effectiveUpdatePolicy;if(!l.remove||l.add&&l.state!==Le.READY||(this.pendingRemoves--,e.madeProgress(),this._removeGraphic(l.remove),l.remove=null,h=ze.jq.SYNC),l.add)switch(l.state){case Le.READY:this._addGraphic(l.add,l.renderingInfo,h),l.add=null,this.pendingAdds--,e.madeProgress();break;case Le.REJECTED:l.add=null,this.pendingAdds--;case Le.LOADING:}null==l.remove&&null==l.add&&this.pendingUpdates.delete(s)}}catch(c){r.e(c)}finally{r.f()}0===this.pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}}},{key:"_processPendingUpdateNew",value:function(e){if(e.add){var t=e.add.geometry;(0,S.pC)(t)&&"mesh"===t.type&&!t.loaded?this._processPendingUpdateNewMesh(e,t):this._processPendingUpdateNewRenderingInfo(e)}else e.state=Le.READY}},{key:"_processPendingUpdateNewMesh",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i){var r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.state=Le.LOADING,t.abortController=new AbortController,r=t.abortController.signal,e.prev=2,e.next=5,i.load({signal:r});case 5:e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(2),e.abrupt("return",this._processPendingUpdateNewError(t,e.t0));case 10:t.abortController=null,this._processPendingUpdateNewRenderingInfo(t);case 11:case"end":return e.stop()}}),e,this,[[2,7]])})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_processPendingUpdateNewError",value:function(e,t){e.abortController=null,(0,w.D_)(t)?e.state=Le.NEW:e.state=Le.REJECTED}},{key:"_processPendingUpdateNewRenderingInfo",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,S.Wi)(this.layer.renderer)&&"dictionary"===this.layer.renderer.type){e.next=2;break}return e.abrupt("return",(t.renderingInfo=this._getRenderingInfo(t.add,it),void(t.state=Le.READY)));case 2:return t.state=Le.LOADING,t.abortController=new AbortController,i=null,e.prev=4,e.next=7,this._getRenderingInfoAsync(t.add,{signal:t.abortController.signal});case 7:i=e.sent,e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(4),e.abrupt("return",(t.abortController=null,void((0,w.D_)(e.t0)?t.state=Le.NEW:t.state=Le.REJECTED)));case 13:(0,S.Wi)(i)||(0,S.Wi)(i.symbol)?(it&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,it.warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),t.renderingInfo=null):t.renderingInfo=i,t.state=Le.READY;case 14:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_addGraphic",value:function(e,t,i){var r=this;if(this.graphicsWithoutSymbol.set(e.uid,e),!(0,S.Wi)(t)&&!(0,S.Wi)(t.symbol)&&(0,M.S6)(e)){var n=t.symbol,a=this.getOrCreateGraphics3DSymbol(n,t.renderer);if(!(0,S.Wi)(a)){this._expandComputedExtent(e.geometry);var s=this._beginGraphicUpdate(e),o=new ce.Z(e,t,this.layer),l=!1,h=function(e){e===a.symbol.id&&(l=!0)};this._whenSymbolRemoved.push(h);var c=function(){if(--r._loadingSymbols,!r.destroyed){if(r._whenSymbolRemoved.removeUnordered(h),r.graphicsWaitingForSymbol.get(e.uid)!==s||l||a.destroyed||r.graphicSymbolSupported&&e.symbol&&e.symbol.id!==a.symbol.id)--a.referenced,r._cleanupSymbols();else{var t=r._createGraphics3DGraphic(a,o);r._spatialIndex&&(0,S.pC)(t)&&r._spatialIndex.add(t),--a.referenced,r._endGraphicUpdate(e)}r.featureStore.events.emit("changed"),r.labeler&&r.owner.view.labeler.setDirty()}},u=function(t){--r._loadingSymbols,r.destroyed||(r._whenSymbolRemoved.removeUnordered(h),l||((0,w.D_)(t)?r.add([e]):a.destroyed||r._endGraphicUpdate(e)))};++this._loadingSymbols,i===ze.jq.ASYNC?a.load((function(){return r._frameTask.schedule(c)}),(function(e){return r._frameTask.schedule((function(){return u(e)}))})):a.load(c,u)}}}},{key:"_removeGraphic",value:function(e){var t=e.uid,i=this.graphics3DGraphics.get(t);if(i){var r;i.graphics3DSymbol.onRemoveGraphic(i);var n=i.usedMemory,a=i.isElevationSource;this._conditionalRemove(i,t),null===(r=this._spatialIndex)||void 0===r||r.remove(i);var s=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(s).delete(t),this.graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,n,a),i.destroy(),this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(t),this.graphicsWaitingForSymbol.delete(t),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))}},{key:"_hasLabelingContext",value:function(e){if(e instanceof Qe.Z||e instanceof Ke.Z){var t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((function(t){return t.symbol===e}))}return!1}},{key:"_hasValidSymbolCreationContext",value:function(e){return!(e instanceof Qe.Z&&!this._hasLabelingContext(e))||(it.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}},{key:"_getRenderingInfo",value:function(e,t){var i=e.geometry;if((0,S.Wi)(i))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!(0,Z.Up)(i.spatialReference,this._viewSpatialReference))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has incompatible spatial reference and will not render"))),null;if(!this.graphicSymbolSupported&&(0,S.pC)(e.symbol))return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;var r,n=this.rendererHasGeometryOperations?(0,V.mW)(e,this.layer):e;return r=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||(0,S.pC)(this.currentRenderer))?this.owner.getRenderingInfo(n,this.currentRenderer,(0,S.Wg)(this.arcadeOnDemand)):{symbol:n.symbol||$(n.geometry)},(0,S.Wi)(r)||(0,S.Wi)(r.symbol)?(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),null):r}},{key:"_getRenderingInfoAsync",value:function(e,t){var i=e.geometry;if((0,S.Wi)(i))return it&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,it.warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!this.graphicSymbolSupported&&(0,S.pC)(e.symbol))return it&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,it.warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;var r=this.rendererHasGeometryOperations?(0,V.mW)(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,(0,S.Wg)(this.currentRenderer),(0,S.Wg)(this.arcadeOnDemand),t)}},{key:"_createGraphics3DSymbol",value:function(e,t){var i=this;if(!this._hasValidSymbolCreationContext(e))return null;var r,n=this._getConvertedSymbol(e);if(!n)return null;if((0,S.pC)(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){var a=(0,ee.q)(t.backgroundFillSymbol,{ignoreDrivers:!0});(0,S.pC)(a.symbol)&&"web-style"!==a.symbol.type&&"cim"!==a.symbol.type&&(r=a.symbol.symbolLayers)}var s=me(n,this.symbolCreationContext,r);return s.load((function(){var e=s.extentPadding;e>i.extentPadding&&i._set("extentPadding",e),i.notifyChange("averageSymbolComplexity")}),(function(){})),s}},{key:"getOrCreateGraphics3DSymbol",value:function(e,t){var i=this,r=this.symbols.get(e.id);return void 0===r&&(r=e instanceof $e.Z?new be.Z(e,(function(e){return i._frameTask.schedule(e)}),(function(e){return i._createGraphics3DSymbol(e,t)})):this._createGraphics3DSymbol(e,t),this.symbols.set(e.id,r)),(0,S.pC)(r)&&++r.referenced,r}},{key:"trackGraphicState",value:function(e){return(0,S.Wi)(this.graphicStateTracking)&&(this.graphicStateTracking=new Ce(this)),this.graphicStateTracking.add(e)}},{key:"_addGraphics3DGraphic",value:function(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this.numberOfGraphics++,e.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}},{key:"_removeGraphics3DGraphic",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._usedMemory-=t,this.graphics3DGraphics.delete(e),this.numberOfGraphics--,i&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}},{key:"_createGraphics3DGraphic",value:function(e,t){var i,r,n,a=t.graphic;if(this.graphicsWithoutSymbol.delete(a.uid),!this.symbols.has(e.symbol.id))return this.add([a]),null;if(this.graphics3DGraphics.has(a.uid))return null;var s=e.createGraphics3DGraphic(t);if((0,S.Wi)(s))return null;this._addGraphics3DGraphic(s);var o=e.symbol.id;this.graphicsBySymbol.has(o)||this.graphicsBySymbol.set(o,new Map),this.graphicsBySymbol.get(o).set(a.uid,s),s.isDraped&&this.graphicsDrapedUids.add(a.uid),s.centroid=null,(0,S.pC)(a.geometry)&&"point"!==a.geometry.type&&(s.centroid=(0,_e.zE)(a.geometry,this._viewSpatialReference)),this._updateUserVisibility(s),(0,S.pC)(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(s),(0,S.pC)(this.filterVisibility)&&this.filterVisibility.updateVisibility(s),null!==(i=this.deconflictor)&&void 0!==i&&i.addGraphic(s),null!==(r=this.labeler)&&void 0!==r&&r.addGraphic(s),null!==(n=this.objectStates)&&void 0!==n&&n.addGraphic(s),this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,s),s.initialize(this.stage,this.stageLayer,this.owner),(0,S.pC)(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(s);var l=this.whenGraphics3DGraphicRequests[a.uid];return l&&(delete this.whenGraphics3DGraphicRequests[a.uid],l.resolve(s)),s}},{key:"_abortRendererChange",value:function(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)}},{key:"rendererChange",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var i,r,n,s,o=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._abortRendererChange(),t===this.currentRenderer){e.next=36;break}if(this._validateRenderer(t),(0,S.Wi)(t)&&this._currentRendererChange(null,!1),!(0,W.e)(t)){e.next=35;break}if(!(0,S.pC)(t)||!t.arcadeRequired){e.next=24;break}return i=new AbortController,this.rendererChangeAbortController=i,e.next=7,this._ensureArcade();case 7:if(r=e.sent,n=r.arcadeUtils,(0,w.k_)(i),e.t0=n.hasGeometryOperations(t),!e.t0){e.next=15;break}return e.next=14,n.enableGeometryOperations();case 14:(0,w.k_)(i);case 15:if(this.effectiveUpdatePolicy!==ze.jq.ASYNC){e.next=20;break}return e.next=18,this._frameTask.schedule((function(){return o._currentRendererChange(t,!0)}),i.signal);case 18:e.next=21;break;case 20:this._currentRendererChange(t,!0);case 21:this.rendererChangeAbortController=null,e.next=33;break;case 24:if(this.effectiveUpdatePolicy!==ze.jq.ASYNC){e.next=32;break}return s=new AbortController,this.rendererChangeAbortController=s,e.next=29,this._frameTask.schedule((function(){return o._currentRendererChange(t,!1)}),s.signal);case 29:this.rendererChangeAbortController=null,e.next=33;break;case 32:this._currentRendererChange(t,!1);case 33:e.next=36;break;case 35:this._currentRendererChange(t,!1);case 36:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_ensureArcade",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,S.Wi)(this.arcadeOnDemand)){e.next=7;break}return e.next=3,(0,B.LC)();case 3:this.arcadeOnDemand=e.sent,e.t0=this.arcadeOnDemand,e.next=8;break;case 7:e.t0=this.arcadeOnDemand;case 8:return e.abrupt("return",e.t0);case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_currentRendererChange",value:function(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=(0,S.Wg)(this.arcadeOnDemand);var i=this.symbolCreationContext.renderer;if(e!==i){if(this.symbolConversionCache.clear(),(0,S.Wi)(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();var r=(0,P.Hg)(i,e);this._updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,(0,S.Wi)(r)||("complete"===r.type?this.recreateAllGraphicsAndSymbols():"partial"===r.type&&(this._applyRendererDiff(r,e,i)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}}},{key:"_diffHasSymbolChange",value:function(e){for(var t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}},{key:"_applySymbolSetDiff",value:function(e,t,i){var r=this;e=e||[],t=t||[];var n,a=[],s=(0,o.Z)(t);try{var l=function(){var t=n.value,s=r.graphicsBySymbol.get(t.id);s&&s.forEach((function(n,o){var l=n.graphic,h=r.layer instanceof U.Z?r.layer:null,c=(0,S.Wg)(r.arcadeOnDemand);if(t!==i.defaultSymbol||i.getSymbol((0,V.mW)(l,h),{arcade:c})!==i.defaultSymbol){var u=n.usedMemory;e.length||i.defaultSymbol?a.push(l):r.graphicsWithoutSymbol.set(o,l);var d=r.graphics3DGraphics.get(o);r._conditionalRemove(d,o),n.destroy(),s.delete(o),r._removeGraphics3DGraphic(o,u),r._updateLayerVisibility()}})),r._whenSymbolRemoved.forAll((function(e){return e(t.id)}))};for(s.s();!(n=s.n()).done;)l()}catch(h){s.e(h)}finally{s.f()}(e.length||a.length)&&(this.graphicsWithoutSymbol.forEach((function(e){return a.push(e)})),this.graphicsWithoutSymbol.clear(),this.add(a)),this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}},{key:"_applyUniqueValueRendererDiff",value:function(e,t,i){var r=e.diff.defaultSymbol,n=e.diff.uniqueValueInfos;if(r||n){var a=n?n.added.map((function(e){return e.symbol})):[],s=n?n.removed.map((function(e){return e.symbol})):[];if(n)for(var o=0;o<n.changed.length;o++)a.push(n.changed[o].newValue.symbol),s.push(n.changed[o].oldValue.symbol);return r?(i.defaultSymbol&&s.push(i.defaultSymbol),t.defaultSymbol&&a.push(t.defaultSymbol)):i.defaultSymbol&&a.length&&s.push(t.defaultSymbol),this._applySymbolSetDiff(a,s,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}},{key:"_calculateUnchangedSymbolMapping",value:function(e,t,i){if("unique-value"!==(null===t||void 0===t?void 0:t.type)||"unique-value"!==(null===i||void 0===i?void 0:i.type)||(0,S.pC)(e)&&"partial"!==e.type)return[];var r,n=function(e){return(0,S.pC)(e)?e.id:null},a=e&&e.diff,s=a&&a.defaultSymbol,l=a&&a.uniqueValueInfos;if(l)r=l.unchanged.map((function(e){return{oldId:n(e.oldValue.symbol),newId:n(e.newValue.symbol)}}));else{r=[];var h,c=(0,o.Z)(i.uniqueValueInfos);try{var u=function(){var e=h.value,i=n(e.symbol),a=t.uniqueValueInfos.find((function(t){return t.value===e.value}));a&&i!==n(a.symbol)&&r.push({oldId:i,newId:n(a.symbol)})};for(c.s();!(h=c.n()).done;)u()}catch(d){c.e(d)}finally{c.f()}}return!s&&i.defaultSymbol&&r.push({oldId:n(i.defaultSymbol),newId:n(t.defaultSymbol)}),r}},{key:"_updateSymbolMapping",value:function(e,t){var i=(0,S.pC)(t)&&t?"string"==typeof t?t:t.id:null;if(e&&e!==i){var r=this.graphicsBySymbol.get(e);this.graphicsBySymbol.delete(e),void 0!==r&&this.graphicsBySymbol.set(i,r);var n=this.symbols.get(e);if(void 0!==n&&(this.symbols.delete(e),this.symbols.set(i,n),(0,S.pC)(n))){var a="string"==typeof t?null:t;(0,S.pC)(a)?n.symbol=a:n.symbol.id=i}}}},{key:"_updateUnchangedSymbolMappings",value:function(e,t,i){var r,n=this._calculateUnchangedSymbolMapping(e,t,i),a=(0,o.Z)(n);try{for(a.s();!(r=a.n()).done;){var s=r.value,l=s.oldId,h=s.newId;this._updateSymbolMapping(l,h)}}catch(c){a.e(c)}finally{a.f()}}},{key:"_applyRendererDiff",value:function(e,t,i){if(this._diffHasSymbolChange(e))return!1;if(t instanceof y.Z&&i instanceof y.Z&&this._applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;var r,a=(0,o.Z)(this.graphicsBySymbol);try{for(a.s();!(r=a.n()).done;){var s=(0,n.Z)(r.value,1)[0],l=this.symbols.get(s);if((0,S.pC)(l))switch(l.applyRendererDiff(e,t)){case Se.W.Recreate_Symbol:this._recreateSymbol(s);break;case Se.W.Recreate_Graphics:this._recreateGraphicsForSymbol(s);case Se.W.Fast_Update:}}}catch(h){a.e(h)}finally{a.f()}return!0}},{key:"opacityChange",value:function(){this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("opacity",t)})),this._updateStageLayerVisibility()}},{key:"_slicePlaneEnabledChange",value:function(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("slicePlaneEnabled",t)})),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())}},{key:"_physicalBasedRenderingChange",value:function(e){var t=this;e!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((function(e,i,r){e.globalPropertyChanged("physicalBasedRenderingEnabled",i)||t._recreateSymbol(r)})))}},{key:"_pixelRatioChange",value:function(){var e=this;this.forEachGraphics3DSymbol((function(t,i,r){t.globalPropertyChanged("pixelRatio",i)||e._recreateSymbol(r)}))}},{key:"_signalUpdatingDuringAsyncLoadedGraphicsChange",value:function(){var e=this;this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,k.Os)((function(){e._updatingPendingLoadedGraphicsChange=null}))}},{key:"setClippingExtent",value:function(e,t){var i=this.symbolCreationContext.clippingExtent,r=(0,L.Ue)();return(0,Te.G)(e,r,t)?this.symbolCreationContext.clippingExtent=(0,A.JR)((0,A.Ue)(),r):this.symbolCreationContext.clippingExtent=null,!(0,A.fS)(this.symbolCreationContext.clippingExtent,i)}},{key:"modifyGraphics3DGraphicVisibilities",value:function(e){var t=!1;this.graphics3DGraphics.forEach((function(i){e(i)&&(t=!0)})),t&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}},{key:"forEachGraphics3DSymbol",value:function(e){var t,i=(0,o.Z)(this.symbols);try{for(i.s();!(t=i.n()).done;){var r=(0,n.Z)(t.value,2),a=r[0],s=r[1];if((0,S.Wi)(s))return;e(s,this.graphicsBySymbol.get(a)||lt,a)}}catch(l){i.e(l)}finally{i.f()}}},{key:"updateAllGraphicsVisibility",value:function(){var e=this;(0,S.pC)(this.filterVisibility)&&(this.filterVisibility.dirty=!0),this.modifyGraphics3DGraphicVisibilities((function(t){var i=e._updateUserVisibility(t),r=(0,S.pC)(e.scaleVisibility)&&e.scaleVisibility.updateVisibility(t);return i||r}))}},{key:"_hideAllGraphics",value:function(){this.modifyGraphics3DGraphicVisibilities((function(e){return e.setVisibilityFlag(ie.P.USER_SETTING,!1,ie.E.GRAPHIC)}))}},{key:"_validateRenderer",value:function(e){var t=(0,W.s)(e);if(t){var i="Renderer for layer '".concat(this.layer.title?"".concat(this.layer.title,", "):"",", id:").concat(this.layer.id,"' is not supported in a SceneView");it.warn(i,t.message)}}},{key:"_volatileGraphicsUpdated",value:function(){var e;null!==(e=this.labeler)&&void 0!==e&&e.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")}},{key:"_cleanupSymbols",value:function(){var e=this;if(!(this.graphicsWaitingForSymbol.size>0||this.suspendSymbolCleanup)){var t=!1;this.symbols.forEach((function(i,r){if(!((0,S.Wi)(i)||i.referenced>0)){var n=e.graphicsBySymbol.get(r);n&&0!==n.size||(e.graphicsBySymbol.delete(r),e.symbols.delete(r),(0,S.SC)(i),t=!0)}})),t&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}}},{key:"test",get:function(){var e=this;return{snapshotInternals:function(){return{graphics:(0,r.Z)(e.graphics3DGraphics.keys()).sort(),symbols:(0,r.Z)(e.symbols.keys()).sort(),graphicsBySymbol:(0,r.Z)(e.graphicsBySymbol.keys()).sort().map((function(t){return{symbolId:t,graphics:(0,r.Z)(e.graphicsBySymbol.get(t).keys()).sort()}})),graphicsWithoutSymbol:(0,r.Z)(e.graphicsWithoutSymbol.keys()).sort(),graphicsDrapedUids:(0,r.Z)(e.graphicsDrapedUids).sort(),pendingUpdates:e.pendingUpdates}},symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:function(t){e.forcedUpdatePolicy=t}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}}}]),i}(f.Z);rt.tmpVec=(0,O.c)(),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"computedExtent",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"currentRenderer",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"rendererHasGeometryOperations",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"_frameTask",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"rendererChangeAbortController",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"elevationInfoChangeAbortController",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"setupAbortController",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"elevationAlignment",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"scaleVisibility",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"filterVisibility",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"_spatialIndex",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"extentPadding",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"featureStore",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"deconflictor",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"labeler",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"objectStates",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"_loadingSymbols",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"preferredUpdatePolicy",void 0),(0,p._)([(0,R.Cb)()],rt.prototype,"forcedUpdatePolicy",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"effectiveUpdatePolicy",null),(0,p._)([(0,R.Cb)({constructOnly:!0})],rt.prototype,"elevationFeatureExpressionEnabled",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],rt.prototype,"owner",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],rt.prototype,"layer",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],rt.prototype,"graphicSymbolSupported",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],rt.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"updating",null),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"running",null),(0,p._)([(0,R.Cb)({readOnly:!0})],rt.prototype,"suspendedOrOutsideOfView",null),(0,p._)([(0,R.Cb)({readOnly:!0,dependsOn:[]})],rt.prototype,"updatingRemaining",null),(0,p._)([(0,R.Cb)({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],rt.prototype,"displayFeatureLimit",null),(0,p._)([(0,R.Cb)({readOnly:!0,dependsOn:[]})],rt.prototype,"averageSymbolComplexity",null),(0,p._)([(0,R.Cb)({constructOnly:!0})],rt.prototype,"hasZ",void 0),(0,p._)([(0,R.Cb)({constructOnly:!0})],rt.prototype,"hasM",void 0),rt=Ae=(0,p._)([(0,I.j)("esri.views.3d.layers.graphics.Graphics3DCore")],rt),(Ue=Le||(Le={}))[Ue.NEW=0]="NEW",Ue[Ue.LOADING=1]="LOADING",Ue[Ue.READY=2]="READY",Ue[Ue.REJECTED=3]="REJECTED";var nt=function(){function e(){(0,l.Z)(this,e),this.add=null,this.renderingInfo=null,this.state=Le.NEW,this.remove=null}return(0,h.Z)(e,[{key:"clear",value:function(){this.add=null,this.renderingInfo=null,this.state=Le.NEW,this.abortController=null,this.remove=null}}]),e}(),at=10,st=(0,O.c)(),ot=(0,O.c)(),lt=new Map},59453:function(e,t,i){i.d(t,{Z:function(){return _}});var r=i(15671),n=i(43144),a=i(60136),s=i(29388),o=i(27366),l=i(85015),h=i(100),c=i(92026),u=i(49861),d=(i(63780),i(93169),i(25243),i(69912)),p=i(79803),y=i(65156),f=i(70446),g=i(69787),v=i(93463),m=function(e){(0,a.Z)(i,e);var t=(0,s.Z)(i);function i(){var e;return(0,r.Z)(this,i),(e=t.apply(this,arguments))._scaleRangeActive=!1,e.layerScaleRangeVisibilityQuery=!1,e.handles=new h.Z,e.graphicsCoreOwner=null,e.layer=null,e.queryGraphicUIDsInExtent=null,e.extent=null,e.graphicsCore=null,e.basemapTerrain=null,e.layerScaleEnabled=!0,e.suspended=!1,e.updating=!0,e}return(0,n.Z)(i,[{key:"setup",value:function(e,t,i,r,n){this.graphicsCoreOwner=e,this.layer=t,this.queryGraphicUIDsInExtent=i,this.graphicsCore=r,this.basemapTerrain=n,this.updateScaleRangeActive();var a=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add(a.registerTask(v.T8.SCALE_VISIBILITY,this))}},{key:"destroy",value:function(){this.handles.destroy(),this.handles=null,this.graphicsCoreOwner=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null}},{key:"_setDirty",value:function(){this.updating||this._set("updating",!0)}},{key:"setExtent",value:function(e){var t=this.graphicsCoreOwner.view.spatialReference,i=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===i)this.extent=e;else{var r=(0,y.Ue)();(0,p.dH)(e,t,r,i)?this.extent=r:this.extent=null}this._setDirty()}},{key:"scaleRangeActive",value:function(){return this._scaleRangeActive}},{key:"updateScaleRangeActive",value:function(){var e=this,t=this.layer,i=t.effectiveScaleRange,r=this.layerScaleEnabled&&b(i.minScale,i.maxScale);t.labelingInfo&&!r&&(r=t.labelingInfo.some((function(e){return e&&b(e.minScale,e.maxScale)})));var n=this._scaleRangeActive!==r;return this._scaleRangeActive=r,r&&!this.handles.has(C)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),C),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(function(){return e._setDirty()})),C)):!r&&this.handles.has(C)&&this.handles.remove(C),n}},{key:"running",get:function(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}},{key:"runTask",value:function(){var e=this,t=this.graphicsCoreOwner.view.basemapTerrain;if(this.extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(!this.layerScaleRangeVisibilityQuery){this.layerScaleRangeVisibilityQuery=!0;var i=this.layer.effectiveScaleRange;t.queryVisibleScaleRange(this.extent,i.minScale,i.maxScale,(function(t){return e._finishUpdate(t)}))}}else this._finishUpdate(!0)}},{key:"_finishUpdate",value:function(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._set("updating",!1)}},{key:"_visibleAtLayerScale",value:function(e){var t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||(0,g.rs)(e,t.minScale||0,t.maxScale||0)}},{key:"_visibleAtLabelScale",value:function(e,t){return(0,g.rs)(e,t.minScale||0,t.maxScale||0)}},{key:"_graphicScale",value:function(e){var t;return(0,c.pC)(e.centroid)?t=e.centroid:(0,c.pC)(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}},{key:"_graphicVisible",value:function(e){if(!this.layerScaleEnabled)return!0;var t=this._graphicScale(e);return this._visibleAtLayerScale(t)}},{key:"updateVisibility",value:function(e){if(this._scaleRangeActive){var t=this._graphicVisible(e);return e.setVisibilityFlag(f.P.SCALE_RANGE,t,f.E.GRAPHIC)}return!1}},{key:"updateGraphicLabelScaleVisibility",value:function(e){if(!this._scaleRangeActive)return!1;if(!e.labelGraphics||0===e.labelGraphics.length)return!1;var t=this._graphicScale(e),i=this._updateLabelScaleVisibility(e,t);return i&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),i}},{key:"_updateLabelScaleVisibility",value:function(e,t){if(!e.labelGraphics||0===e.labelGraphics.length)return!1;var i=e.labelGraphics[0]._labelClass;if(i&&null!=i.minScale&&null!=i.maxScale){var r=this._visibleAtLabelScale(t,i);if(e.setVisibilityFlag(f.P.SCALE_RANGE,r,f.E.LABEL))return!0}return!1}},{key:"_scaleUpdateHandler",value:function(e){var t=this;if(this._setDirty(),!this.graphicsCoreOwner.suspended){var i=e.extent,r=e.scale,n=this._visibleAtLayerScale(r),a=!1;this.queryGraphicUIDsInExtent(i,e.spatialReference,(function(e){var s=t.graphicsCore.getGraphics3DGraphicById(e);if(!(0,c.Wi)(s)){var o=s.centroid;(0,c.pC)(o)&&(i[0]>o.x||i[1]>o.y||i[2]<o.x||i[3]<o.y)||(s.setVisibilityFlag(f.P.SCALE_RANGE,n,f.E.GRAPHIC)&&(a=!0),t._updateLabelScaleVisibility(s,r)&&(a=!0))}})),a&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty())}}},{key:"layerMinMaxScaleChangeHandler",value:function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((function(e){return e.clearVisibilityFlag(f.P.SCALE_RANGE)})):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}}]),i}(l.Z);function b(e,t){return e>0||t>0}(0,o._)([(0,u.Cb)({constructOnly:!0})],m.prototype,"layerScaleEnabled",void 0),(0,o._)([(0,u.Cb)({readOnly:!0})],m.prototype,"suspended",void 0),(0,o._)([(0,u.Cb)({readOnly:!0})],m.prototype,"updating",void 0),m=(0,o._)([(0,d.j)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],m);var C="terrain-events",_=m}}]);
//# sourceMappingURL=8943.db0bc71c.chunk.js.map